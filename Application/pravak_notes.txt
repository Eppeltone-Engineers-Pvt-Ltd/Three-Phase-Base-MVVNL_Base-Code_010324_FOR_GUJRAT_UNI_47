////-------------------------------------------------------------------------------------
29/02/24
Made some changes in the storage of ctldata, the resetting of last saved values when the bill was
made etc
Noticed an alarming thing in per minute activity where ctldata was being written every minute
Need to know when this happened

It is a false alarm. In the emeter_app->per_minute_activity the last statement is   

Am sending a code to Shubham right now 
////-------------------------------------------------------------------------------------
27/02/24
This is a new folder G:\PRAVAK_this\Source3P_BootLoader
Two new DLMS libraries V0.8.09b and V0.8.09e  have been received
One has built the project with V0.8.09e
Need to verify if all is working OK

Sent the hex file - Shubham reports that communicaiton is not working - neither PRAVAK nor DLMS

Making a new File with V0.8.09b library

////-------------------------------------------------------------------------------------
15/02/24
In the generate_bill function after clearMymeterData() , the ctldata was not being saved into e2rom
DONE
Will send the file to Shubham
////-------------------------------------------------------------------------------------
13/02/24
we do not seem to have been saving the ctldata after the bill has been made - must be checked
first thing and code to be sent to Shubham
////-------------------------------------------------------------------------------------
13/02/24
16:05
after bill is made and clearMymeterData is called, the mymddata and zone mds were being cleared
the zone mds were written into e2rom, but mymddata was not written into e2rom
It has been done
and a hex file EEPL3P_GUJARAT_BIDIR_TEST_00_13_Feb_2024 is being sent
////-------------------------------------------------------------------------------------
11/02/24
Spent the entire day yesterday, 11-020-2024 tyring to figure out why the smart meter code was
not working
Also was thinking of the power on minutes issue
ctldata.powerOnminutes_eb must be used for cumulative power on minutes and the billingNuffer
must contain only the value for the month
One was grappling with this issue for the simple reason that the energies data structure
was being used to store cumulative values and recovery was being done from the previous bill
ctldata also had a backup and recoveries were being done from ctldata_backup
The problem with determining the powerOnminutes of the month by subtracting it from the
cumulative value of the previous month  will not work once 12 bills have been made ie after
the Billing Data storage in e2rom overflows
We will be able to compute the powerInminutes for every month except  the past 12th month as the
value for the 13th last month would have been lost

A simpler way is to revert to the bill data storing only the month's figure
On  the issue of recovering the cumulative powerOnminutes,it can be done by taking  the average
of all the monthly data for 12 months and multiplying the value by the number of months since
the meter start date

Hence energydata will contain the cumulative value - ctldata will contain the monthly figure
and the bill will contain the monthly power on hours

myenergydata.powerOnminutes_eb	: cumulative
ctldata.pwoerOnminutes_eb : monthly

////-------------------------------------------------------------------------------------
10/02/24
A Copy(54) is being saved - we need to fix the powerOnminutes issue
energydata.powerOnminutes_eb is cumulative
Then the billing data power on minutes must be cumulative too since while recovering
the data from the bill in case of a disaster the energy data values are copied from the bill
Thus when reporting the value to the user in the bill we need to compute the monthly value
by subtracting from the previous bill
In which case of what use is the ctldata.powerOnminutes_eb for?
////-------------------------------------------------------------------------------------
09/02/24

At Greater Noida
Shubham's mail - power on minutes in the bill are appearing as negative in history
////-------------------------------------------------------------------------------------
08/02/24
Shubham had reported that the tod energy values in the registers were not proper when the
zone was changing
It turned out that after reading the mytodata from memory for the new zone, the zone energies
in myenergydata were not being update with the values read. This has been corrected and a new 
hex file is being sent now

A second file sent at 14:11

Shubham informs that current md is not being updated - The problem was in the composeCurrentBillData function
We were reading the e2rom data for all zones except the current zone
It has been corrected

Will be visiting Greater Noida tomorrow
////-------------------------------------------------------------------------------------
07/02/24
Corrected code with time in minutes and md interval of 15 is sent today
////-------------------------------------------------------------------------------------
06/02/24
The timeInMinutes variable was only being computed in the export part of the energy_incrementation()
in the BIDIR meter case - this was resulting in incorrect values for myenergydata.kwh_Solar_import
////-------------------------------------------------------------------------------------
05/02/24
Hex file for Guarat BIDIR sent today at 10:50 hours
////-------------------------------------------------------------------------------------
04/02/24
09:28
Starting the day
Need to add Solar Hours - export and import and also provide access in display and through dlms
One must also store these registers in the bill, even though not required by the board

Added in r_dlms_data_h -> tag_class07_billing_entry_t
	Integer32		kwh_nonSolar_export;	// added 04/02/2024
	Integer32		kwh_Solar_import;	// added 04/02/2024
	Integer32		kwh_Solar_export;	// added 04/02/2024

Also added in energy data the following:
	int32_t kwh_Solar_import;
	int32_t kwh_Solar_export;

Also changed in memoryOps.c in write_history_data and in recover energies

The nonSolar and Solar energies are now being integrated in energyIntegration.c in the BIDIR_METER case - DONE

To include these in the display too - DONE

ZAP command is permanently enabled - Must be Undone

We are using the myenergydata.powerOnminutes_eb as data for the month
and ctldata.powerOnminutes_eb as cumulative power on minutes
It may be better to switch the functions of the two variables 
 
A Copy(53) has been saved - we will now perform a switch between ctldata and myenergydata.powerOnminutes_eb
Since the billing data is supposed to store the power on duration for the month, we will need to add a function
to compute the difference, as we will now be storing the cumulative value in the bills
This is to enable recovery of myenergydata from the last bill when needed
Also myenergydata.powerOnminutes_eb can be used to find the latest record in the energy records stored in e2rom

Finally, we need to ensure that TOD zone energies must equal the cumulative energies - once do_initial_things is completed

The check may also be made when a bill is being made

////-------------------------------------------------------------------------------------
03/02/24

Whenever we are using myenergydata, it contains all the energies, but for tod it only contains 
the energy for the presentZone
Hence whenever the myenergydata record is recovered, it must be ensured that the corresponding
toddata for that zone is updated

For reset, or for power return, do_initial_things is called when myenergydata and mytoddata 
must be reconciled

For otherwise recovery of myenergydata under extreme situations, if it is recovered from 
previous bill data, then all the tod registers must also be updated

In the recoverEnergies the muenergydata recorded has been reconstructed from the previous bill
and also reconciled with the toddata in e2rom

We also need to do something, in a more routine fashion which could include
a) when we come out of reset or a power failure
b) when the tod zone changes
c) when a bill is made

In all such cases, the data integrity needs to be ensured

ALSO NEED TO ADD THE Solar Hours 07:00 to 18:00 hours, and both export and import kwh is to be stored
DLMS access to be provided along with display on LCD
////-------------------------------------------------------------------------------------
02/02/24
The Copy(52) retains some starting version of this code
We need to make a code for Gujarat Bidir Meter

configuration of files for different boards is in the project_files.txt
we will switch to GUJARAT BIDIR from MVVNL

Display file is em_display_Gujarat
Tamper file is tampers.c
Gujarat Bidir does not use EVENTDATA_RECORDS_KVAH
Still now the voltage in eventdata_t will be recorded without decimal
Code compiles without error

***********************************************************************
* TO MAKE THE FOLLOWING STRUCTURAL CHANGE IN STORING THE ZONE_KWH     *
* Till now we have been storing the incremental energy in zone_kwh   	*
* and other zone_energies which were then added to mytoddata.kwh 			*
* whenever the zone changed - because we were adding it, it was 			*
* possible that in certain cases, the energy would get added more  		*
* than once resulting in a mismatch of cum_kwh and zone_kwhs					*
* To reolve this issue now in the myenergydata.zone_kwh we will store	*
* the cumulative value itself instead of the increment								*
* This will require changes in all the display functions and at other *
* where for the presentZone we were adding the mytoddata.kwh value    *
* to the zone_kwh_last_saved etc
***********************************************************************

CHECK ALL PLACES MARKED - ajay

////-------------------------------------------------------------------------------------
22/11/23
Starting work on this folder after stopping the work on the Smart meter owing to a problem
with the IC's used for E2rom which are 1024bit, instead of 512bit used till date.

Two issues to be addressed:
1) There is a problem of CTT failure during DLMS compliance testing
2) There is also aproblem of TOD registers not totalling upto the Cumulative register

Both need to be addressed
Before starting work a Copy 52 is being saved

////-------------------------------------------------------------------------------------
17/11/23
This folder produces hex file EEPL3P_MVVNL_UNIDIR_TEST_00_01_Nov_2023_1649
Deep has sent an email requiring the following functionality
Sir , 
Chip time is not required in this  data format, and other data and details are given below.

Fields       Type  Number   Number Of  Format
									of bytes  Decimals
Start byte   Hex    1         NA         $
NOB					 Hex    1         NA         44 data bytes only
Serial No    ASCII  16        NA
Current DtTm Hex    6					NA				(ddmmyyHHmmss)
Present kWH	 Hex		4					3					Unsigned long number
Present kW	 Hex		4					3					Unsigned long number
Billing Date Hex		6					NA				(ddmmyyHHmmss)
Previous kWH Hex		4					3					Unsigned long number
Previous kW  Hex		4					3					Unsigned long number	
										2					NA				0D 0A

Thanks & Regard
Deep

The command is the string "EEOSPOTBILLH\r\n"

////-------------------------------------------------------------------------------------
01/11/23
07:55 
Hex file sent

15:16
Shubham sent a mail
	Block energies Kvarh lead and KVAh are not showing digit 4th value in Class 3, Meter showing
	 119VAh energy instead of 1194 and 235 Kvarh lead instead of 2354. Scaler is 0 for all energies.

In lines 643 and 653 of r_dlms_user_interface one had not removed the /10 factor

16:49
EEPL3P_MVVNL_UNIDIR_TEST_00_01_Nov_2023_1649 being sent again with the necessary changes

////-------------------------------------------------------------------------------------
31/10/23
Shubham had called to say that in Class 3 the block energies were not getting updated
	we were dividing the energy by 10 in classe 3, whereas in load survey we were using three decimals - FIXED

////-------------------------------------------------------------------------------------
Shubham's email of 26/Oct/23

The above observation point result of 23 oct mail is given below -

	Point no 1, 2, 3, 4, 5 is done but as we discussed i got meter stuck permanently two times and tried to generate
 	the same again so that i can check the exact condition of repeatable process and how much time it takes to come 
	back in normal mode.

	And as given observation of 20 OCT. there is some points that is not resolve so please check -

	Point no 3-   Low voltage check -  DONE
         A- Check at 175 V (73%Vref) in R, Y & B 240V and without current but low voltage was not recorded.
         B-  Check at 144 V(60%Vref)  in R phase and Y & B 240V with Current 5 Amp in all-  Not record.

	Point no 2 - AT Voltage Unbalance and Voltage Missing Condition - we provide 220V in R, 192V in Y and 120V in - DONE
		B phase and 10 Amp UPF in all phases -  Meter Record B phase voltage missing and Voltage unbalance. In the 
		display B symbol was missing but Unbalance symbol was not showing.

	Point no 4 - In Neutral disturbance tamper - B phase read 0V and R &Y read 412V approx and In display N icon blink - DONE
		and RYB showing permanent but as B phase has 0 volt then B icon will not show as it  takes B phase miss.

	Point no 1- While checking reverse Tamper -we provide 240V, 10 Amp, upf in all phases but Meter Record R phase - DONE
		Power factor  -25/ -26  and at restoration time Y&B record -95PF.
////-------------------------------------------------------------------------------------
20/10/23

Shubham's email of 19/Oct/23

1- In NMV test by removing memory U12 and U14 - DLMS status is changed but display status in Anomaly is not changed
   as you told me it will change only when we remove U2.  Sir we will not remove U2 further because our meter does 
	 not walk up in that case so please change status for display also while we remove U12 and U14. DONE.

2- As Discussed with you sir please take min voltage 24 in all three phases while checking Voltage unbalance, 
   CT Open and CT Cypass tamper. DONE

3- In display - Please remove High resolution parameter from mode 2 as i checked in Specs, there is no mention 
   there So please give a high resolution energy (Active, apparent & reactive energy) in Mode 3 with 30 min locking. DONE
 
4- please add phase sequence reversal for current and voltage both in mode 2 (push button mode) at the last parameter. DONE

5- Meter data and RTC corrupt in block and daily load. - FIXED, e2rom addresses for daily log and load survey were overlapping
   A- I checked 2-2hrs RTC jump and meter run minimum 1 min after every RTC jump. 
	 Meter records wrong value on 28th oct at 7:00 slot and daily load data record wrong till 28th Oct.

   B- I checked 4-4hr RTC jump and meter run minimum 1 min after every RTC jump. Meter records wrong value
	    on 27th oct at 6:30 and 7:00 slot and daily load data record wrong till 27th Oct.
            
   C- I also checked the 12hr RTC shift bhut got the same result as the meter recording the wrong format of 
	    date and time with garbage values.

Note - please check Kalki-tech data of block and daily load records also RTC log which i was sent cmd.

////-------------------------------------------------------------------------------------
13/10/23
Have reverted to compiler version 1.06 but hex file unfortunately does not match that of Test file of 11 Oct 23
In tampers_PVVNL fault_code variable was neing set to 7, which was generating the missing potential indications
for Vr, Vy and Vb. These were causing the RYB icons to go on the blink (disappear)
The offending line has been commented
A file production2_v106.hex has been saved

Changed Build Tool settings to use Compiler 1.11 - Hex file does not match that of production2_v106.hex 


There are two E2ROM test functions perform_E2ROM12_Test and perform_E2ROM_Test

perform_E2ROM12_Test is used while accessing e2rom performance from function R_OBIS_GetObjectAttr in dlms_data.c
This test checks IC12 and IC14

while the perform_E2ROM_Test is used in display while showing anomaly - This tests IC2 (address 00000)

////-------------------------------------------------------------------------------------
11/10/23
Have upgraded to Version 8.10 yesterday - surprisingly the hex file generated did not change at all

////-------------------------------------------------------------------------------------
10/10/23
09:26
Test File being sent
////-------------------------------------------------------------------------------------
09/10/23
Need to debug MVVNL code

Could not find any bug, but the hex file sent to Shubham did not match the hex file produced today

Am sending a fresh hex file and will request feedback from Shubham

10:07
Hex file sent

17:06
The bug was found in the usage of the counter variable - it has been fixed for both unidir and bidir
Will send the test code - tomorrows date
////-------------------------------------------------------------------------------------
05/10/23
For MVVNL,
following changes are being made
1) kvarh lag and lead to be stored in block load - DONE
2) tamper records will store kvah, voltage will be stored without decimal and pf with two decimals
		writing part : DONE
		retrieval		 : DONE
		Now the e2rom_adds.h : DONE
3) load survey data also stores apparent and active demands in that order - DONE
4) TOD to be made having 8 tariffs
	  changes in tod - DONE
		changes in billing - DONE
		
////-------------------------------------------------------------------------------------
02/10/23
A Copy(51) has been saved to preserve the Unidir Gujarat Release Version 46
Shubham has already pointed out one bug
The write_passive_tod() function is called in r_dlms_obis_ic.c only once in case 5,9
when the day_profiles are being got or set
Hence if someone changes the season profile only, or the week profile and does not touch the
day profiles then those changes are lost after a power cycle (off & on) since upon power on, the values are
read from e2rom therby resulting in the ram values getting written with old stuff

16:35
The solution may be to call the function multiple times - DONE
This folder will now NOT compile to Unidir Gujarat Version 46

Now one should make the changes for MVVNL
Shubham's mail of 14/Sep/2023

Need Three phase MVVNL Uni-dir. Hex file ( Lucknow)-
Requirement -     
1-  Zero lag-Unity –Zero lead  PF requirement.	- DONE
2-  Please add Average KW and KVA in the Block load profile.
2-  Remove SAP 2 and SAP 3 from IC 17 for CTT test. - DONE
3-  Please Add IC 9. - DONE
4-  TOD Implementation. - DONE (all time zones have same script id = 1)
                            
Some of observation points of MVVNL given below-

1- According to TS, Push to auto mode time is 1min. But the meter display has pushed to auto mode time 5 min. DONE
2- According to TS meter should be suitable for Zero lag-Unity –Zero lead but meter is lag only.	DONE
3-While walking-up meter for the first time - some segments are off in all segment tests. CHECK AGAIN
4- When we clear the meter memory then the meter serial number also clears. THIS ALWAYS HAPPENS
5- According to TS Tamper count is required in the billing profile. DONE
6- Selective access is not working with rollover in daily load, wrong entries show. CHECK AGAIN
7- The meter preferably shall have a scroll lock facility to lock desired parameters from push button displays parameter. PLEASE EXPLAIN FURTHER
8-When we will apply the condition of CT open tamper then only miss indication will show. But the RYB symbol is not blinking.
9-Voltage unbalance tamper has not occurred in all conditions.
10-when we are doing the current Bypass tamper in bench then Bypass and unbalance symbol are showing in display but tamper has
   occurred current bypass only.
11- While we checked the ND tamper by putting B phase wire to the Neutral terminal then the meter showed only the B icon in display.
12- After 72A in any phase, the RYB symbol disappears. And the current<72A RYB symbol shows correctly.
13- When I applied 2 Tamper conditions at the same time then only one tamper occurred. Ex - I have applied miss potential in R phase
    and CT open condition in Y phase then miss indication is not showing.

Note- sir, We attached technical specs of MVVNL below for your reference and also attached Tamper sheet and Display sheet separately.

MVVNL code is being build using the PVVNL_UNI_DIR_METER

default e2rom_adds.h is being used

em_display_Gujarat and tampers has been excluded from build
tampers_PVVNL.c and em_display_MVVNL.c have been included in the build



////-------------------------------------------------------------------------------------
28/09/23
Shubham's mail received last evening
	Display of L1 MD KW and L1 MD KVA  is now ok.
	Please send the production code file.

10:03
 Factory code for version no 46 of UNIDIR Gujart meter being sent.DONE
////-------------------------------------------------------------------------------------
27/09/23
Test code for UNIDIR meter Gujarat had been made and sent
Also changes had been made to BIDIR Gujarat Version 45
A Copy(50) is being saved
Shubham has sent an email regarding observations in Gujarat Unidir meter owing to
revised bill data and unidir meter having only 5 time zones instead of eight earlier

Email of 26/Sep/2023
Display related observation ---
1- Mode 1 (auto mode)
   A-  MAXIMUM DEMAND OF PREVIOUS MONTH IN KW - is not showing. ( this is in repeat parameters)
2- Mode 2 --
   A-  MAXIMUM DEMAND OF PREVIOUS MONTH IN KVA - Showing wrong value - 2970.503  inplace of 7.212

This folder produces identical hex file for EEPL3P_GUJARAT_UNIDIR_TEST_00_21_Sep_2023

Now for the display related changes

Both the above changes have been made 96 -> 72   and 240-> 168
Hex File being sent
////-------------------------------------------------------------------------------------
22/09/23
BIDIR GUJARAT Version 45 being released
Changes:
1) Errors in units and scalers
2) Change in recovery time for cover open from 15 to 5 minutes
3) Doing away with harmonic injection correction in bidir meters for all cases

11:02 Factory code hex file sent

Now for bootcode (boot image)

1) 	Need to send a boot image for factory version 45 (PCB VERSION 2_5)
		Confirm that hex file produced matches the Factory Version - DONE
		Will now change it to produce mot files in BOTH PROJECT AND SUB PROJECT - DONE
		(CC-RL Build Tool -> Property -> Common Options -> Hex Output)
		Change the merge.txt file - DONE
		Clean and Rebuild
			phase, production, rl78i1c and BootCode mot files have been generated - DONE
		Clean Desktop->Bootstuff folder - only mot2bin should be there - DONE
		Copy phase mot file to Desktop->Bootstuff folder - DONE
		Drag and hover phase mot file over mot2bin - this produces phase.bin - DONE
		Open bin file with hex editor
		Delete the blank tail end of the bin file - DONE
		Rename it as EEPL3P_PCB_VER2_5_GUJARAT_BIDIR_IMAGE_VER_045._bin - DONE

	RESTORE SETTINGS in both PROJECT and SUB PROJECT Folder to Intel Hex - DONE
	RESTORE the merge.txt file to Intel Hex - DONE
	
	Verify that code compiles to the factory version 45 - DONE

////-------------------------------------------------------------------------------------
21/09/23
Some errors regarding the units and scalers were observed in billing data and other profile cases - ALL DONE FOR BIDIR CASE

Also during cover open the recovery time should be 5 minutes and NOT 15 minutes - DONE (reference file production2) - DONE

There is also some issue related to harmonics injection in bidir meters for the four cases - DONE
1 Both Voltages and Currents in Phase
2 Voltage out of phase, current in phase
3 Voltage in phase, current out of phase
4 Voltage and Current out of phase

RESOLUTION : Harmonic computation is NOT to be performed for BIDIRECTIONAL meter when it is running in IMPORT or EXPORT mode
Two #define HARMONICS_COMPENSATION_IN_EXPORT_MODE and #define HARMONICS_COMPENSATION_IN_IMPORT_MODE have been created
both of which are commented for BIR Meters (reference file production3)

Now errors regarding the units and scalers were observed in billing data and other profile cases being fixed
For all class 07 cases, the following things are to be changed in tandem - with the example of billing profile

1)	r_dlms_data_ic.c
			const class07_capture_object_t g_Class07_BillingCaptureObjects[] = OK (87 elements)
			const class07_capture_object_t g_Class07_BillingCaptureObjects_Scaler[] = OK (87 elements)
2)	r_dlms_data.c
			const scaler_unit_t		g_Class07_BillingScalerBuffer[] = OK
3)	r_dlms_data.h
			typedef struct tag_class07_billing_entry_t	-	OK

4)	r_dlms_data_meter.c - OK
			R_OBIS_Class07_FilterOneBillingEntry (buffer_t *buf, Unsigned16 index, Unsigned8 *p_out_buf, Unsigned16 *p_out_len) implementation
			
	THERE MUST BE COMPLETE SYNERGY IN THESE FOUR ELEMENTS FOR CORRECT AND PROPER RESULT (Checked OK - reference production3)

Some mistakes have been pointed out in other areas also which need to be fixed - These are

a) Instantaneous parameters - active energy  - CORRECTED DONE
b) Blockload Scaler for instant pf which should be -2 - CORRECTED DONE
		We were using SCALAR_APF which was -3, being replaced with SCALAR_AMPERE which is -2
		
Finally the reference file is production4

Now for GUJARAT UNIDIR meter changes - DONE

12:32 Hex files being sent with ver 00 - It will not match production4

////-------------------------------------------------------------------------------------
19/09/23
Resuming work
A Copy Source3P_BootLoader - Temp has been saved temporarily
This folder produces Bidir Gujarat Version 44
////-------------------------------------------------------------------------------------
18/09/23 10:19
at DEW EB
This folder compiles to Bidir Gujarat Version 44

Now building Unidir Gujarat Version 00

There is a bug in the g_Class07_BillingScalerBuffer definition,
Also there seems to be a duplication of the #define to handle TOD_HAS_KVARH_LAG
For Bidir meter this is a default ie TOD has Kvarh lag, but for Unidir it is an option
Thus we seem to be using the #define UNIDIR_TOD_HAS_KVARH_LAG for Unidir meters and for
BIDIR meters we are treating TOD has Kvarh lag as default - This is resulting in the same line
of code getting written twice, once with the UNIDIR_TOD_HAS_KVARH_LAG option and the other with
a BIDIR_METER option - This is not efficient for lines of code.

A better method would be to change the #define UNIDIR_TOD_HAS_KVARH_LAG to #define TOD_HAS_KVARH_LAG
Being done and code generated will be tested if it produces the same file as Bidir Version 44

IT IS IDENTICAL

So now we have a feature called #define TOD_HAS_KVARH_LAG and this can be used for Bidir or Unidir meters

Shubham confirmed telephonically that in the Bidir meter the billing data is being accompanied with 
incorrect units

////-------------------------------------------------------------------------------------
20/08/23 05:26 IST
A Copy(49) has been saved to preserve the Bidir Gujarat Version 44
////-------------------------------------------------------------------------------------
12/08/23 05:26 IST
Shubham's email of 11/08/2023
We checked the Activity calendar with default setting and After change setting with different -2 time zone, 
week and season that is working fine.
We are checking the other things like Tamper and data - All ok till checked multiple conditions.
SIr please provide Hex file of production with default TOD Zone in all and with default season and week 
according to Specs because production will start from monday 

21:55 IST
Hex file being sent - Production release for Bidir Gujarat  Version No 44
RAMDATA SECTION:  000030ea Byte(s)
ROMDATA SECTION:  00003afc Byte(s)
PROGRAM SECTION:  0002f1d6 Byte(s)
__STACK_ADDR_START  000ffd00 _STACK_ADDR_END 00ff474 Size 2188 bytes
File name EEPL3P_PCB_VER2_5_GUJARAT_BIDIR_FACTORY_VER_044
////-------------------------------------------------------------------------------------
08/08/23 05:26 IST
A Copy(48) is being saved to preserve the code of 04/Aug/23
The bug has been found in do_initial_things in the call to CalcDayNumFromDate for rtcLast.day
Fixed and Hex file of 08/08/2023 being sent
////-------------------------------------------------------------------------------------
04/08/23 01:11 IST
A Copy(47) has been saved to preserve the code of 03/Aug/23
Shubham has provided feedback
1) week profile write works without error, but written values are not getting read - no change?
2) there is a problem when date is changed drastically and the new date has a different dayID from
   the previous one. It turns out that all the energy of the previous tariff zone is getting 
	 transferred to the new Zone - this issue needs to be addressed in do_initial_things and at other
	 places where findZone is called - in do_initial_things we are in all likelihood using the ctldata
	 minutes and hours to find the zone, where the date, month, season, day_of_week are also relevant
	 This change needs to be incorporated to fix the bug

For some strange reason
the following line was not working
		temp_out_len = R_OBIS_DecodeAttribute((uint8_t *)p_child_week_profile->Monday,1,ATTR_TYPE_UNSIGNED,pdata,OBIS_SERVICE_DATA_BUFFER_LENGTH);

and an indirect way was adopted which worked
		temp_out_len = R_OBIS_DecodeAttribute((uint8_t *)tbuf,1,ATTR_TYPE_UNSIGNED,pdata,OBIS_SERVICE_DATA_BUFFER_LENGTH);
		p_child_week_profile->Monday = tbuf[0];

Now the week profile values are getting set

The findZOne has also been modified

11:16 IST
Hex file being sent now
////-------------------------------------------------------------------------------------
03/08/23 10:41

Shubham had sent a mail informing
1) of week profile always showing failure
2) Problem with Energy shifting from one tariff register to another when bill was made
3) Issue with rtc battery test, in Gujarat meter which remains in Mode 3 for 18 hours - Does the rtc test work in Mode 3
	(Checked - battery test is run in Mode 3 also)

Week profile has been fixed.

10:43
Hex file being sent for further tests
////-------------------------------------------------------------------------------------
01/08/23 05:15 IST
Found the bug which was creating problems in season and week profile updates
A folder G:\PRAVAK_this\RNSS3P20\Source3P_BL_Test which contains a modified copy of this code
allows the code to be run on a simulator and tested

The changes have been reflected in this folder and following is the state
RAMDATA SECTION:  000030aa Byte(s)
ROMDATA SECTION:  00003abc Byte(s)
PROGRAM SECTION:  0002f00a Byte(s)

STACK FFD00  FF434 (2252 bytes)

////-------------------------------------------------------------------------------------
27/07/23 00:14 IST
Working on fixing the const and ram structures for DLMS class20

Currently
RAMDATA SECTION:  00003024 Byte(s)
ROMDATA SECTION:  00003ab4 Byte(s)
PROGRAM SECTION:  0002f1cf Byte(s)

Following is the state of affairs when we have defined some objects are defined as const
The stack start and end addresses are given below:
  __RAM_ADDR_START                000fbf00         0   none ,g         1
  __RAM_ADDR_END                  000ffee0         0   none ,g         1
  __STACK_ADDR_START              000ffd00         0   none ,g         1
  __STACK_ADDR_END                000ff3ae         0   none ,g         1

If we remove the const and make them ram variables, then the new thing becomes
RAMDATA SECTION:  000030a2 Byte(s)
ROMDATA SECTION:  00003ab4 Byte(s)
PROGRAM SECTION:  0002f1cf Byte(s)

  __RAM_ADDR_START                000fbf00         0   none ,g         1
  __RAM_ADDR_END                  000ffee0         0   none ,g         1
  __STACK_ADDR_START              000ffd00         0   none ,g         1
  __STACK_ADDR_END                000ff42c         0   none ,g         1

The RAMDATA section has increased by 30a2-3024 = 126 bytes
The STACK size has changed by 126 bytes
The STACK size now is 2260 bytes which is 724 bytes more than the reserved size of (0x600) ie 1536 bytes

Looks ok, which means we can allow the seasons, week name, season_profiles and day_profiles to be in ram

changes have been made - the profiles are now being stored in ram and the length of season name has been increased by 4 bytes
The now stack start and end addresses are given below:
RAMDATA SECTION:  000030aa Byte(s)
ROMDATA SECTION:  00003abc Byte(s)
PROGRAM SECTION:  0002f187 Byte(s)
We are using 8 more bytes of RAM attributed to increased lengths of season name

Default values have been correctly written for active season start times (01/April and 01/October)
Transfer from passive to active should work correctly

Display file has also been corrected for new offset values in bill data

05:47 IST
Hex file sent

////-------------------------------------------------------------------------------------
25/07/23 05:58 IST

Hex File is being sent - done

23:10 IST starting work again - a Copy(46) is being saved before starting work to preserve the code of 25/Jul/23
Shubham had called and he had indicated that passive tod was not getting written

In findZone, if season starttimes are not defined i.e. the  date and month are 0, DONE
then one should default to season = 0
////-------------------------------------------------------------------------------------
24/07/23 01:22 IST

following things remain to be done
(a) intialising the tod arrays and structures, saving them in e2rom etc
(b) shifting from passive to acive to be reimplemented
(c) Functions such as populate TZ0, TZ1 array, populating ZoneDefs passive and active etc to be done
(d) zonedefs are not to be used any more - we now have the arrays zoneTimes and scripts which exist on the stack only

shifting the focus slightly
(a) we need to modify the billing_t structure as we need to have only 5 tariff registers - done
(b) computation of average_pf for bidir meters to be the composite of import and export - done
(c) In single action schedule the time used for the bill date should be the time provided by user - done
		and not the actual time
(d) In Class 9 doing MD reset should show reset on the meter display - done
(e) NVM diagnostics
		In r_dlms_data_ic.c an entry no 27 has been added to g_ChildTableClass01 for SelfDiagnostic
		This data is provided by accessing the Class_01 object from DLMS and the code is written in
		r_dlms_data.c->R_OBIS_GetObjectAttr - USED_CLASS_01 - case 27:
		The function perform_E2ROM_Test() is being called
		At present this function tests the E2ROM at page 0 - we need to check at pages 1 and 2
		If any of the e2roms at page 2 or 2 (IC U12 or U14), it should result in a failure
		If the IC is resoldered the status of NVM should become good once again
		A new function perform_E2ROM12_Test to test the ICs at bank1 and 2 is being written
		Since these ICs may contain data, hence we will need to save the data at the particular
		address, write the test data, read it back, and if OK, then restore the earlier data too
		
(f) Season, week, day TOU implementation - done

21:54 IST
ALl references to zonedefs have been commented
RAMDATA SECTION:  0000306a Byte(s)
ROMDATA SECTION:  00003ab4 Byte(s)
PROGRAM SECTION:  0002e8df Byte(s)

Now to look at tod as a whole

The three initialisation functions in our code are 
(a) init_read_tod()	- done
(b) init_read_passive_tod - done
(c) init_read_single_action_activation_data - done

Since there are no zonedefs anymore, we are relying on the proper data in the following structures

25/07/2023 00:52 IST
We have made the following changes - Both these profiles are now declared as const
const day_profile_t		g_Class20_day_profile_active
const day_profile_t		g_Class20_day_profile_passive
Change has also been made in r_dlms_obis.h tag_class20_child_record_t where the pointers have also been defined as const
	const day_profile_t		*p_day_profile_active;			/* Day profile active */
	const day_profile_t		*p_day_profile_passive;			/* Day profile active */

This has saved 48 bytes
RAMDATA SECTION:  0000303a Byte(s)
ROMDATA SECTION:  00003ab4 Byte(s)
PROGRAM SECTION:  0002eec9 Byte(s)

 
////-------------------------------------------------------------------------------------
23/07/23

While working on the saving of new sets of data for active and passive tods for seasons, weeks etc one came
across the necessity to use checksumming

It was noticed that in SaveCalibrationValues in memoryOps the structure calib is being written into e2rom
The code executed is
	write_alternately(CALIB_BASE_ADDRESS, ALTERNATE_CALIB_BASE_ADDRESS, (uint8_t*)&calib, sizeof(calib));

Now this write_alternately computes the checksum and stores it in the last byte ot the structure
HOWEVER THE structure calib DOES NOT HAVE THE LAST BYTE IN WHICH THE checksum may be stored
Instead the last byte happens to be a portion of EM_CALIB_GAIN   phase_b which must be getting corrupted

***************************************************************
*	SO HOW DOES THE STUFF WORK - IS THERE A BUG - NEED TO STUDY *
***************************************************************

07:22 IST
A Copy(45) has been created before we make any further changes
A G:\PRAVAK_this\RNSS3P20\Source3P_BootLoader - Copy_temp had been made some time back
Else the reference is probably Copy(44)

1) To add a new file tod.c - done

21:48 IST
To rewrite findZone taking into account the season, week etc

24/07/23 00:18
Build done
RAMDATA SECTION:  000030a4 Byte(s)
ROMDATA SECTION:  00003b32 Byte(s)
PROGRAM SECTION:  0002e6a9 Byte(s)


////-------------------------------------------------------------------------------------
21/07/23
Following changes have been made
	g_Class20_season_profile_active[] is now defined as a const season_profile_t 
	g_Class20_season_profile_passive[] is now defined as a const season_profile_t  and 
	
Changes have also been made in the r_dlms_obis.h->class20_child_record_t definition
where the *p_season_profile_active and the *p_season_profile_passive have now been defined as const season_profile_t

The new section usage is 
RAMDATA SECTION:  000030a4 Byte(s)		30cc earlier - 40 bytes saved
ROMDATA SECTION:  00003b32 Byte(s)
PROGRAM SECTION:  0002e39b Byte(s)

////-------------------------------------------------------------------------------------
20/07/23

Added a line to readRTC()
		rtc.day = (uint8_t)CalcDayNumFromDate((2000+rtc.year), rtc.month, rtc.date);
This will ensure that whenever rtc is ready, the day of the week is correctly available
////-------------------------------------------------------------------------------------
20/07/23
The type day_profile_action_t in r_dlms_obis_ic.h has been redefined 
The script_logical_name has been removed.
Wherever required the script_logical_name is being inserted in code as {0, j , 10, 0, 100, 255} 
where j goes from 0 to 7, j also corresponds to the script number

There is probably some problem in the usage of the script logical name which should be listed
in the class 09 - The functions affected are R_OBIS_Class20_ProfileTimeCheck, R_OBIS_Class09_ScriptExecute etc

This needs to be handle separately
Making this change in the day_profile_action_t has resulted in a RAM saving of 384 bytes

A similar thing can be done for the time_t TZ_start_time_* arrays
These arrays are referred to in the day_profile_action_t instances
Since each time_t uses 4 bytes and there are 8 rows - this uses 32 bytes, which can be brought down
to 16 bytes by assuming seconds to be always 0 and hundredths to be NOT SPECIFIED

23:25
Continuing in the effort to reduce the ram usage, now the specs will be as follows
Time zones - 8
Tariff scripts - 5
Seasons - 2
Weekdays - 2 types of days for each season

start time arrays will not store seconds
day_profile_action_t will not store the OBIS codes, they will be generated from the start time index value (0 to 7)

STACK_ADDR	ffd00	ff456	(2218 decimal)
RAM_ADDR    fbf00	ffee0 (16352 decimal)
RAMDATA SECTION:  000030cc Byte(s)
ROMDATA SECTION:  00003b32 Byte(s)
PROGRAM SECTION:  0002e380 Byte(s)
////-------------------------------------------------------------------------------------
18/07/23
A Copy_temp is being saved as one is making several changes for the class20, seaon, week, day etc

all references to TZ_start_time and day_action in utilities will have to be redone
all references to TZ_start_time in r_dlms_data_meter will have to be redone
////-------------------------------------------------------------------------------------
05/07/23
We need to fix the reactive power computation for the bidirectional meter case
			Active Power		Reactive Power			
Q1				Import(+)	    Import(Lag)
Q2				Export(-)			Import(Lead)
Q3				Export(-)			Export(Lag)
Q4				Import(+)			Export(Lead)

Active power is +ve(Import) in Q1(Import Lag) and Q4(Export Lead)
Active power is -ve(Export) in Q2(Import Lead) and Q3(Export Lag)

The following four variables are available to us
	total_consumed_reactive_energy_lag
	total_consumed_reactive_energy_lag_export
	total_consumed_reactive_energy_lead
	total_consumed_reactive_energy_lead_export
	
These changes have been made in the energy_incrementation function for bidir meter case

If active energy is -ve, meter is in export mode
	if power factor is lead, then total_consumed_reactive_energy_lead(import) is incremented
	if power factor is lag, then total_consumed_reactive_energy_lag_export is incremented
	
else when the meter is in import mode
	if power factor is lead, then total_consumed_reactive_energy_lead_export is incremented
	if power factor is lag, then total_consumed_reactive_energy_lag(import) is incremented

Now things should work as per CBIP Guide Research Publication No 325 page 78

We should also do something for the Class_09, and DLMS CTT Testing
1) To make it pass SAP we need to have only one SAP and not 3 - DONE
2) Need to make Class_09 visible - DONE (also bill will be generated)

06:23 IST
Test Code for Version No 00 is being sent
Done
////-------------------------------------------------------------------------------------
02/07/23

Two changes to be made for DLMS CTT testing
1) To make it pass SAP we need to have only one SAP and not 3
2) Need to make class_09 visible
////-------------------------------------------------------------------------------------
28/06/23
Rohit wants hex file for the code for which the boot image had been sent
We will release it as Version 43 - Gujarat Bidir, with changes made for magnet operation

To change the settings to produce hex file and to change the merge file
A Copy(44) is being sent to preserve the Release Version 43
Folder COpy(44) produces the hex file EEPL3P_PCB_VER2_5_GUJARAT_BIDIR_FACTORY_VER_043

This will now be emailed to Rohit

We also need to send a test version 00 for DLMS Conformance testing - will be done after sending the production hex file


////-------------------------------------------------------------------------------------
20/06/23
at Gainesville
Need to make changes in Magnet mode, wherein voltage current and power values should also be
240, Imax and 240*Imax*3 everywhere including the display, load survey tampers etc
A Copy(43) is being saved, although a Copy(42) exists

We need to make a boot image for the Bidir meter for version 42 and "42.1"

23:55 IST
At the time of start this folder produces 
EEPL3P_PCB_VER2_5_GUJARAT_BIDIR_FACTORY_VER_042

1) 	Need to send a boot image for factory version 42 (PCB VERSION 2_5)
		Built with Version number 42, and matched with hex file - DONE
		Will now change it to produce mot files in both project and sub project - DONE
		(CC-RL Build Tool -> Property -> Common Options -> Hex Output)
		Change the merge.txt file - DONE
		Clean and Rebuild
			phase, production, rl78i1c and BootCode mot files have been generated - DONE
		Clean Desktop->Bootstuff folder - only mot2bin should be there - DONE
		Copy phase mot file to Desktop->Bootstuff folder - DONE
		Drag and hover phase mot file over mot2bin - this produces phase.bin - DONE
		Open bin file with hex editor
		Delete the blank tail end of the bin file - DONE
		Rename it as EEPL3P_PCB_VER2_5_GUJARAT_BIDIR_IMAGE_VER_042._bin - DONE

00:07 IST
Now to make the changes desired

Rohit's email
The latest code used by us version 42 for three phase bidirectional meters
When we apply magnet and if the meter detects & records energy as per Imax, then we change  
the value of current to Imax in all three phases irrespective of the actual current flowing.
However, in the above case we are displaying power as per actual current flowing in the meter,  
during inspection today it was pointed out by the inspecting officer that we need to display 
and record power also as per Imax current flowing in the meter 
i.e. displayed & recorded power should be = (240*60*UPF*3). 
Please send an image file as the meters are sealed and we need to program the meter 
without opening the meter top cover.
Please also send an image file of code no 42, so that if any problem arises then we can switch
back to the original version of code by reprograming from the top.

display - we are calling getInstantaneousParams except for the case of instant load kw - to be changed - DONE
tampers - we are calling getInstantaneousParams - this is OK
load survey - perform_VI_averaging - we are using actual values - needs to be changed - DONE

01:01 IST

2) 	Need to send a boot image for factory version 42(modified) (PCB VERSION 2_5)
//		Built with Version number 42, and matched with hex file - DONE
//		Will now change it to produce mot files in both project and sub project - DONE
//		(CC-RL Build Tool -> Property -> Common Options -> Hex Output)
//		Change the merge.txt file - DONE
		Clean and Rebuild
			phase, production, rl78i1c and BootCode mot files have been generated - DONE
		Clean Desktop->Bootstuff folder - only mot2bin should be there - DONE
		Copy phase mot file to Desktop->Bootstuff folder - DONE
		Drag and hover phase mot file over mot2bin - this produces phase.bin - DONE
		Open bin file with hex editor
		Delete the blank tail end of the bin file - D
		Rename it as EEPL3P_PCB_VER2_5_GUJARAT_BIDIR_IMAGE_VER_0421._bin

Send by email after zipping


////-------------------------------------------------------------------------------------
03/06/23
This folder with version numbers 0 produces the hex files
EEPL3P_GUJARAT_UNIDIR_VER_00_02_June_2023_1517 and
EEPL3P_GUJARAT_BIIDIR_VER_00_02_June_2023_1518

These files have been tested and fresh PRODUCTION code will be released
with version numbers 41 and 42

The bug related to rtc battery test has been fixed by performing the test in Mode3 or Mode4

Following files will be produced and sent
EEPL3P_PCB_VER2_5_GUJARAT_UNIDIR_FACTORY_VER_041 and
EEPL3P_PCB_VER2_5_GUJARAT_BIDIR_FACTORY_VER_042

A Copy(42) will be saved to preserve this release
////-------------------------------------------------------------------------------------
02/06/23
Shubham has reported some problem with the released code for Gujarat Unidir and Bidir meters
They are not getting calibrated, some of them, and they are showing values of 0 and other
abnormal values for current and pf - wonder why this is happening

It may be that the new rtctest which is now performed in power mode 1 may be responsible

A Copy(41) of this code is being saved, to preserve the state of the released code

Will send test code with the rtc test commented

A #define DO_RTC_BATTERY_TEST has been defined
If not commented then This folder produces the hex files sent as release code 39 and 40
If commented then the RTC_BATTERY_TEST is not performed

The #define has been commented so that the performRTC_BatteryTest() will not be called anymore
The performRTC_BatteryTest does not seem to be clearing the RTC_TEST_FLAG if the rtc battery is OK
This may be resulting in repeated calls - will need to check
At present test code is being sent with the DO_RTC_BATTERY_TEST being commented

14:38
Shubham has confirmed that after commenting the DO_RTC_BATTERY_TEST the problem of calibration
and incorrect voltage, current pf values has disappeared

We will activate the DO_RTC_BATTERY_TEST but it will be performed only in MODE3 or MODE4

Changes have been made
The DO_RTC_BATTERY_TEST has been removed
Now Battery test is performed only in MODE3 or MODE4 as earlier

We will send Test Code once again, following which we will release the PRODUCTION code

15:29 Two hex files sent
////-------------------------------------------------------------------------------------
29/05/23

11:04
Papa left us on the 25/May/2023 at 9:07 pm
Last rights were performed on 26/05/2023
Ma came to Patna on 27/May/2023
Shanti path and Shudhdhi was performed on 28/05/2023

The computer took a real long time to boot today

Will send release production code for Both Unidir and Bidir meters

Verification

This folder correctly produces the hex files
EEPL3P_GUJARAT_UNIDIR_VER_00_17_May_2023
and 
EEPL3P_GUJARAT_BIDIR_VER_00_17_May_2023

Features and Fixes
1) Selective access of Load Survey and Daily Log has been reimplemented using Binary search
2) RTC battery check has been reimplemented
3) An object in Class 1 added to get status of rtc battery and memtest
4) A LAG symbol added in high resolution display 

New files being released

EEPL3P_PCB_VER2_5_GUJARAT_UNIDIR_FACTORY_VER_039 - DONE
and
EEPL3P_PCB_VER2_5_GUJARAT_BIDIR_FACTORY_VER_040 - DONE

11:27
Both files sent
////-------------------------------------------------------------------------------------
17/05/23
A Copy(40) is being saved before starting work on the RTC problem

The rtc battery test will now be performed in MODE1
The test will be conducted after rtc has been read every 30 seconds


1)LVDVRTC detection level is _02_VLVDVRTC_LEVEL2 (2.57 Volts)
2)In pravakComm->"ZAP" the 		if(calswitch!=0) line has been uncommented

OBIS code {1,   0, 96,  5, 0, 255} entry in Class 01 has been implemented to report RTC_BATT_LOW and MEM_STATUS

The value is to be decoded as follows:
						  OK   NOT_OK	
RTC_BATT			0			1
MEM_STATUS	  0     2

For RTC_BATT NOT_OK means that RTC_BATT voltage is Low
For MEM_STATUS NOT_OK means that Memory IC (Chip address 0) is not functioning properly

The values obtained by reading this object will be 0,1,2 or 3.
They can be interpreted from the table above.

Bidir and Unidir Test codes will be sent



////-------------------------------------------------------------------------------------
16/05/23
Have tested 11 cases without overflow for load survey and results are ok

One can now proceed for Daily Log - DONE

If RTC Battery is removed, meter seems to reset every 30 seconds as reported
////-------------------------------------------------------------------------------------
15/05/23
Have received two meters from Rohit on 13/May/23, delivered by Dilip at Emerald Bay

Meter code that is being sent to EEPL have the following settings

CC-RL(Build Tool)->Property->Link Options->Device

	Set enable/disable on-chip debug by link option	NO
	Set debug monitor area													NO
	Set user option byte														Yes(-USER_OPT_BYTE)
	User option byte value													7E39E0
	
For the Bidir meter code the production file has been renamed to production1.hex

Now will rebuild by enabling the on-chip debug

CC-RL(Build Tool)->Property->Link Options->Device

	Set enable/disable on-chip debug by link option	Yes(-OCDBG)
	Option byte value for OCD												84
	Set debug monitor area													Yes(-DEBUG_MONITOR)
	Set user option byte														Yes(-USER_OPT_BYTE)
	User option byte value													7E39E0
	
Building again
The files are slightly different towards the end

Will now program the meter - with ac power turned off

13:22
Was able to proram the meter after some difficulty
A temporary copy(40) is being saved to preserve this state, before making any further changes

13:25
1)In pravakComm.c -> "ZAP" case the line //		if(calswitch!=0) has been commented. MUST BE UNCOMMENTED BEFORE RELEASE
2)VERNO for both BIDIR and UNIDIR meters has been made 00

Following changes will be made
1) If from time > to time, then NO SWAPPING is to be done - simply return	-	OK
2) Case Table and response

a)	FromDate>=StartDate				ToDate<=EndDate												  Give data FromDate to ToDate				OK
b)	FromDate<StartDate				ToDate<StartDate												No Data															OK
c)	FromDate<StartDate				ToDate=StartDate	  										Give data from StartDate to ToDate	OK
d)	FromDate<StartDate				ToDate>StartDate && ToDate <EndDate			Give data from StartDate to ToDate	OK
e)	FromDate<StartDate				ToDate>=EndDate													Give data from StartDate to EndDate	OK
f)	FromDate=EndDate					ToDate=EndDate													Give data from FromDate to EndDate	OK
g)	FromDate=EndDate					ToDate>EndDate													Give data from FromDate to EndDate	OK
h)	FromDate>EndDate					ToDate=EndDate													No Data															OK
i)	FromDate>EndDate					ToDate>EndDate													No Data															OK
j)	FromDate>StartDate 	  		ToDate<=EndDate													Give Data from Last record before		OK
		&& FromDate=MissingDate																							Missing Date to ToDate  
k)	FromDate>StartDate 	  		ToDate<=EndDate													Give Data from Last record before		OK
		&& FromDate=MissingDate			&& ToDate==MissingDate									Missing Date to ToDate  

Remark on Missing Dates : 
A validDate is a Date which is >= StartDate and <= EndDate available in the Data

If there was no power on a range of validDates, then there will be Missing Dates in that range
(eg: if power was lost on 17/May/2023 and returned on 20/May/2023, then the dates 18/19 will be missing.)
(However, there will be one record of 18/May/2023 00:00 hours which actually corresponds to the last interval
 of 17/May/2023)
 
If a Missing Date(s) is present in the search range, then the last date just before the Missing Date will be sent upto the ToDate.  
(eg : From Date 17/May/2023 16:30 to 20/May/2023 11:00) - assume meter has data from 01/May/2023 to 30/May/2023, but 
power had failed between 17/May/2023 and 20/May/2023) then the following data will be sent

	From 17/May/2023 16:30  to 20/May/2023 11:00 - There will be no data for the dates 18 and 19 May, except one record of 18/May/2023 00:00
	
If a From Date is Chosen as a Missing Date, then the last date just before the Missing Date will be sent upto the ToDate.  
(eg : From Date 18/May/2023 16:30 to 20/May/2023 11:00) - assume meter has data from 01/May/2023 to 30/May/2023, but 
power had failed between 17/May/2023 and 20/May/2023) then the data will be sent

	From 18/May/2023 00:00  to 20/May/2023 11:00 - There will be no data for the dates 18 and 19 May, except one record of 18/May/2023 00:00

18:42

The load survey selective access is now working fine

Will work on the daily log tomorrow


////-------------------------------------------------------------------------------------
12/05/23
The find_num_between_lp_entries functions has been rewritten using binary search
One small change in Unidir Display file in display_Third function has also been made
The LAG symbol has been turned on in the display of kvarh_lag in high resolution display
No change being done to Daily Log at present
Will send test code for both unidir and bidir meters
////-------------------------------------------------------------------------------------
03/05/23
This folder produces hex file EEPL3P_PCB_VER2_5_GUJARAT_BIDIR_FACTORY_VER_038
A Copy(39) is being saved before making any changes

Shubham has come up with the following bugs:
Email of 27 Apr 2023
1- In block load meter is meter is showing leakage power factor at voltage only.( Pf - 0.01, 0.03) 
2- After erasing meter data if we check selective access in block load, it is showing the first entry of block load 
	but if meter has one day data with load then it is working ok.
3- After Roll over in daily load, if we select date from 1 april to 5 april in selective access then it is providing
 	2 april to 6 april.
4- Meter also hangs in some cases

After investigation and discussion following issues emerged

1) Problem occurs when meter as just one day's data (current day) and selective access is performed on block load
2) If there is more than one day's data then the problem is not observed
3) If start date is earlier than earliest date, then the earliest date is picked up, but if end date is greater than date
   in meter then meter seems to hang - it probably is earching through all the entries, which may actually not be there
	 This is a loopcount issue
	 
4) In an overflow situation, when the blockload and daily load storage has overflowed, then selective access in block load wroks fine
	but selective active in daily load provides dates which are shifted by one day.
	
Certain problems are arising because of the check applied on loopCount
1) loop_count is being compared with NO_OF_DAYS_SURVEY_DATA - this is true only on buffer overflow and a different value
	must be used if there is only partial data
2) secondly after the range_start_entry has been found, the search for the range_end_entry must account for the limiting value
	imposed on the loopCount.
3)	while decrementing the pointers, we should account for the difference between overflow and nooverflow condition
4)	In the computation of average values for voltage, current and pf, the metering library functions are being called
	instead getInstantaneousParams should be called as this function accounts for all the singular points and special cases




////-------------------------------------------------------------------------------------
16/03/23
Production release code Version 38 for Gujarat Bidir Whole Current Meter PCB Ver 2.5
The display, tampers and e2rom address files have been chosen as per project_files.txt

14:03
EEPL3P_PCB_VER2_5_GUJARAT_BIDIR_FACTORY_VER_038 zipped file is being sent

////-------------------------------------------------------------------------------------
03/03/23

11:00 at Greater Noida
Gujarat LTCT meter code is being regenerated to account for difference between the last code sent in Nov 2022
Changes in the display file->EM_RTC_DisplayInterruptCallback() have been implemented
All other changes were in common code
Hex file being sent
11:21
EEPL3P_GUJARAT_LTCT_UNIDIR_VER_00_03_Mar_2023 being sent.

////-------------------------------------------------------------------------------------
24/01/23
A Copy(38) is being saved to preserve the release version 37

*****************************************************************************************
*																																												*
*				WE NEED TO MAKE CHANGES IN ALL OTHER DISPLAY FILES TO ACCOUNT FOR THE						*
*				STICKY OR STUCK PUSHBUTTON WHICH CAN DRAIN THE BATTERY AND ALSO THE 						*
*				THE FEATURE WHICH TURNS OFF THE VCC-2 FOR UART FUNCTION AFTER INACTIVITY				*
*				OF 2 MINUTES TO CONSERVE THE BATTERY																						*
*																																												*
*****************************************************************************************
////-------------------------------------------------------------------------------------
23/01/23
Search string "what happens if the key is stuck"
Code has been added in EM_RTC_DisplayInterruptCallback located int em_display_Gujarat
to account for stuck keys

It may be advisable to shift the following functions to the common area
void KEY_40msInterruptCallback(void)
void EM_RTC_DisplayInterruptCallback(void)
void CommunicationTimeoutCheck(void)
void handleKeyLogic(void)
void KEY_PollingProcessing(void)

Not being done right now - we need to assess the impact on the main display file if any

10:40
Sending the hex file to Gaurav

11:33
Spoke to Gaurav who has tested the functionality and it is working as desired

In power off mode, 
(a) If the button gets stuck in the pressed condition, then meter goes in UART mode,
		allows downloading, and once there is no further communication, then with a timeout of 120 seconds
		the VCC-2 is turned off - ALSO the meter remains in the VCC-2 off condition, if the button remains pressed
		
(b) Above condition is rectified, if and only if the button is Un-stuck by user, else downloading can not be 
		performed, and VCC-2 remains off
		
In power on mode,
(a) If the button gets stuck or remains stuck, then meter display scrolls rapidly once every second
		Allows user an opportunity to rectify the situation
		
will now send a Production release version no 37
File name is EEPL3P_PCB_VER2_5_GUJARAT_UNIDIR_FACTORY_VER_037

11:51 will now email the production code - DONE, actual email sent on 24/Jan/23 10:09 hours
		
////-------------------------------------------------------------------------------------
21/01/23
11:40
Need to release Production code for Gujarat Unidir
Noted one problem though
We have fixed the turning off of the UARTS once communication has been completed
However, if the pushbutton is stuck, then it will keep going into sleepCommMode
Hence we need to have a system so that if the key is stuck in th pressed position it
does not work the second time, till the key has been released / unstuck
This point is pending - have not been able to talk to Rohit yet
////-------------------------------------------------------------------------------------
18/01/23

In powermgmt, the wait time for turning display off has been made 5 minutes - 300 seconds - PLEASE UNDO
In turnOff_UARTS, SAUEN0 and SAUEN1 have been commented

11:00
Hex file sent
Seems to be working fine

11:22
In powermgmt, the wait time for turning display off has been restored to 18 hours


////-------------------------------------------------------------------------------------
17/01/23
A Copy(37) has been saved - This has been necessitated owing to following:

Shubham reports increased current consumption in power off mode, when light shines on the 
optical ports
We need to determine if VCC-2 is being switched off or not
Also when communication in power off is turned on by a long press of the key
then current consumption increases from 40 microamps to 1700 microamps
When comunication timeout occurs current falls back to 40 microamps in LCD on during power off mode
However when light shines on optical port current increases to around 180 micoramps
This is current cause of current and needs to be investigated

12:28
This folder produces files which match release versions 35 and 33 which have been verified now

We are setting P57 to 1 when we enter Mode3 in powermgmt.c - Change is marked 17/Jan/2023
This will be commented - and P57 will be set to 1 only when long key press is there

A Test code for Gujarat Unidir meter is being sent - Version 00 for PCB 2_5


14:48
Every time a byte is received sleepCommModeTimer is made 0
Now every time a byte transmission is completed then the PVK_TX_Complete() function is
called and there also sleepCommModeTimer is made 0 - Change is marked 17/Jan/2023

Now when sleepCommModeTimer reaches count of 120, then we will turn VCC-2 off

sleepCommModeTimer is now being made 0, whenever a byte is received or whenever a byte has been sent in pravakComm.c

15:12
A second hex file is now being sent
////-------------------------------------------------------------------------------------
23/12/22
Another code for PCB Version 2.3 will now be generated for unidir
Also Code for Bidir Meter for PCB versions 2_5 and 2_3

Zipped Hex files for following three codes being sent

EEPL3P_PCB_VER2_3_GUJARAT_BIDIR_FACTORY_VER_036
EEPL3P_PCB_VER2_5_GUJARAT_BIDIR_FACTORY_VER_035
EEPL3P_PCB_VER2_3_GUJARAT_UNIDIR_FACTORY_VER_034
////-------------------------------------------------------------------------------------
14/12/22
Copy(34) of this code was used to send Production releases 31 and 32
Need to release the Gujarat Unidir code to correct the CLRCVR cumulative tamper count decrementing bug
as discovered during MVVNL meter development
Version No 33
Gujarat Unidir
#define GUJARAT_UNI_DIR_METER
	Display File 	:	em_display_Gujarat
	Tamper File		:	tampers.c
	e2rom_adds		:	e2rom_adds.h
	Version No 	: 33
	PCB Version : 2.5

09:51
Hex file sent 
////-------------------------------------------------------------------------------------
10/12/22
Over current tamper protection is not showing in display
Hex File being sent

In CLRCVR function the variable mytmprdata.tamperCount is NOT BEING decremented anymore
since when the cover tamper occured the mytmprdata.tamperCount was NOT incremented
DONE
Hex file being sent for MVVNL sample meters

#define PVVNL_UNI_DIR_METER
	Display File 	:	em_display_MVVNL.c		// for MVVNL board	
	Tamper File		:	tampers_PVVNL.c
	e2rom_adds		:	e2rom_adds.h

////-------------------------------------------------------------------------------------
09/12/22
Hex code for MVVNL sent

Tamper logic has been modified as per requirement
Switching from porudction to user mode causes display to scroll at 2 second intervals
This bug is fixed in powermgmt by checking the jumper and if in user mode then forcing
the autoscroll interval to 10 for user mode
////-------------------------------------------------------------------------------------
06/12/22
There is a requirement to provide code for MVVNL board
Is this similar to PVVNL, DVVNL etc (?)
We will use the PVVNL option

MVVNL code being sent (PVVNL_UNI_DIR_METER)  - have checked display and tamper conditions - seem to be ok
////-------------------------------------------------------------------------------------
21/11/22
This folder has been sourced from Copy(36)
We will continue to make the BIDIR LTCT METER where the tod will have only six zones
Before making any further changes, this folder compiles to produce EEPL3P_GUJARAT_LTCT_UNIDIR_VER_00_17_Nov_2022_1356._hex

12:36
A new hex file for Bidir LTCT meter has been sent with only SIX TOD zones

Building the following four files

Gujarat Bidir LTCT	em_display_Gujarat_bidir_ltct, tampers_Gujarat_bidir_ltct, e2rom_adds_GUJARAT_LTCT_UNDIR - DONE
Gujarat Unidir LTCT	em_display_Gujarat_unidir_ltct, tampers_Gujarat_unidir_ltct, e2rom_adds_GUJARAT_LTCT_UNDIR - DONE
GUJARAT_BI_DIR_METER em_display_Gujarat, tampers, e2rom_adds - DONE
GUJARAT_UNI_DIR_METER em_display_Gujarat, tampers, e2rom_adds - DONE

First file mailed at 12:36
Remaining three files mailed at 15:10
////-------------------------------------------------------------------------------------
17/11/22
EMail of 16/Nov/22
Point number 1 in previous mail of 10 Nov is pending (while going forward Meter showing Bill MD KWAh OP in  place of 
maximum Demand of previous month in KVA) but you provide KW in place of KVA in the latest file 15 Nov.

This has been fixed

If bidir meters are to have 8 zones then, MAX_APDU_BUFFER_SIZE is to be increased from 768 to 896 to accommodate
the larger billing buffer

11:09
A hex file for Unidir LTCT meter has been sent
Will now make changes for the Bidir LTCT meter
A Copy(36) is being saved for reference

The hex file for Unidir LTCT meter sent at 11:09 was built using tampers_Gujarat_bidir_ltct.c
13:56
The hex file is being sent again this time being built with tampers_Gujarat_unidir_ltct.c
////-------------------------------------------------------------------------------------
16/11/22
We are doing away with SIXZONES for all types of meters
All meters will now have Eight time zones 
For Gujarat regular Bidirectional meters, onw will need to make the changes in the display file for the offset values
////-------------------------------------------------------------------------------------
15/11/22
A unidir hex file for unidir ltct meter has been sent today with the calibration imax current set at 20A.
Will continue working on bidir ltct meter  
////-------------------------------------------------------------------------------------
14/11/22
Email feedback of shubham on 10/Nov/2022

1-In Push button (Mode-2)-
A> Point number 24 of display parameters-  
a> while going forward Meter showing Bill MD KWAh OP in  place of maximum Demand of previous month in KVA.
b> While going backward on the same parameter, Meter shows Bill MD KWh in  place of maximum Demand of the previous month in KVA.   

B> Point number 42 of display parameters-
a>  while going forward Meter showing Cum MD KWAH OP in place of  Fundamental KWH.
b> While going backward on the same parameter, Meter shows KWH An.

2- In High resolution Mode (Mode-3)-
a> Lag word missing in Kvarh lag parameter.

DISPLAY_AUTO_ON_IN_POWER_OFF_MODE has been uncommented

Currents measured at 90 and 270 were not appearing correctly. This has been corrected in getInstantaneousParams

09:30
Above five changes have been implemented - new hex file not sent to Shubham as of now

Will also work on bidir version
Before doing that we need to do something about the #define BIDIR_METER - Ideally this should be used only in those places
where there is a distinction between a Bidir and a unidir meter

Is the burden resistor different for Bidir LTCT meter
Why is CHECK_CAL_CONDITIONS turned OFF for LTCT meter
How is the calibration performed for LTCT meter - cal point seems to be 240V, 10A?
What is the max current for LTCT meter - Magnet Imax value seems to be 10A
////-------------------------------------------------------------------------------------
10/11/22

Plenty of changes made

14:28 Hex file for LTCT Gujarat Unidir meter sent.
////-------------------------------------------------------------------------------------
09/11/22

Preparing to build Gujarat LTCT UNIDIR and Gujarat LTCT BIDIR meter code

For Unidir

Load survey is same
TOD settings are same
Tampers are same
Display sequence is different

////-------------------------------------------------------------------------------------
08/11/22
09:29
Hex file for Gujarat Bidir being sent 

A Copy(35) is being saved.


////-------------------------------------------------------------------------------------
07/11/22

We had made changes for CLASS22 - it was required to be done for Class20

(c)	Class 22 billing - immediate(?)
		g_Class22_billtype was = SINGLE_ACTION_1_TIME_WILDCARD earlier /* Size of execution_time = 1; wildcard in date allowed */
		This has been changed to SINGLE_ACTION_N_TIME,					/* Size of execution_time = n; timevalues may be different, wildcards in date not allowed */
		
Earlier option has been restored
		g_Class22_billtype = SINGLE_ACTION_1_TIME_WILDCARD 


The change is required for CLASS_20
Required changes have been made - Certain classes including class 20 have action features whereby methods exposed by
the class may be invoked - For the class the method is R_OBIS_Class20_Activate_PassiveCalendar
This method is called from two places -
(a) One is when the passive data has been written by user and activation date and time has been set by user and
		in R_OBIS_MeterDataProcessing, the current time is equal to or greater than the time given
(b) When the user invokes the activate_passive_calendar method directly with a data value
		In our implementation, the data value is ignored but if the activation of method 1 is required then the
		R_OBIS_Class20_Activate_PassiveCalendar is called
		
In both these cases, now, a bill is generated, passive tod is transferred to active tod and a transaction event is recorded
If user has programmed the passive tod values, and provided an activation date time, and in addition also invokes the
active passive calendar method, then two transaction events will be generated - the first one for the immediate invocation
and the second one when the programmed date and time is reached- It is apparent that the second one will not cause any
change in the active tod data as the passive data would have been copied into the active data when the method had been
manually invoked		

////-------------------------------------------------------------------------------------
04/11/22
Hex file for gujarat bidir had been sent yesterday
We will need to roll back the changes made to e2rom storage for tampers and load survey for bidir meter - DONE
Also attend to feedback provided by shubham

We have restored the e2rom settings for number of tampers, load survey is now for 62 days

Points No 14 and 15 have been addressed

1358 
Hex file generated and being sent

Two points remain
(a)	When load survey interval is being changed, the initial record has energies zeroed, but instantaneous values
		are appearing - Also export energies if any are to be zeroed too.
(b)	The zero power case needs to be handled for rising demand which is a common window for both export and import
		Also for export case, the rising demand is not being shown
(c)	Class 22 billing - immediate(?)
		g_Class22_billtype was = SINGLE_ACTION_1_TIME_WILDCARD earlier /* Size of execution_time = 1; wildcard in date allowed */
		This has been changed to SINGLE_ACTION_N_TIME,					/* Size of execution_time = n; timevalues may be different, wildcards in date not allowed */
		I think this option implies that date and time have to be provided

////-------------------------------------------------------------------------------------
02/11/22
Shubham's observations sent by email

1> 	In Auto mode display parameter, Meter running at load then Rising demand in KW with elapsed time showing Import 
		but while load off(Means Meter run in Voltage only) then Rising demand in KW with elapsed time start showing Export.

2> 	Default Time zone of TOD is not showing according to TS. DONE

3>  Cum MD in Import KW in auto mode showing with 3 decimal but the same parameter that is required in repeated after every 
		parameters in auto mode is showing without decimal. ALL PARAMETERS ARE WIHTOUT DECIMAL
		 
4>	In auto mode display parameter Remaining hours parameter display flicker. DONE 

5> 	In dlms Energy of KWH, KVAh, Kvarh lag and lead is not updated during running load. 
		I checked for 1 kwh but still did not update. OK

6> 	After Change IP of Load survey from 900 to 1800 - Meter erase previous block load data but update first entry in block load.

7> 	While changing TOD zone according to given Specs then All zone energy increases correctly in DLMS but 
		IN display it is showing wrong w.r.t technical specs. - DONE

8> 	Programmable TOD Activate passive calendar through Execution – Execute successfully but Billing and transition is not showing. 

9> 	Non solar display energy is not updated at 0.1kwh increment but while parameter scrolling then it will update. - DONE

10>	According to specs, other events (Transition + other) are given 100 (Occ + Rest) but in our meter they have 60 total. 
		Please add event 50 for transition events and 50 for other events.	DONE and then UNDONE

11> RTC Set Last month of day and time 23:59 then Write operation failed message showing in DLMS but in Meter RTC set successfully.

12> While Cover open is in push mode at power on time then C-Open is not showing on display but tamper record.

13> According to specs- C-open should be displayed in power off and power on both condition and display should be stuck. 
		However, KWH reading shall be accessed by push button. After 5 min again display should be stuck & C -open should 
		only be displayed in display but in our meter while using push button meter shall not showing C-open after five min.

14> Kvarh lag, Kvah and Kwh energy Import and export is not updated during running load.
15> Check at 90 degree- In this case Energy energy is increasing in Export mode ok but it is showing in Lag quadrant 
		but as it is bidirectional meter, if we increase energy in export mode then it will increase in lead quadrant 
		(2nd quard) at 90 degree case   OR if we increase energy in Import side then we have to increase in Lag quadrant at 90 degree.

In CTCT meter, Please add these OBIS Given Below in Block load according to IS 15959 part 1 and also IS attached in the given mail.



////-------------------------------------------------------------------------------------
27/10/22
A Copy(34) is being saved before making any further changes

Rohit wants the image files for Gujarat Unidir - For PCB Version 2.5 and 2.3

1) 	Need to send a boot image for factory version 31 (PCB VERSION 2_5)
		Built with Version number 31, and matched with hex file - DONE
		Will now change it to produce mot files in both project and sub project - DONE
		Change the merge.txt file - DONE
		Clean and Rebuild
			phase, production, rl78i1c and BootCode mot files have been generated - DONE
		Clean Desktop->Bootstuff folder - only mot2bin should be there - DONE
		Copy phase mot file to Desktop->Bootstuff folder - DONE
		Drag and hover phase mot file over mot2bin - this produces phase.bin - DONE
		Open bin file with hex editor
		Delete the blank tail end of the bin file - DONE
		Rename it as EEPL3P_PCB_VER2_5_GUJARAT_UNIDIR_IMAGE_VER_031._bin

2) 	Need to send a boot image for factory version 32 (PCB VERSION 2_3)
		Built with Version number 32, and matched with hex file - DONE
		Will now change it to produce mot files in both project and sub project - DONE
		Change the merge.txt file - DONE
		Clean and Rebuild
			phase, production, rl78i1c and BootCode mot files have been generated - DONE
		Clean Desktop->Bootstuff folder - only mot2bin should be there - DONE
		Copy phase mot file to Desktop->Bootstuff folder - DONE
		Drag and hover phase mot file over mot2bin - this produces phase.bin - DONE
		Open bin file with hex editor
		Delete the blank tail end of the bin file - DONE
		Rename it as EEPL3P_PCB_VER2_3_GUJARAT_UNIDIR_IMAGE_VER_032._bin

11:55 email the image files - DONE

Restoring to regular intel hex

16:17 hours - Rohit wants Gujarat Bidir code

Record of changes made in Unidir code - These changes go back to Aug 2022
There are too many of them - hence we will need to account for them one at a time

////-------------------------------------------------------------------------------------
17/10/22
07:51
Three files are being sent now
1) EEPL3P_PCB_VER2_5_LTCT_METER_VER_00_17-Oct-2022
2) EEPL3P_PCB_VER2_5_GUJARAT_UNIDIR_FACTORY_VER_031
3) EEPL3P_PCB_VER2_3_GUJARAT_UNIDIR_FACTORY_VER_032

07:58 SENT - done
////-------------------------------------------------------------------------------------
16/10/22

We need to send 

1) Gujarat Unidir file - for Factory Production Release
EEPL3P_PCB_VER2_5_GUJARAT_UNIDIR_FACTORY_VER_031
EEPL3P_PCB_VER2_3_GUJARAT_UNIDIR_FACTORY_VER_032

2) LT CT meter file for submitting sample
////-------------------------------------------------------------------------------------
13/10/22
This folder builds to produce EEPL3P_PCB_VER2_5_LTCT_METER_VER_00_12-Oct-2022.hex

09:33
Hex File being sent for Gujarat Unidir too Version 00 - SENT

		***************************************************************
		*	ONE OBSERVATION OF CUMULATIVE KWH NOT MATCHING THE ENERGIES	*			
		*	OF ALL TOD ZONES REMAINS PENDING														*
		***************************************************************


16:31
Shubham reports that once tampers overflow then the transmitted data starts from entry 1 instead of entry 0
The reason is that g_Class07_Event_CurrentEntry[group] is being set to 1, if there is an immediate overflow
This is being corrected

This was happening at two places
- In init_read_tamper_data() and in wre2rom() - CORRECTED AT BOTH PLACES

16:43
Hex file created and being sent - DONE

////-------------------------------------------------------------------------------------
12/10/22
This folder builds to produce EEPL3P_PCB_VER2_5_LTCT_METER_VER_00_10-Oct-2022

A Copy(33) is being saved before making any changes

08:38

Yesterday on 11/10/22 during the testing of the LTCT (POINT FIVE CLASS) meter, the problem
of multiple tampers having the same occurrence and restoration time was reported
CSV files of MAgnet tamper log and Power off On tamper log were also sent
It was noted that a power failure occurred at 13:07:06 and was restored at 13:53:58
Also in this duration all the tampers had the same occurrence and restoration time viz 13:07:06

ONE OBVIOUS REASON IS THAT THE CLOCK HAD STOPPED RUNNING

***********************************************************************************************
*	HYPOTHESIS																																									*			
*																																															*
*	When power fails we conduct the rtc battery test, in which we disconnect the battery backup	*
* supply. We wait for a few seconds and if the battery has failed we stop the rtc, update the	*
*	time from a previously stored value, and then start the rtc again. It is possible that the	*
*	rtc fails to start, and hence the time remains the same. The rtc may get restarted later at	*
* another power failure, battery test and recovery event(?)																		*
*																																															*
* We also need to determine if the clock stops running then how is the one second interrupt		*
* generated, if at all it is generated - FOOD FOR THOUGHT AND POSSIBLE BUG FIX								*
*																																															*
***********************************************************************************************

09:03
Need to start investigating the rtctest functionality
If power returns while the test is being performed, the recovery and ensuring that the clock is
working needs to be ensured
A regular check on the rtc operation may be desirable

a)	When power is there, the one second interrupt EM_RTC_DisplayInterruptCallback() is called by the
		r_cg_tau_user.c->r_tau0_channel3_interrupt routine
b)	The EM_RTC_DisplayInterruptCallback() located in the respective display files (eg em_display_Gujarat)
		sets perSecondFlag to 1
c)	The emeter3_app.c->per_second_activity() checks the perSecondFlag and if it is 0 then it exits without
		doing anything - else the perSecondFlag is cleared and things required to be done every second are done
		WE CAN ADD A CHECK HERE TO SEE IF THE RTC IS ACTUALLY INCREMENTING OR NOT 
 																							

12:50 or so

Shubham reported that the multiple tampers with same time for occurrence and restoration was found once again

He also reported that the rtc was actually running and the time on LCD display was actually incrementing
This meant that the hypothesis of the clock stopping was not true

	*********************************************************************************************
	*																																														*
	*															BUG DISCOVERED & FIXED																				*
	*																																														*
	*********************************************************************************************
	*	In the readRTC function, if rtcTestFlag was 1, we were returning without reading the RTC	*
	*	Hence rtc always contained the last time that it had been read, which was kind of the last*
	*	time that power failed and the rtc battery check test was performed in Mode3							*
	*	While the test was being performed, if power was restored during the 5 second interval of	*
	*	the test, the rtcTestFlag would remain 1 in power on conditions. Thus the power failure		*
	* duration would be 0 and the power fail & restoration event would not get registered. At		*
	* the same time all readRTC would keep returning the same value															*
	*																																														*
	*	THIS PROBLEM HAS BEEN FIXED																																*
	*		(a)	Now readRTC does not check the rtcTestFlag 																					*
	*		(b)	Whenever power returns, ie we are in mode1, if the rtcTestFlag is 1, it is made 0		*
	*		(c) Additionally, per_second_activity is executed only in Mode1													*
	*		(d)	Finally a check has been added in per_second_activity to ensure rtc is running			*
	*				and if it stops for any reason, then a RTC_IS_STOPPED flag is set which causes			*
	*				the rtc to be restored with the ctldata time																				*
	*		NOTE : It may be a good measure to add 15 minutes (mid value) and then store it to the  *
	*						rtc, to statistically account for the random rtc stop event	- FOOD FOR THOUGHT	*
	*																																														*
	*********************************************************************************************
							 
14:18	The corrected hex file with above implementation was sent for LTCT (POINT_FIVE_CLASS) meter

15:53	ROHIT'S MAIL - Request to send the code for Gujarat Unidir too

////-------------------------------------------------------------------------------------
10/10/2022

POINT NO 1
	Changes have been made in powermgmt.c->POWERMGMT_PollingProcessing()
	If power is there and appears to go, then we are now counting till 1000 before switching
	to MODE2

	Also in rtc test the function setRTC_Date_Time has been renamed to restoreRTC_Date_Time
	and the R_RTC_Get_CalendarCounterValue() is not called as the time is being restored
	from the earlier read value of rtc
	
	The clearPersistenceCounters() is now called only for genuine power failures which are
	actually recorded, i.e. greater than 5 seconds		

POINT NO 2
	Key pressed counter time is being reduced from 400 ms to 100 ms
	All the persistence counters fwdKeyPressedCtr, revKeyPressedCtr and bothKeysPressedCtr
	are now being checked against small values
	
	*****************************************************************************
	*																																						*
	*			ABOVE ACTION / CHANGE HAS BEEN MADE ONLY IN GUJARAT DISPLAY FILE			*
	*						MAY BE REQUIRED TO BE CHANGED FOR OTHER BOARDS TOO							*
	*																																						*
	*****************************************************************************

POINT NO 3
	Likely taken care of in Point 1
	
POINT NO 4
	Cumulative kwh is NOT = sum of TOD KWHs
	Some changes made, but not satisfied yet	
	
POINT NO 5
	BOOTLOADING FROM BOTH PORTS - not done yet

POINT NO 6
	Implemented changes for POINT_FIVE_CLASS_METER

11:02 
Hex file for Gujarat Unidir (Ver 00) sent

15:30 
Gaurav has informed that the buttons are operating very fast - the keys had become overly sensitive
One has slowed down the same, counts are now being compared with 4 instead of 1
Also if a key is not pressed its counter is being zeroed

The changes having made, now this code will not produce the hex file of 11:02 hours

Sending hex file for LT CT meter - sent



	
////-------------------------------------------------------------------------------------
09/10/2022
This folder produces the following hex files as per appropriate Board settings
a)	EEPL3P_PCB_VER2_5_LTCT_METER_VER_00_01-Oct-2022 and
b)	EEPL3P_PCB_VER2_5_GUJARAT_UNIDIR_FACTORY_VER_030

A Copy(32) is being saved to preserve this state, before making changes as per 06/10/2022


	In the r_cg_lvd_user.c->r_lvdexlvd_interrupt() the POWERMGMT_AC_InterruptCallback() is called
	Hence the moment EXLVD pin goes below threshold, this interrupt is generated
	
	In the POWERMGMT_AC_InterruptCallback(), if EXLVD VOLTAGE < DETECTION THRESHOLD
	then g_powermgmt_flag.is_ac_low = 1
	
    if(LVDEXLVDF == 0)    //EXLVD VOLTAGE > DETECTION THRESHOLD
        g_powermgmt_flag.is_ac_low = 0;
    else 
        g_powermgmt_flag.is_ac_low = 1;
				
	IS THIS INTERRUPT CALLED REPEATEDLY OR IS IT AN EDGE DETECTION - THINK IT IS AN EDGE DETECTION 

////-------------------------------------------------------------------------------------
06/10/2022
Visited G Noida today - picked up rohit on the way

Following is summary of observations noted in Gujarat Unidir meter during prototyping

1) Multiple tampers have same occurrence and restoration times

*************************************************************************************
*																																										*
*	There is a feature in our software which resets all the persistence counters when	*
*	power is switched off. This implies that if there were say three tampers which had*
*	occurred at say 9:00:00, 9:01:00, 9:02:00 with five minutes persistence then their*
* occurrences would have been saved as 9:00:02, 9:01:02 and 9:03:03 respectively		*
* Now assume that the power was switched off at 9:03:45. At this time all the per-	*
* sistence counters would have been zeroed. Assumed that the tamper persisted, ie		*
* the magnet remained applied during the power off interval, then when the power 		*
* would have returned at say 9:06:21, then all the earlier tamper persistence ctrs	*
* would start counting from 0, and when they became 2 seconds, their occurrence			*
* time would be recorded as 9:06:23 for all the tampers. This synchronisation has 	*
*	been forced because the initial values of the persistence counters had been lost	*
* and the tampers now all started at the same time, when the power returned.	A			*
*	similar reasoning could also explain why the restoration times were also same			*
*																																										*
*	Some of the power failures are genuine as the power may have been deliberately or	*
*	unknowingly lost when a tamper had just begun or was just about to end. In these 	*
*	by virtue of having lost the persistence counts, which would now begin from 0, all*
* the occurences and restorations would be having the same time, which would be two	*
*	seconds after the power was restored. 																						*
*																																										*
*	THIS IS NOT A BUG BUT AN OUTCOME OF IMPLEMENTING A USER DESIRED FEATURE						*
*	THIS CAN NOT BE CORRECTED BY ANY MEANS, AND NEEDS A WARNING TO THE USER						*
*																																										*
*	There is however a situation where a glitch on the power line may be treated			*
* as a power fail signal (EXLVD interrupt) - THIS IS NOT DESIRABLE AT ALL						*
*																																										*
*	IT IS THEREFORE DESIRABLE THAT FOLLOWING SHOULD BE DONE	:													*
*																																										*
*	1) THE VOLTAGE LIMIT FOR POWER FAIL DETECTION SHOULD BE LOWERED										*
*																																										*
*	2) THERE SHOULD BE A PERSISTENCE IN ENTERING MODE4 STATE - THIS MAY INCREASE			*
*		 BATTERY CURRENT CONSUMPTION DURING ACTUAL POWER FAIL EVENT, BUT WOULD BE				*
*		 USEFUL IN PREVENTING FALSE POWER SHUTDOWNS OWING TO GLITCHES IN EXLVD					*
*																																										*
*																																										*
*************************************************************************************

2) Pushbutton (Up) becomes non functional in power On mode - works fine in power off
		"Became OK through hardware reset"
		
*************************************************************************************
*																																										*
*	THE PERSISTENCE TIME FOR KEYS BEEN PRESSED SHOULD BE REDUCED TO 100 milliseconds	*		
*																																										*
*************************************************************************************
		
3) Power fail was recorded when multiple tampers had same occurrence and restoration times

*************************************************************************************
*																																										*
*												SEE THE EXPLANATION TO POINT NUMBER 1												*		
*																																										*
*************************************************************************************


4) Total KWh != sum of TODs (zone wise)
		In fact total kwh was less(?) 
		SOME CHANGES HAVE BEEN MADE - BUT ONE IS NOT TOTALLY SATISFIED
		
*************************************************************************************
*																																										*
*	THIS IS SOMETHING THAT REQUIRES INVESTIGATION																			*		
*																																										*
*************************************************************************************

5) BOOTLOADING TO BE PERMITTED FROM EITHER PORT (RJ11 recommended)

*************************************************************************************
*																																										*
*	ROHIT MUST BE INFORMED ABOUT THE SIGNAL LEVELS ON THE ISOLATED UART PORTS WHICH		*
* IS APPLICABLE FOR BOTH OPTICAL PORT AS WELL AS RJ11 PORTS													*
*	THIS IS SERIOUS BECAUSE FAILURE IN DOWNLOADING MAY NOT ALWAYS BE RECOVERABLE			*		
*																																										*
*************************************************************************************

6) ADDITIONAL REQUIREMENTS FOR CLASS POINT FIVE METER

	a)	Meter Type (0.0.94.91.9.255) is showing 4 but it should be 3.
	b)	Meter Current rating (0.0.94.91.12.255) is showing 10 – 60 A but it should be (5-10 A)
	 		according to LT CT meter rating.
		
////-------------------------------------------------------------------------------------
03/10/2022

Behaviours noted during inspection

1) Sometimes in autoscroll after display frequency meter returns to state 0, 
		Lamp Test (display segment check)

2) Pushbutton is hard or not working
		In the KEY_PollingProcessing() which is called every 40 ms
			We are already comparing currentSW with prevTopSW to set the fwdKeyPressed=1
			Same is being done for middle sw and MD reset switch
			This means that detection takes 40 ms at least
		Subsequently in handleKeyLogic, we have fwdKeyPressedCtr, revKeyPressedCtr and bothKeysPressedCtr
		which are being compared with >10, >10 and >25 respectively before action is taken
		HENCE IF ALL IS OK it may take greater than 400 ms for a switch to have effect
		PROBLEM IS NOT ENCOUNTERED IN BATTERY MODE
		
		***************************************************************************
		*																																					*
		*	THIS IS DEFINITELY A HIGHLY SLUGGISH KEY PRESS DETECTION AND FOR CASES	*
		*	WHERE THE SWITCH IS NOT GOOD FOR SOME REASON WILL MAKE IT IMPOSSIBLE 		*
		*	FOR THE SWITCH TO WORK																									*
		*	THE CHECKING VALUES FOR fwdKeyPressedCtr, revKeyPressedCtr and 					*
		*	bothKeysPressedCtr SHOULD BE REDUCED TO SAY >1, >1 AND >5								*
		*																																					*
		*	DEFINITELY NEEDS TO BE ADDRESSED URGENTLY ACROSS ALL BOARDS							*
		*																																					*
		***************************************************************************
			
		 
////-------------------------------------------------------------------------------------
01/10/2022

09:00
1) 	Need to send a boot image for factory version 30
		Have already built a file with this folder and it matches with EEPL3P_PCB_VER2_5_GUJARAT_UNIDIR_FACTORY_VER_030.hex
		Will now change it to produce mot files in both project and sub project
		Change the merge.txt file
		Clean and Rebuild
			phase, production, rl78i1c and BootCode mot files have been generated
		Clean Desktop->Bootstuff folder - only mot2bin should be there
		Copy phase mot file to Desktop->Bootstuff folder
		Drag and hover phase mot file over mot2bin - this produces phase.bin
		Open bin file with hex editor
		Delete the blank tail end of the bin file
		Rename it as EEPL3P_PCB_VER2_5_GUJARAT_UNIDIR_IMAGE_VER_030._bin
09:24
		Zip and email - DONE
			
2) 	Restore settings back to hex file - DONE

3) 	Check the code working for POINT_FIVE_CLASS_METER - BUILD IS OK - NO ERRORS
		MAGNET_IMAX_POWER	2400
		MAGNET_IMAX_CURRENT 10 
		METER_CONSTANT_6400
		
		TOD zone definitions are the same as Gujarat Unidir
		Script ids are now the same as Gujarat Unidir
		Display file of Gujarat Unidir is to be used
		
		Seems to be fine in all respects - Code can be sent
		
After sending the code - revert to Gujarat Unidir
It produces the code identical to the Gujarat factory code of 29/Sep/22
		
 
	
////-------------------------------------------------------------------------------------
30/09/2022
Release 30 had been sent yesterday
09:28
A Copy(31) is being saved - DONE

If backup data is also coorupted, then it may be advisable to set the overflow flags
This will ensure that when load survey is sought, then all the data will be sent

Also a command could be added to set all the overflow flags, which will allow all meter data to be sent

Bootloader needs to work on both UARTs (3-RJ11) and (2-Optical port)
////-------------------------------------------------------------------------------------
29/09/2022

Shubham has sent feedback with data files:
Following is the summary
1)	AC magnet causes reverse tamper to get logged - this is to be inhibited
		REVERSE TAMPER DETECTION NOW INHIBITED FOR BOTH DC & AC MAGNET DETECTION CASES - DONE
		
2)	In magnet case with no load, kwh incrementation is greater than kvah - FIXED

		I THINK THE REASON HAS BEEN FOUND
		In energy_incrementation(), when active power computations are being done, then there
		is a case of checkForVoltageHarmonics and checkForCurrentHarmonics 
		Also the measuredPF is used. For these three calls, the EnergyMeter Library functions
		EM_GetPowerFactor(LINE_TOTAL), EM_GetVoltageTHD(line) and EM_GetCurrentTHD(line) are called
		The computation of these functions are not in our control as they are part of the library
		When there is no current, one has no idea what values these functions will return.
		Additionally WHEN MAGNET AC OR DC IS APPLIED and THERE IS NO CURRENT, THEN THE VALUES
		RETURNED BY THESE FUNCTIONS MAY BE SUSPECT.
		FINALLY, WHEN THESE FUNCTIONS RETURN VALUES OF THD DISTORTION, THEN THE temp_power variable
		is increased by a factor of 1.0815
		DURING computation of apparent power the apparent power is equated to and limited to
		ABS(phase_power_active). However the temp_power used to compute active energy and 
		kwh incrementation could be using values which are greater by a factor of 1.0815
		THIS EXPLAINS WHY IN MAGNET CASES ON ZERO LOAD, THE KWH INCREASES MORE THAN KVAH
		
		CORRECTIONS MADE:
		
		a) 	A local variable modified_temp_power_active has been added in energy_incrementation (UNIDIR)
		b) 	The checkForVoltageHarmonics and checkForCurrentHarmonics are NOT called if Hall sensor or
			 	ac magnet has been sensed
		c)	The checkForVoltageHarmonics and checkForCurrentHarmonics will return 0 (No Harmonics) if
				AC or DC magnet tamper has been logged
				
		MULTIPLE SLEDGE HAMMERS HAVE BEEN USED TO ENSURE THAT THE FLY IS DEAD.
		

3)	In Data corruption case, 
		Case 1: Billing Count becomes 0 and billing information / date etc gets lost - FIXED
		Case 2: Load survey gets made additionally with corrupted time data	- FIXED
		
		BUGS FOUND
		
		Case 1:
		
		IN write_common_data, if the checksum was not correct(why oh why?) the checksum was
		being computed and then saved into ctldata.chksum
		
		EVERY TIME THE Common_Data gets modified, its checksum is not computed, instead
		earlier  the write_alternately function used to be called which computed the checksum
		of the structure as the first step before writing the data at two locations
		
		IN THIS CODE, every time the Common_Data was modified, its checksum was not computed,
		and now the write_ctl_data function was called. In this function if the checksum was
		not correct (now we know the answer to why oh why?), the checksum was calculated but
		unfortunately the result was being stored in ctldata.chksum owing to copy/paste effect
		
		THIS RESULTED IN the checksum of Common_Data being wrong everytime, and the chksum of
		ctldata getting corrupted
		
		Upon reset, since the Common_Data record was written both times with improper checksum
		the Common_Data structure was being initialized, resulting in bpcount always becoming 0
		
		NOW THE BPCOUNT AND LAST BILLING DATE ISSUE SHOULD BE RESOLVED

		Case 2:
		
		write_ctl_backup_data is now being called with a type parameter
		type == 0 when called at midnight , ctldata_backup.survey_wrt_ptr = ctldata.survey_wrt_ptr
		type == 1 when called after zapped case, ctldata_backup.survey_wrt_ptr = SURVEY_BASE_ADDRESS
		
		During recovery of ctldata, the ctldata date time will always be equated to rtc date time
		so that do initial things does not perform any update
		
09:54
All issues have been addressed - Pre final code may be released

Persistence time for all tampers except magnet is now 5 minutes
Persistence time for magnet tampers is 60 seconds

10:00 hours
Test Code being sent		

13:55
Shubham has conducted tests and reports as follows:

1) 	Multiple tampers of magnet are all getting recorded with the same Occurence and restoration
		time of 10:44:46
2)	After ram data corruption test, cumulative_md's have been lost
		WHENEVER A BILL IS MADE THE BACKUP SHOULD BE UPDATED

15:25
Shubham called to say that subsequent tests on multiple tampers are now showing the correct
date and times of occurrences
*****************************************************************************
*																																						*
*		WATCH OUT FOR THE MYSTERIOUS BUG OF SAME TAMPER DATE AND TIME VALUES		*		
*																																						*
*****************************************************************************

Whenever a bill gets made, we should update the cumulative_md values in the backup of ctldata

All the action happens in generate_bill - DONE

3) REMOVE CORRUPTION TEST - #define CTL_FAULT_DEBUG has been commented

16:39
RELEASING CODE VERSION NO 30, BOARD GUJARAT - 36

16:46 Code emailed.


		
////-------------------------------------------------------------------------------------
28/09/2022

1)	In case of AC magnet - rev icon was coming with mag icon - FIXED
2)	Internal pullups for magnet sensor lines - They are already ON 
3) 	Batchmonth, batch year commands have been enabled
4)	ctldata & common data functioning has been made robust
5)	Bootloader on Optical port - pending

powerUpDataCheck which is called when power returns or meter is reset does
validation of ctldata to ensure all is fine

write_ctl_data performs a read after write to ensure that the correct data has been written
this function only matches the values written into rom & read back with the values in the
ctldata structure - it does not bother if the ctldata in ram is itself corrupted

in do_md and survey writing checks have been put for max values not exceeding 72000 for demand
and consumption during an interval rated appropriately

do initial things - limit checks done

CORRUPT command has been added
Batchmonth, Batchyear are being permitted to be changed

11:21 Hex file sent

A Copy(30) is being saved to preserve this code

////-------------------------------------------------------------------------------------
27/09/2022

09:30

Spent the day at Greater Noida on 26/09/2022

Bootloader
A)The Bootloader GUI works and behaves even if no meter is connected - This is a serious defect and needs
	to be fixed by Deep
	If the earlier programming attempt failed, then the bootloader remains active
	This is desirable as it allows the process to be started again
	TO CHECK IF BOOTLOADER HAS SOME RESET FEATURE IN CASE PROGRAM NOT LOADED CORRECTLY
	
	Need to allow Bootloader programming from UART3(RJ11) which is existing as well as
	with Optical Port (UART2)	

INIT command
B)Add batchmonth, batchyear command after the ZAP operation to allow earlier manufactured
	meters to be INITED without changing the batchmonth,batchyear - The process could be 
	automated too.

CTLDATA issue	
C)Need to make ctldata storage and retrieval and data validity more reliable by
	(a) using read after write to confirm data storage - retrying after sometime
	(b) use more than two locations
	(c) save important elements of ctldata at 00:00 hours which can be used for ctldata
			recovery, in case all memory locations have bad checksum
	(d)	verifying ctldata with data stored at 00:00 hours and by any other means
	(e)	verifying ctldata before use
	
OTHERs	
D) Enabling internal pullups for magnet sensing pins - will this affect battery consumption?

E) Cumulative Power Fail duration in hours - Display Mode 2 Last state shows wrong value - DONE
This problem has been fixed in the Gujarat Unidir Display
NOTHING HAS BEEN DONE FOR BIDIR METER OF GUJARAT

DLMS DATA IS SUPPOSED TO BE OK- problem was only in the display
////-------------------------------------------------------------------------------------
25/09/2022

It is very difficult to reconstruct or validate the ctldata
It may be simpler to store four copies instead of two

Wherever, we are writing ctldata, we can set the E2_W_CTLDATA1 and E2_W_CTLDATA2 flags
These additional flags will cause two more copies of ctldata to be written

In init_read_ctl_data, we will read the first two locations, and if they fail, then we
will read from the third and fourth locations - this is the best one can do

When we write ctldata, we can compare that the corresponding fields are greater than
the previously stored ones


////-------------------------------------------------------------------------------------
24/09/2022
This folder produces mot files. It has been used to generate bin files formaking image
files which can be loaded in the meter using the bootloader.

Two deficiencies have been noted
a) Bootloader uses UART3, whereas the optical port is UART2
b) INIT command to clear the meter data without affecting the manufacturing date/month
		is yet to be implemented

////-------------------------------------------------------------------------------------
23/09/2022

09:11
display file tod off peak error is fixed - DONE

RAM corruption command

CTL_FAULT_DEBUG has been uncommented

Extracted from email sent on 27/Dec/2021 - code available in Copy(16) of Source3P_Bootloader
Quote
Please find zipped file attached.
This is test code to verify that high values of MD are not produced, even if critical data 
gets corrupted for some reason.
Testing procedure is as follows
A Command "CORRUPT\r\n" can be sent from the Hyperterminal to cause corruption of critical data.
After this turn power off.
Wait for a few minutes, and then restore power. Meter should function correctly.
Please confirm the test results.
Unquote

10:04 Hex file created for PCB_2_5

10:08 Hex file created for PCB_2_3

Bootloader image file will be sent later

10:16 Both hex files emailed

12:30
Shubham called to say that the meter was going in magnet. Unfortunately both files sent were
identical and they were for PCB_2_3, and he was testing on PCB_2_5

Fresh hex files were sent with new names CORRUPTION_TEST_PCB_VER2_3._hex and 
CORRUPTION_TEST_PCB_VER2_5._hex

16:58
The CTL_FAULT_DEBUG option is now being commented - DONE

We will now generate image files - .mot file need to generated

*****************************************************************************************************
*	GENERATING BIN FILES OR IMAGE FILES																																*
*																																																		*
*	To generate mot files one needs to goto CC-RL (Build Tool) for rl78i1c project and change					*
*	the Frequently Used for Hex Output to Motorola S-record file																			*
* A similar change is required to be made by going to CC-RL (Build Tool) for BootCode (Subproject)	*
*																																																		*
* Having done this one needs to change the merge.txt file in \Source3P_BootLoader\Application				*
* Reference files for merge.txt are provided as merge_intelhex.txt and merge_motorola.txt						*
*																																																		*
*	After this the project can be cleaned and rebuilt	- Following will be the output files						*
*	production.mot, phase.mot, rl78i1c.mot and BootCode.mot																						*
*																																																		*
*	Only the phase.mot is required to produce the image or bin file which needs to be bootloaded			*
*	from 0x04000 address onwards																																			*
*																																																		*
*	To convert a mot file to a bin file, copy the mot file to the folder on the desktop called				*
*	BootStuff; There is a mot2bin.exe application in the folder. Pick the bin file and hover it over	*
* mot2bin.exe - This action will cause a bin file to be generated. 																	*
*																																																		*
*	There is one more step to be performed for the phase.bin file described below:										*
* The phase bin file produced needs to be cropped at the end - To do this open the phase bin file		*
*	in the hex editor and go towards the end where one can see that no further code is there and the	*
* data is all ff. Select the first row of all ffs and drag your selection to the end of the file		*
* in the hex editor. Once selected, press delete to crop the tail end of the file										*
* Save the cropped phase.bin
*	Rename the bin file to a name of your choice																											*											
*																																																		*
*	Above action is not required for the production BootCode or rl78i1c bin files which are not	used	*
* in any case - Only the phase bin file is required to be loaded as it contains the application			*
* code from address 0x00000, and which the BootLoader will load into the MCU from address 0x04000		*
*																																																		*
*	EXTRA NOTES																																																		*
*																																																		*
*	All the four mot files	production, phase, rl78i1c and BootCode were converted to bin							*
*	The production.bin file was opened with hex editor, and another file BootCode was slso opened			*
*	side by side in the hex editor. Normally the hex editor opens the two files as tabs	but if one		*
*	tab is picked up and moved then it gives an option to generate horizontal or vertical panes				*
* Choosing vertical panes causes the two files to be viewed side by side														*
*																																																		*
*	The production.bin file contains both the BootCode and the Application - The initial portion of		*
*	of the Production file matches exactly with the BootCode bin file																	*
*	After this the BootCode file was closed and the Phase Bin file was opened in a side by side view.	*
*	Starting from address 0x04000 in the Production Bin file, the code matches exactly with the bytes	*
*	in the Phase bin file - the only difference is that every byte in the Phase bin file is shifted/	*
*	located at an offset of 0x04000 in the Production Bin File																				*
*																																																		*
*****************************************************************************************************

In the Copy(29) we have made one change which affects the operation of the 
powermgmt.c->POWERMGMT_ProcessMode1 function

This is the call powerUpDataCheck(1);

The powerUpDataCheck located in main.c checks the integrity of ctldata
If the meter starts from reset, the init_read_ctl_data() is called, but if the powerUpDataCheck(1)
is called from powermgmt.c->POWERMGMT_ProcessMode1 then init_read_ctl_data() is NOT CALLED.

This creates a difference. When called from powermgmt, only the checksum of ctldata is verfied,
and if not good, then the value of ctldata is read from e2rom. The same thing happens when the 
meter starts from reset and init_read_ctl_data() is called.

However the big difference is that when reading ctldata from the two memory locations are both
corrupted, then the init_read_ctl_data() INITIALISES ALL THE VARIABLES such as per the code below:

///////////////////////////////////////////////////////////////////////////////////////////////////////////////
      clear_structure((uint8_t*)&ctldata,sizeof(ctldata)); // this function fills zero bytes in the structure

      ctldata.energies_wrt_ptr=ENERGIES_BASE_ADDRESS;
      ctldata.year = rtc.year;
      ctldata.month = rtc.month;
      ctldata.date = rtc.date;

			ctldata.survey_wrt_ptr=SURVEY_BASE_ADDRESS;
			ctldata.cumulative_md=0;
			ctldata.cumulative_md_kva=0;
			ctldata.daily_log_wrt_ptr=DAILYLOG_BASE_ADDRESS;
// when we start the absolutely first time - then load survey records for the day upto the rtc time now now ought to be zeroed 			
      ctldata.hour = 0;
      ctldata.minute = 0;

#ifdef TN3P_BOARD			
			if(Common_Data.meterType==0)
		  	do_survey_update();	// for bidir meter - called at initialisation
			else
				do_survey_update_small();	// for unidir meter
#endif			
						
#ifdef SMALL_SURVEY_DATA			
			if(Common_Data.meterType==0)
		  	do_survey_update_small();	// for bidir meter - called at initialisation
			else
				do_survey_update_small();	// for unidir meter
#endif			

  		do_log_update();	// must be called only for regular meters			
// the above three lines should cause the zeroed records to be created upto rtc time
// after returning
      ctldata.hour = rtc.hour;
      ctldata.minute = rtc.minute;
    }
  }
  
  checkptr(&ctldata.energies_wrt_ptr, ENERGIES_BASE_ADDRESS, ENERGIES_END_ADDRESS, ENERGIES_PTR_INC);

// The following pointers are not multiples of 16 or 32 - hence the two checkptr calls may be disastrous	
//  checkptr(&ctldata.survey_wrt_ptr, SURVEY_BASE_ADDRESS, SURVEY_END_ADDRESS, SURVEY_PTR_INC);
//  checkptr(&ctldata.daily_log_wrt_ptr, DAILYLOG_BASE_ADDRESS, DAILYLOG_END_ADDRESS, DAILYLOG_REC_SIZE);
	
  ctldata.chksum=calcChecksum((uint8_t*)&ctldata,sizeof(ctldata)-1);
	
	computeLoadSurveyEntries(rtc.hour,rtc.minute);
	computeDailyLogEntries();
///////////////////////////////////////////////////////////////////////////////////////////////////////////////	

The ctldata is cleared, energies_wrt_ptr is initialised,ctldata.date, month, year are set to rtc,
survey_ptr is initialised, cumulative_mds are zeroed, survey and daily log data is lost, fresh survey
data and daily log is created, the ctldata chksum is updated, and fresh load survey entries and daily log
entries are computed.

Essentially the meter gets initialised partially - however the energy readings are not zeroed
Thus when md is to be computed by (myenergydata.kwh-ctldata.kwh_last_saved), then we are bound to
get a very high value in both the md computations and the load survey

NOW WHEN THE powerUpDataCheck is called from powermgmt, then only the two alternate memory locations
where the ctldata is stored are being read - No attempt is made to determine if there is any corruption
in both the locations and hence whatever is the data that is read is accepted as true.

THIS HAS THE DEFINITE ADVANTAGE THAT ctldata has not been initialised, but we are relying on the fact
that contents of ctldata are otherwise OK.

THIS IS A PECULIAR SITUATION
If the meter is reset and the ctldata in e2rom is corrupted at both locations, then the ctldata will 
get initialised resulting in horrible md values - also all the load survey and data logs will be lost

On the other hand if we just
			read_alternately(CTLDATA_BASE_ADDRESS, ALTERNATE_CTLDATA_BASE_ADDRESS, (uint8_t*)&ctldata, sizeof(ctldata));
			
without verifying the checksum and accept whatever data is there, then the chances are that we could
have bad values in ctldata, with unpredicatable results

This needs to be resolved

If ctldata is intialised, then we will surely have bad md values, and if it is not initialised
then we have an unknown, unpredictable situation

A DATA VALIDATA OF ctldata IS A MUST

Following points could act as checks

(a) value of md computed by the expression(s) (myenergydata.kwh-ctldata.kwh_last_saved) and its variations
		should not exceed by a large value, earlier mds stored
		
(b) the ctldata date time values must be less than present rtc and greater than the last bill date

(c) the value of the survey_wrt_ptr and daily_log_wrt_ptr must bear a relationship with the 
		Common_Data.meterStartDate, overflow flags and ctldata date time, rtc date time
		
(d) present enery values must be consistent with earlier billed values

IF THE ABOVE INCONSISTENCIES ARE NOTED THEN THE ctldata values ought to be reconstructed

A safe approach would be to equate ctldata- datetime to rtc and not perform any load survey / daily log actions
Also the kwh_last_saved values be equate to myenergydata.kwh to ensure that all computations of md through the
expressions (myenergydata.kwh-ctldata.kwh_last_saved) will not yield bad results




////-------------------------------------------------------------------------------------
22/09/2022
09:08
Certain documentation has been generated to address the bug reported by Shubham on 21/9/22

Changes are now being made as per conclusions arrived at after the analysis of data yesterday

A Copy(29) is being saved as reference which produces the hex file
EEPL3P_PCB_VER2_3_GUJARAT_UNIDIR_TEST_VER_00_60_SECOND_PERSISTENCE_20-Sep-2022

In check_setTamper and check_clearTamper following change has been made	- DONE

		if(*ptr==2)
		{
			recordInstantaneousDateTimeEnergy(flagmask);
		}

In performTamperProcessing else conditions have been added to avoid spurious tampers - DONE
to be noted during transient conditions.

Two hex files being sent for PCB_2_3 and PCB_2_5

18:10
Shubham has pointed out one bug ind display autoscroll
The value of TOD Off peak in autoscroll is random and wrong
Bug found TOD is being read in tempTodKwh, but tempLong is being modified for current zone
and tempLong is being displayed - NEEDS to be fixed

Shubham also wants Ram Corruption test code, as well as bootloader image file

////-------------------------------------------------------------------------------------
21/09/2022

For tamper processing
a) Voltage (Volts) is measured with one decimal
b) Current (Amperes) is measured with two decimals

Tamper Implementation is as per Gujarat Document

Care must be taken to check Current Open Tamper - See the Over Voltage case of reference

In current Open Tamper when occurence condition is < 2% of max current please make sure that adequate current
is flowing in the phases. Also note that minimum current measurement resolution is 10mA
Similarly for Current Open tamper restoration condition is > 2% of max current, please make sure that the difference
between the occurence and restoration currents is > 10 mA

Hence if Max current is chosen as 1 Amp, then for <2% please feed a current of 10 mA (1% of Max current)
and for >2% please feed a current of 30mA (3% of Max Current) to get proper results.

Alternately, chose Max Current as 10 Amps 
Then for < 2%	(which is 200mA), you can feed 190 mA and
for > 2% (which is 200mA), you can feed 210 mA.
You can also choose to feed 150 mA for < 2% or 250 mA for > 2%

 

Missing Potential				Vx < 96															Vx > 180									Remarks					


Low Voltage						Vx > 96 and Vx < 180 and						Vx > 180										Low Voltage occurrence or
											any phase current > 1A																					restoration is not tested
																																											if any potential is missing
																																											or there is neutral disturbance
																																											
Over Voltage					Vx > 276 and Vx < 300 and						Vx < 264										High Voltage occurrence or
											any phase current > 1A																					restoration is not tested
																																											if there is neutral disturbance
																																											

Voltage Unbalance			(Vmax-Vmin) > (Vmax/10) and					Vmax-Vmin < Vmax/10					Voltage Unbalance occurrence or
											any phase current > 1A																					restoration is not tested
																																											if there is missing potential,
																																											undervoltage, overvoltage or 
																																											neutral disturbance condition
																																											
																																											
Current reversal			Vx > 180, Ix > 1A, Sign of					Ix > 1A, Sign of
											current is -ve, pf > 0.2						current is +ve, pf >0.2																																					

																																											
Current Open					Vr,Vy,Vb > 180											Ir, Iy,Ib > 2%							Current Open occurrence or
											Ir,Iy,Ib < 2%												of actual max current and		restoration is not tested if there
											of actual max current and						any phase current > 1A			is reverse current, or dc or ac
											any phase current > 1A																					magnet condition


Current Bypass				Vr,Vy,Vb > 180											Ineutral < 1A  or 					Current Bypass occurrence or
											Ineutral > 1A and										Ir, Iy, Ib < 0.2A						restoration is not tested if there
											Ir,Iy,Ib > 0.2A																									is Current Open condition

Current Unbalance			Vr,Vy,Vb > 180											(MaxCurr - MinCurr)< 				Current Unbalance occurrence or
											Ir,Iy,Ib > 1A													0.3*MaxCurr								restoration is not tested if there
											(MaxCurr - MinCurr)> 																						is Current Open or Current Bypass
												0.3*MaxCurr																										Condition
												


16:02 hours

In the case of interlocked tampers such as CT Open and CT Bypass, the first instance that the CT open condition
disappears, the CTOPEN_MASK gets cleared and this sets the stage for the CT Bypass tamper to be tested
Now the CT Open tamper will be registered only after the persistence delay, and hence the DateTimeEnergy will be 
logged in the first instant and the Instantaneous parameters will be logged after a few seconds (RECORD_DELAY)

However at this same time the CT Bypass tamper also gets detected, and the process of registering the DateTimeEnergy in
the first instant and the Instantaneous paramters after the RECORD_DELAY will be logged simultaneously

A persistence time later, one event will be ready to be cleared, and another ready to be set
However there is a restoration and an occurence happening simultaneously
This should not be causing a problem as there are 32 different locations - one for each tamper event code bit

17:07 hours

While checking current unbalance condition, the condition line had got commented by mistake
This is line 1007 of tampers.c
The situation is being corrected
IT TURNS OUT AT THIS PROBLEM IS VERY OLD - SINCE EVEN THE PRODUCTION CODE RELEASED ON 15/FEB/2021 HAS THIS ERROR
//----------------------------------
It is not a drastic error as the condition of all currents being greater than 1A in each phase is NOT being checked
before testing current imbalance - at best it should play a minor role
//----------------------------------
Above statement is not correct since the (currentsGT95==5) accounts for all currents being greater than 1A
Hence it is NOT an error

WE STILL NEED TO DETERMINE THAT IF THE recordInstantaneousDateTimeEnergy AND recordInstantaneousData ALL USE 
DIFFERENT LOCATIONS INDEX BY THE BITS OF flagmask, and each bit corresponds to a different location in e2rom
then HOW COME THE RESTORATION & OCCURRENCE DATA ARE GETTING MIXED UP

IT IS CONFIRMED BELOW THAT THERE IS NO MIXUP
 
17:51
Shubham had sent me data file by email which contains the display of the tamper records
It is turning out that Current Bypass is getting registered before CT OPEN is detected
this is happening because the currentsGT95==3 condition is getting satisfied while the currents are
being set up for CT Open

Shubham sent a file current related tampers.csv where it can be seen that the CT open tamper (61) is recorded first
and then the CT Bypass Tamper (65) gets recorded - both appear to have the same time 11:33
Also the CT Open tamper is restored at 11:36 and the CT Bypass tamper is restored at 11:43

This does give the impression that there is something wrong, and the CT Bypass Tamper is getting registered
along with the CT Open Tamper or the start times are getting mixed up or the interlocks are not working

However, a look at the image file sent by Shubham, in his email of 21/Sep/2022 shows a clearer picture

The times of recording and restoration of CT Open and CT Bypass reveal the actual situation
This is the data received in the email

Date Time								Tamper
20-09-2022  11:33:02		61 (Phase-B CT open)
20-09-2022  11:33:00		65 (CT Bypass)
20-09-2022  11:36:20		62 (Phase-B CT open)
20-09-2022  11:43:31		66 (CT Bypass)

*******************************************
*	LOOKS LIKE A GENUINE BUG - NO IT IS NOT	* 
*******************************************

Tha fact is that the CT Bypass was detected 2 seconds before the CT Open - This is perfectly legitimate
since the CT Open had not been detected, hence the CT Bypass start time was logged

However, 2 seconds later the CT Open condition was recognised and the CTOPEN_MASK was set - This prevented
the CT Bypass code from being executed as per the interlock condition - however the tamper had already
got recognised

At around 11:35:20 when the CT Open condition was being removed, the CTOPEN_MASK was cleared, thus paving the
way for the CT Bypass counter to begin counting - Since it had already counted 2 counts before the CT Open 
condition had been detected, it would reach the persistence value before the CT Open restoration count and
hence the tamper CT Bypas got logged between the CT open occurrence and restoration logs

*************************************************************************************************
*	THERE IS A BUG IN THIS ALL RIGHT																															*
*																																																*
*	WHEN WE USE AN INTERLOCK TO PREVENT SOMECODE FROM EXECUTING, WE MUST ALSO ENSURE THAT 				*
*	DURING THE TRANSITION INTERVAL IF SOME ACTION HAD BEEN TAKEN BY THE CODE WHICH WILL						*
*	SUBSEQUENTLY GET INTERLOCKED, THEN ALL MEMORY OF SUCH INTERMEDIATE ACTION SHOULD BE CLEARED		*
*																																																*
*	SOLUTION																																											*
*																																																*
*	WHENEVER ANY INTERLOCKING FLAG GETS SET THEN THE PERSISTENCE COUNTERS OF THOSE EVENTS SHOULD	*
* BE CLEARED																																										*
* IT MAY ALSO BE ADVISABLE TO CAPTURE THE TIME OF OCCURENCE WHEN THE PERSISTENCE COUNTER				*
* BECOMES 2 INSTEAD OF 1 AS IT IS BEING DONE RIGHT NOW																					*
*																																																*
* BOTH CONCLUSIONS ABOVE ARE BEING IMPLEMENTED																									*
*************************************************************************************************

////-------------------------------------------------------------------------------------
20/09/2022
Yesterday, Shubham conducted tests of twowiretest.hex on other meter hardware and was found to be ok

*************************************************************************************************
*	COMMENT																																												*
*																																																*
*	WE ARE USING THE VALUES OF 985 AS CUTOFF FOR DETERMINING UNITY PF. THIS FIGURE CORRESPONDS TO	*
* AN ANGLE OF 10 DEGREES																																				*
* ONE WONDERS IF IT MAY BE BETTER TO SHIFT THIS VALUE UPWARD TO TO SAY 994											*
*																																																*
*************************************************************************************************

The values of pf check for incrementing zeroPFcount in determining determineTwoWireTamper have been
changed from 10000 to 9998. This is to account for any errors in converting the number 1 to float
and then back to int.

The twowiretest hex file used 10000 which has now been changed to 9998

A Copy(28) is being saved to preserve the twowiretest hex file output

A hex file will now be sent for checking tamper conditions

The persistence times are being reduced to 60 seconds
The TAMPER_PERSISTENCE_ON, TAMPER_PERSISTENCE_OFF have been made 60
These must be restored to 300 when released

09:51
Hex file made and being sent
	
////-------------------------------------------------------------------------------------
17/09/2022
at GNoida
10:26
Observations on code of 16/Sep/2022

1)	4- quadrant operation lag & Lead in display is incorrect, DLMS OK
2)	90 and 270 operation - pf shows 0.001(lead) in display		- FIXED OK
		kvarh_lag and lead registers are incrementd as if meter is sometimes running in lag and lead - OK
		
3)	Voltage only mode PF incorrect in DLMS (PFr = -124, PFy = 39, PFb = -58, signedPF = 1000) - FIXED OK
4)	At UPF, 240 10A, Y-phase PF in DLMS is -1.0000	- FIXED OK
5)	Power Off mode is not working - Bug found in powermgmt (MAGNET_INCREMENTATION) - FIXED OK

6) Two wire operation was checked, and owing to changes in pf computations the algorithm was not working
	Changes have been made to account for instances of zeroPF (which the new pf computation returns as 1.000)
	TWO WIRE OPERATION IS NOW WORKING
	
16:35
A hex file called twowiretest has been mailed to Shubham
In this version (test only) - all operations including two wire are working satisfactorily 	 
However there was a problem in single wire operation
Also regular three wire operations have also got affected - everything is kind of messed up

We need to step back

Changes in determineTwoWireTamper at the entry point have been reversed
////-------------------------------------------------------------------------------------
16/09/2022
08:15 hours
Preparing to send code to Eppeltone
*************************************************************************************************
FIRST ISSUE - MD ITNERVAL AND SURVEY INTERVAL RELATED

	Common_Data.mdinterval AND Common_Data.survey_interval problem

	If the load is very small and if during the survey interval KWH_INCREMENT of energy has 
	not been consumed, then it is likely that during that interval the consumption will be
	recorded as zero, and during the next interval a high consumption would be recorded

	For example is load is 1Kw and survey interval is 30 minutes, and KWH_INCREMENT is 1000 watts
	This will cause the load survey consumption values to be stored as 0,1000,0,1000,0,1000

	This is not a desirable phenomenon

	THIS ISSUE HAS ALREADY BEEN ADDRESSED EARLIER
	
	In the per_minute_activity(), everytime md is to be computed the energies are updated
	If survey_interval is less than md interval then the energies are updated every survey_interval
	
	A newer implementation of updating the energies accounting for 4 quadrant operation has been
	implemented in do_md_stuff
	
	
SECOND ISSUE - BILLING RELATED

	md interval and survey_intervals are 15,30 or 60 minutes
	however billing action is checked in per_second_activity
	
	It is for this reason that in the call to write_history_data_new the first function to 
	be called is update_energies_stored()
	
	THUS THIS ISSUE IS ALSO ADDRESSED
	
*************************************************************************************************


Make necessary corrections for individual phase wise power factors - DONE

Phase wise Sign of PF may need to be verified - CHECK

09:27
Hex File sent 


////-------------------------------------------------------------------------------------
15/09/2022

Change made in energyIntegration->energy_incrementation
Only for systemPF>50 (i.e. > 0.05) will be attempt to change the sign as per signs of
sigmaPower and sigmaPowerReactive
For systemPF < 50 (i.e. < 0.05), the computed pf will always be treated as +ve


LAG_ONLY_TARIFF option can now be uncommented
For lead cases, apparent power is equated to active power, however for the sake of
calculating systemPF this apparent power is NOT used as the systemPF woul become 1000
Instead for LAG_ONLY_TARIFF when system pf is being computed, the total_apparent_power
is being computed by pythagorean formula using totalactive and total reactive powers.



////-------------------------------------------------------------------------------------
14/09/2022
at Greater Noida
11:31
LAG_ONLY_TARIFF has been commented temporarily for Gujarat Unidir for testing purposes

Hex file had been sent and systempPF was found to be working correctly

********************************************************
*	IF BATTERY IS REMOVED, AND METER IS PROGRAMMED, WILL *
*	THE METER RESTART WITHOUT REQUIRING A REBOOT				 *
*      TO BE CHECKED AND VERIFIED											 *
********************************************************

For the 90 and 270 cases, when system pf is close to 0, ensure that the sign is always +ve

Make necessary corrections for individual phase wise power factors

Also update the display state code

what is to be done about LAG_ONLY_TARIFF?	-	DONE
SytemPF should always be correct, and for lead pf kvarh_lead should be added to kwh
i.e. when pf is lead case, then apparent power = active power
pf computation is not to be affected 


Survey Interval change	- 	DONE

If survey interval is changed at 10:10 on 14/Sep/2022 from 30 to 15
all entries from 00:15 to 10:00 will be made 0, and upon reaching 10:15, the
first survey record will be written
At 10:10 hours the ctldata saved values will  be equated to present kwh and kvah registers
Hence consumption information of 10 minutes pertaining to 10:00 to 10:10 will be lost

////-------------------------------------------------------------------------------------
12/09/2022
9:30
Spoke to Rohit
The BM and BY commands are not useful
What is required is an INIT command
INIT differs from ZAP in the sense that everything will be cleared except the batchmonth, batchyear
We can just set a flag in e2rom,save the current batchmonth and batchyear in e2rom and zap the meter
When it comes to reading the Common_Data, it will read the flag in e2rom. If flag is set
then the batch month and batch year will be taken from the saved figure

10:25
Hex file is being sent to Shubham
Pending points remain

////-------------------------------------------------------------------------------------
11/09/2022
The energyIntegration.c->energy_incrementation() has been heavily modified for the UNDIR
METER. Also most of the changes are as per Gujarat, THINGS MAY NOT WORK TOO WELL FOR
OTHER BOARDS - NEED TO BE INDIVIDUALLY TESTED

Problems related to PF values, PF sign, four quadrant operation, Unity PF at no load etc
have been corrected
kwh, kvarh_lag, kvarh_lead incrementations should now happen correctly even when the meter
is being operated in the reactive mode (phase angles of 90, 270 degrees and what nots.

THE STATE OF THE CODE FOR BIDIRECTIONAL METER IS NOT KNOWN AT PRESENT

Now for the other points

Observation No 1
1. SystemPF at Vr,Vb,Vy=240 and Ir,Iy,Ib=10 at UPF was showing -1.000
	The modified energy_incrementation should have fixed this bug

Observation No 2
2. Error while measuring reactive power (reactive pulsing) - when frequency is not 50 Hz (47, 53 tested)
	Under pf=0 conditions, reactive pulsing is always showing a +ve error of 1.28% to 1.47%
	whereas the computed reactive power is coming as 7200 / 7214 which is bloody accurate

	THIS HS BEEN VERIFIED ON OTHER BENCHES AND IT HAS BEEN FOUND THAT THERE IS NO SUCH ERROR
	METER REMAINS WITHIN ACCURACY
	
Observation No 3
	A test was run for 1 hour (60 minutes)
	Reactive power = 7215, Active power 61, Apparent power = 2462
	In one hour we should have observed 11544 pulses, and actual count of pulses was 11549

	However, kvarh_lag + kvarh_lead registers did not increase by 7.215 kvarh
	The modified energy_incrementation should have fixed this bug

Observation No 4	
	For unidir / bidir meters, in energyIntegration.c->energy_incrementation
	if the active power was close to zero, then energies were being updated in e2rom
	However for meter running at 90 degrees (Zero active power, 100% reactive power)
	this was causing a problem
	The modified energy_incrementation should have fixed this bug

5. During Magnet test kwh> kvah - also at times systemPF becoming > 1.000
	The modified energy_incrementation should have fixed this bug

6. Meter display flickering in Mode 2
	  read_alternately have been replaced with EPR_Read
		A special function displayPrepare() is being called in every state
		just before the lcd data update to reduce time gap and hence flickering
		
7. Time stamp (billing_date) in instantaneous parameters - DONE

8. When survey interval is changed - load survey should be initialized - DONE
	All action takes place in per_second_activity
	We need to make the variables NO_OF_DAYS_SURVEY_DATA, NO_OF_SURVEY_RECORDS
	and SURVEY_END_ADDRESS in memory instead of #defines as these will change
	if survey interval is changed - YET TO BE DONE

9. Command for changing Manufacturing Month and year

	When batchmonth and batchyear are changed then computation of cumulative power off minutes
	will become erroneous
	It is possible to change the Common_Data.meterStartDate however this may lead to conflict 
	with earlier stored data
	
	We are adding the EEOBM and EEOBY command for Batchmonth(nn 1-12) and batchyear(yy) - DONE
	command added in pravakComm.c
	
	THIS COMMAND IS BEING REMOVED AS WHEN THE METER IS ZAPPED THIS WILL HAPPEN AUTOMATICALLY
	AFTER HAVING SPOKEN TO ROHIT
	

10. I HAVE NO IDEA IF RTC BATTERY TEST WORKS CORRECTLY OR NOT

	
////-------------------------------------------------------------------------------------
10/09/2022
In energyIntegration.c the following string is placed at line 782
// NOT ENTIRELY HAPPY WITH WHAT IS GOING ON HERE - NEED TO WORK ON IT AGAIN - AJAY		

Must start work from this place onwards
Stopping for the day

////-------------------------------------------------------------------------------------
09/09/2022
This folder compiles to produce production_bidir.hex and production unidir.hex
A Copy(27) is being saved
Changes made upto now include a few items listed as 1,2,3,4 below
Also the energyIntegration.c has been split to have separate functions for unidir
and bidir meters to improve readability.

12:46
at Greater Noida

Observation No 1
1. SystemPF at Vr,Vb,Vy=240 and Ir,Iy,Ib=10 at UPF was showing -1.000
	This was being caused by a reactive power value of -20
	Since signs of active and reactive power were different, the systemPF was being multiplied by -1
	
	THIS HAS BEEN FIXED IN energyIntegration.c
	
Observation No 2
2. Error while measuring reactive power (reactive pulsing) - when frequency is not 50 Hz (47, 53 tested)
	Under pf=0 conditions, reactive pulsing is always showing a +ve error of 1.28% to 1.47%
	whereas the computed reactive power is coming as 7200 / 7214 which is bloody accurate
	
	
15:21
Observation No 3
A test was run for 1 hour (60 minutes)
Reactive power = 7215, Active power 61, Apparent power = 2462
In one hour we should have observed 11544 pulses, and actual count of pulses was 11549

However, kvarh_lag + kvarh_lead registers did not increase by 7.215 kvarh
						Initial			Final			Consumption
kwh					118267			118312		45
kvarh_lag		1703				5679			3976
kvarh_lead	1632				4207			2575
kvah				120564			125255		4691

3976+2575 = 6551 (should have been 7215)	- THIS APPEARS TO BE AN ERROR WHICH IS TO BE FIXED.
	
Observation No 4	
For unidir / bidir meters, in energyIntegration.c->energy_incrementation
the following code snippet is executed

	if(ABS(total_active_power)<3)
	{// here there is no power (less than 3 watts) - being treated as zero power
		if(myenergydata.kwh!=total_energy_lastSaved)
			update_energies_stored();
	}
	else
	{// here total active power is >3 i.e there is some load on the meter
		if((myenergydata.kwh-total_energy_lastSaved)>=KWH_INCREMENT)
			update_energies_stored();
	}
	
Now when we run the meter at 0 pf, (angle =90), all power is supposed to be reactive
	
	
////-------------------------------------------------------------------------------------
08/09/2022
Spoke to Rohit today - Some changes have already been made
Now whatever rohit has mailed needs to be implemented

We also need to make improvements for the zero pf case - lag/lead problem
Accuracy has to be adjusted when frequency is changed


Rohit's observations of 04/Sep/22 are reproduced again

During no load i.e. at voltage only, Power factor should be 1.
PF should have + sign above 0. 990 ( under lead condition)  

	We need a uniform method of reporting pf and its sign through out the meter code

During Magnet test- Meter records Active energy more than the apparent energy - INSIGNIFCANT

During Magnet Test, Meter Display flickering start in  mode 2, 
however it is OK during Mode 3 and mode 1


Time Stamp of Billing period should be last reset. - DONE in IC-7 Instantaneous parameters - billing date


After Month change in power OFF mode– Cum. TOD (T0) energy record less 
than Sum of T1 to T8 Zone. ( data file separately attached *.png)

Whenever capture period of Block Load Survey profile is changed, the earlier load survey data
shall be cleared and the load survey data with new capture period shall be available from that
particular days’ first entry. This is as per latest DLMS amendment ( copy attached)

We need proprietary command for MM/YYYY modification
Recoding in EEPROM should only be enabled when in USER mode.( this can be taken up at a later stage).

Reactive power becomes fast by 1.2% when frequency is changed to 47Hz or 53 Hz
In both cases reactive power becomes fast

No code sent today

////-------------------------------------------------------------------------------------
07/09/2022
Visited Greater Noida today.
Saw the reactive power UPF case
Noticed the hazards of operating at zero pf (90 degrees)
If the angle changes from 89 to 91 or 89.9 to 90.1 then the pf sign changes from +ve to -ve
This is a problem when operating at zero pf, since +ve sign represents lag and -ve sign
represent lead.
In LAG only meters the lag and lead powers are handled differently
Hence if two out of three phases at zero pf have +ve sign, and one of them is -ve then
computations go awry
Owing to noise at 90 degrees phase angle (zero pf), the individual phase angles keep
shifting either side of 90 i.e. 89 and 91 resulting in chaos.

Some bugs were pointed out by Shubham which have already been corrected - comparison may be
made with Copy(26)

These are 
1. In memoryops-> computeAveragePF
	if (apf > 1000)
		apf = 1000;

2. In dlms_data_ic.c for GUJARAT_UNIDIR meter the script ids have been changed to
	2,3,1,4,1,2,0,0  from earlier 1,2,3,4,3,1,0,0
	
	Script_ids	
	New 			Old
	2					1
	3					2
	1					3
	4					4
	1					3
	2					1
	
	Changes have been made in gujarat unidir display file also
	
3. In dlms_data_meter.c -> R_OBIS_Class07_FilterOneInstEntry following changes have been made
	to send the value of g_Class03_BillingDate (earlier the rtc value was being sent - now g_Class03_BillingDate)
	
length = R_OBIS_EncodeAttribute(p_out_buf,OBIS_SERVICE_DATA_BUFFER_LENGTH,ATTR_TYPE_OCTET_STRING,(Unsigned8 *)&(g_Class03_BillingDate),12);

4. Cover tamper is not required to be counted in cumulative tamper count (Non-rollover event is not to be counted)
	in powermgmt.c->checkCoverTamper the following line has been commented
		
//			    mytmprdata.tamperCount++;	// this is not to be counted - non-rollover event - 07/Sep/2022 - shubham feedback
	

Above changes have been made.
	

////-------------------------------------------------------------------------------------
06/09/2022
This folder compiles to EEPL3P_PCB_VER2_3_GUJARAT_UNIDIR_TEST_VER_00_29-Aug-2022
A Copy(26) is being saved before making fresh changes

A code for PCB_2_5 is being sent to verify meter display flickering in Display Mode 2

The #define PCB_2_5 has been uncommented to make code for PCB_2_3 after generating hex file
for PCB_2_5
////-------------------------------------------------------------------------------------
04/09/2022
Rohit's observations

During no load i.e. at voltage only, Power factor should be 1.
PF should have + sign above 0. 990 ( under lead condition)  
During Magnet test- Meter records Active energy more than the apparent energy


During Magnet Test, Meter Display flickering start in  mode 2, 
however it is OK during Mode 3 and mode 1
Time Stamp of Billing period should be last reset.
After Month change in power OFF mode– Cum. TOD (T0) energy record less 
than Sum of T1 to T8 Zone. ( data file separately attached *.png)

Whenever capture period of Block Load Survey profile is changed, the earlier load survey data
shall be cleared and the load survey data with new capture period shall be available from that
particular days’ first entry. This is as per latest DLMS amendment ( copy attached)

We need proprietary command for MM/YYYY modification
Recoding in EEPROM should only be enabled when in USER mode.( this can be taken up at a later stage).

Reactive is fast when frequency is 47 or 52 by 1.2%



////-------------------------------------------------------------------------------------
29/08/2022

18:08
For PCB 2.3, Rohit has indicated that meters are going into magnet tamper
Changes have been made to make the Hall sensor pins as inputs, and internally pulled up

New hex file for Gujarat Unidir in PCB 2.3 is being sent
////-------------------------------------------------------------------------------------
27/08/2022

09:27
This folder compiles to EEPL3P_PCB_VER2_5_JVVNL_UNIDIR_TEST_VER_00_03-Jun-2022.hex
A Copy(25) is being saved before starting work.

09:29
Rohit has intimated that some problems have been observed at Gujarat in the UNIDIR meters
The code running in the meters in Gujarat do not have bootloader and the source folder is
	G:\PRAVAK_this\RNSS3P20\Archive_Source3P_BIDIR_GUJARAT\Source3P_BIDIR_GUJARAT
which produces the hex file
	EEPL3P_GUJARAT_UNIDIR_15_Feb_2021_1215_NODEBUG_VER_025
	Above code was also running on older PCB Version 2.3
	
After this hex file had been released for production and 5000 meters were produced, work
had begun on the bootloader code. All the changes and improvements were made in the
G:\PRAVAK_this\RNSS3P20\Source3P_BootLoader

Lots of earlier problems have been corrected in the bootloader version

During this time the PCB was also changed to PCB Version 2.5 
A #define PCB_2_5 is created in the emeter3_structs file which allows the code to be switched
between the two versions

The PCB_2_5 hex files have been tested for a long period of time. Unfortunately at present all
the installed base is on PCB Version 2.3 and the hex code is the non-bootloader version

It is being assumed that the bug fixes over a period of time ranging from 15/Feb/2021 till date
would automatically result in the software being in an improved state, two issues remain
in an unresolved state

(a)	RTC calibration / adjustment
(b) False power reading 672 watts instead of 720 watts (actual power)
		This false power reading gets corrected when the meter is powered On/Off
		
***********************************************************************************************
RTC adjustment

A test had been conducted by Gaurav in which the RTCOUT signal was measured and the following 
values of frequency were measured for the 1 Hz signal

These figures are picked up from email of Gaurav of Mar 15, 2022

		Dear Sir 
		Please find ppm measured in 3 phase meter 
		meter no.                ppm
		1.                         1000056
		2.                         1000070
		3.                         1000052
		4.                         1000061
		5.                         1000067
		6.                         1000065
		7.                         1000051
		8.                         1000056

The decimal point is implicit and it is apparent that all meters are fast by an average
value of 59.75 ppm

Hence the actual frequency of the crystal is 32768*1.00005975 = 32770 Hz
Hence every second the counter is fast by 2 cycles. Hence every 10 seconds ,if the value
of 20 is subtracted i.e2rom_crtstop. RADJ:ADJ is made 20 then the rtc will stand corrected
every 10 second interval.

This adjustment is being done in this version of the code
***********************************************************************************************

False Power reading

There is no certainty at the present moment, as to what causes the error to be -ve, and
what causes the power to be read as 672 watts instead of 720 watts
Meter is running on the nech - all phases 240 V, all currents 2 Amps, PF = 0.5

One is not sure how the total_active_power is getting affected
***********************************************************************************************

With this background, changes are now going to be made in this code:

	The #define GUJARAT_UNI_DIR_METER is uncommented in board.h
	The #define PCB_2_5 has been commented to produce code for older PCB Version 2_3
	The files em_display_Gujarat.c and tampers.c have been included in the build
	
Now to make changes for RADJ	

There was a problem of conflict between RTCOUT and RTC-BKUP signals where ports P150 and P62
were swapped in pcb version 2.3 and 2.5 The issue has been temporarily resolved at present
However for some strange reason P12.5 is being used as RTC-BKUP in 2.5 whereas it should be
some other pin as per schematic diagram

R_PORT_Create and R_PORT_StopCreate have been corrected as well as MAKE_RTC_SUPPLY_LOW and
MAKE_RTC_SUPPLY_HIGH have been defined for both pcb versions

////-------------------------------------------------------------------------------------
03/06/2022
Gaurav has sent his feedback in the email.
We will need to modify the way display functions
Both Up and Down Buttons are to be used
In autoscroll mode pushbutton will not work - In fact pressing the pushbutton will switch to 
pushbuttonDisplay

In battery mode the display will be pushbutton
Cover tamper display must be shown whenever pushbutton mode is on alternately

////-------------------------------------------------------------------------------------
02/06/2022

To allow proper addressing of memory locations for different boards - we will create
individual e2rom_address_files for each board

This is to allow different cases of load survey, daily log etc cases to be neatly handled

Currently the memoryOps.h will include one single e2rom_adds.h for Gujarat (Uni / Bidir), PVVNL and Kerala boards

For JVVNL a new e2rom_adds_JVVNL.h will be created and included in memoryOps.h file

Clarifications sought from Gaurav:

Kindly agree or disagree with every line in the following document.
 
In case of disagreement, please provide the correct interpretation as the case may be.

1. Please confirm if my understanding is correct. for each of the lines.
	When power goes off, display should become off.
	When Up pushbutton is pressed in the power off mode, then display should appear.
	In power off mode, the pushbutton mode parameters should be displayed.

	When display mode is changed then message Mode-1 or Mode-2 should NOT be shown.

	Autoscroll parameters will always scroll every 10 seconds. 
	Pressing the Up pushbutton will cause display mode to change to Push Button Display mode.

	Once display is in pushbutton mode, parameters will scroll automatically after every 10 seconds 
	except the LCD test, which will be there for 5 seconds. 

	If the Up pushbutton is pressed, the display will automatically switch to the next parameter.


2. Daily log will now show three parameters. Kwh, Kvah and powerOnMinutes for the day.
	What is the OBIS code for daily power on minutes?

	Further clarification required :
	In daily Log, kwh and kvah are the cumulative figures. Should power On minutes be the cumulative figure also?
	At present the power on figure is only for the day.

3. During C-open, C-open blink only in continuous display parameters - it should also blink with pushbutton parameters.

	What is the meaning of "blink" - At present is C-open is shown for one second, 
	followed by date for one second and time for one-second.

	Should C-open be shown for 10 seconds, followed by c-open date for 10 seconds, followed by c-open time for 10 seconds. 
	This will take thirty seconds. 
	
	Blinking means each display will be On for 1 second and off for the next second alternately. 

	Please confirm if the above understanding is correct, and it there is a C-Open tamper then it should take 30 seconds
	to display, C-open, Date and Timer.

	Same thing for magnet display. This will also take thirty seconds to display 
	the magnet message followed by the occurence date and time. 

	Does magnet display also have to blink like the C-open display?

4. In pushbutton mode if there is C-Open then C-open should come on display after every parameter. 
	Is C-Open date and time also required to be displayed?

	Is magnet tamper also required to be displayed after every parameter in pushbutton mode display?

5. Is there a Down button feature present in this meter. This means, that in pushbutton mode, should the display run backwards?

	If there is C-Open and Magnet tamper, then when the Down button is pressed how should these parameters be displayed when the Down button is pressed?

6. If magnet persistence time is made 15 seconds, then we will not be able to detect ac-magnet, which requires 60 seconds to be detected. 
	Is AC-magnet detection required in JVVNL case? If it is then tamper detection time cannot be less than 60 seconds.


7. In power off mode, pressing the Up button will cause the display to turn on.

	For how long should the button be pressed for communication in battery mode to be turned on, or should it turn on immediately.
	At present one has to press the button for a minimum 5 seconds for the UARTs to be turned on in battery mode.
	This is because current consumption in battery mode is greater when UART is turned on comapred to when only display is turned on.

	Please indicate how the meter should be programmed for this feature in JVVNL.

8. In pushbutton mode, pressing the button will caue meter to display the next parameter.

	If the button is pressed continuosly, then should the display be changed to the next parameter every second?
	or 
	should the parameter be changed only after the button is released and then pressed again.

	It is important to explain this feature, because if the user keeps the button pressed continuously to change the parameters quickly in
	battery mode, then after 5 seconds the UARTs will turn on, thereby increasing power consumption.

9 In battery mode, if pushbutton is continuosly pressed for 5 minutes then battery should be disabled till next pushbutton operation.

	What is the meaning of battery should be disabled till next pushbutton operation? In our meter, battery is always connected.

	Does this mean that meter should go to sleep mode, and should wake up only when pushbutton is released and then pressed again?

10. What is the Board code for JVVNL?
 
11. How much time is available for developing the JVVNL meter? The reason is that the meter operations relating to display and pushbuttons
	is very different, and may require a few days to achieve the satisfactory results.

Please respond immediately, or as soon as possible to the above 11 queries, and give me one more day, for me to provide you with the code.




////-------------------------------------------------------------------------------------
31/05/2022
07:49 IST
A first cut code has been sent.

Gaurav's observations:

Below are some observations from 1st test code , 
1. In battery mode meter is scrolling continuous parameters
   without pressing the button (it should appear on pressing push button )
2. when displaying kwh in auto scroll mode display
   then icon "NRYB" disappeared
3. Mode -2 to be selected by just pressing "up scroll" button

4. Daily kwh log showing 180 days entry , it should be 75 days
    with day power on hours
5. During C-open , C-open blink only in continuous display parameters it should be also blink with push button parameters
6. push button mode display parameters are not scrolling after 10 seconds .

Need to make changes in the memoryOps.h file to allow to e2rom address settings for different boards
A Copy(24) is being saved vefore making major changes

////-------------------------------------------------------------------------------------
29/05/2022
at Santa Clara - 23:14 IST
This folder produces the hex file of
EEPL3P_PCB_VER2_5_KERALA_UNIDIR_TEST_VER_00_13-Apr-2022-1329
A Copy(23) of this folder is being saved

23:17
Gaurav has sent a mail for JVVNL (Jaipur)
It is a Unidirectional meter - code will now be built

////-------------------------------------------------------------------------------------
13/04/2022

Extended display for TOD zones , display shall show new added tod zones on display. DONE
Power Off duration is now displayed in hours

Gaurav has also provided feedback 
His feedback indicates that average pf for current month continutes to be computed after bill has been made

WE HAVE ADDED a call to (update_energies_stored()) in write_history_data_new

This is also being done in composeCurrentBillData()

HOPE THIS FIXES the problem.

Hex file being sent. 

below is the status of code 

1. In auto mode display parameters when displaying inst. PF , "LEAD" icon not glowing - DONE
   when meter is running at leading PF	 Now it is available 

2. When displaying tamper id (for last & 2nd last occur/restore) in pushbutton mode display - DONE
   please display word "id" before tamper id
verified it is available 
3. on auto scroll display rtc status showing "bad" when battery status changed to "Bad" - ALWAYS GOOD - DONE
verified okay
4. remove current checking condition from voltage unbalance , Low voltage and high voltage tampers - DONE
verified okay above tampers are being logged without current 

2 scaler unit for tod kw and kva seems in correct - CHECK NOW 
verified okay
3. scler unit for split kwh is showing "28" which means va change it to 30 "wh" in billing profile. DONE
verified okay
4. In billing profile in ic -7 avg pf for current billing period does not become "0" 
   even when meter has not recorded energy in current billing cycle. PLEASE CHECK BY MAKING POWER 0 BEFORE GENERATING THE BILL
verified , still showing avg. pf value in current billing   (bill generated when all phases current ==0; )
5. scalar value for voltage in load survey data is not correct showing 10*-1 change it to 10*0 - DONE
verified okay
6. some times system Pf shows -1.0 on display at unity PF - CHECK NOW
verified okay
7. in auto mode display add NVM and RTC check at the last. DONE
verified okay
8. Extended display for TOD zones , display shall show new added tod zones on display. PENDING
 
09:26 Hex file sent

Gaurav had called to intimate that average pf in current month (DLMS) was still not correct.
In composeCurrentBillData the following expression had been used
		g_Class07_BillingBuffer.power_factor = (kwh_consumption*(int32_t)1000)/kvah_consumption;
The kwh_consumption and kvah_consumptions were being computed from the tod zone figures

A better and correct method is now being used
	g_Class07_BillingBuffer.power_factor=computeAveragePF(total_energy_lastSaved, apparent_energy_lastSaved, IMPORT);

Gaurav has also said that in the Pushbutton display, the holdState does not seem to be working fine - kind of
This issue has also been addressed

////-------------------------------------------------------------------------------------
12/04/2022
Hex file with observations of 11 Apr 22 and 31 Mar 22 sent
A Copy(22) is being saved before making changes for variable TOD display
////-------------------------------------------------------------------------------------
11/04/2022

Additional observations on 11 Apr 2022
now some  observation from 31 march dated mail remains pending also few more are as follow

1. In auto mode display parameters when displaying inst. PF , "LEAD" icon not glowing - DONE
   when meter is running at leading PF
	 CHANGES HAVE BEEN MADE IN em_display_Kerala.c as well as 
	 in getInstantaneousParams(PFSIGNVAL, LINE_TOTAL)
	 
2. When displaying tamper id (for last & 2nd last occur/restore) in pushbutton mode display - DONE
   please display word "id" before tamper id
3. on auto scroll display rtc status showing "bad" when battery status changed to "Bad" - ALWAYS GOOD - DONE
4. remove current checking condition from voltage unbalance , Low voltage and high voltage tampers - DONE


Observations of 31 Mar 2022 which had been missed

please find observations from KSEB code 
1. meter is showing rev icon when any phase wire is interchanged with neutral wire . DO NOTHING.
2 scaler unit for tod kw and kva seems in correct - CHECK NOW
3. scler unit for split kwh is showing "28" which means va change it to 30 "wh" in billing profile. DONE
4. In billing profile in ic -7 avg pf for current billing period does not become "0" 
   even when meter has not recorded energy in current billing cycle. PLEASE CHECK BY MAKING POWER 0 BEFORE GENERATING THE BILL
5. scalar value for voltage in load survey data is not correct showing 10*-1 change it to 10*0 - DONE
6. some times system Pf shows -1.0 on display at unity PF - CHECK NOW
7. in auto mode display add NVM and RTC check at the last. DONE
8. Extended display for TOD zones , display shall show new added tod zones on display. PENDING

Above will be attended to and code sent after adding variable tod also.



////-------------------------------------------------------------------------------------
09/04/2022
All points listed below have been addressed
Two points are pending

CT Bypass icon glowing while CT open condition
EM_LCD_DisplayStatus of Kerala has been matched with that of Gujarat - SHould get fixed - TO VERIFY
Adjusting the display of TODs as per number of script selectors.

We only need to check the day_action0[i].script_selector value- if it is 0 then we don't have
anything else to display. - will do this a bit later
11:09
Sending hex file now

////-------------------------------------------------------------------------------------
07/04/2022
Restarting on kerala tender

Fresh observations received on 01/Apr/2022
1. Power fail duration is showing 35837 value - DONE
2. in push button mode moved parameters   moved 17,18,19,20 instead  (no. (16,17,18,19) - DONE
    16-Bill kWh lag
    17-Bill kWh lead
    18-Cumulative kWh Lead
    19-Cumulative kWh Lag
   
3. battery status still showing good after removal of battery - PLEASE CHECK & REMOVE 100 nf capacitor - DONE
4. Inst PF on auto scroll display showing icon lead/lag while meter has no current. DONE
5. missing potential tamper is not getting restored above 97 volt - DONE
6. display temper id (DLMS ID) only (not the name) when displaying last and 2nd last tamper details on push button mode display - DONE
7. when doing the ct open tamper bypass icon appeared - check in Gujarat - PENDING
8. after forcing rtc forward when downloading the billing profile in ic-7 it is showing the previous bill date. // only happened once ,corrected after power on/off
9. NVM and RTC status on display - autoscroll at the last add e2rom - pass / fail, rtc - pass or fail - DONE
10. In auto scroll mode when displaying present tamper status display only "tamp yes" if tamer available else display "tamp-nil" DONE


////-------------------------------------------------------------------------------------
31/03/2022
A hex file EEPL3P_PCB_VER2_5_KERALA_UNIDIR_TEST_VER_00_31-Mar-2022.hexchar2nibble was sent today.
A Copy(21) compiles to this code
////-------------------------------------------------------------------------------------
28/03/2022
Kerala Code EEO sent on 28 Mar 2022

Gaurav's feedback
//------------------------28/03/22-------------------------------//
1.  Add battery status after lcd check in auto scroll mode - DONE
2.  In auto scroll mode when displaying phase sequence remove "r" before sequence - DONE
3.  In push button mode add lcd check before battery status - DONE
4.  In push button mode when displaying md kw tod wise (0Tod1-Tod 3) showing "BILL" icon with time display - DONE
5.  In push button mode,  move parameter  no. (16,17,18,19)- DONE
    16-Bill kWh lag
    17-Bill kWh lead
    18-Cumulative kWh Lead
    19-Cumulative kWh Lag
    to the last of the list after program count

6.  In TOD zone definition - DONE
    0600-1800
    1800-2200
    2200-0600
    script Id,s are 5,6,7  it should be 1,2,3
7.  Due to incorrect tod script ids tod zone data (kwh, MD )on display is not available. DONE
8.  For missing potential tamper (remove current checking) - DONE
9.  in push button mode last occured and restored tamper info not available - DONE
  
10. OBIS code 0.0.0.1.2.255 (Timestamp of last billing) in IC-3 shows corrupted value after power - DONE
    reset (power on/off) while same obis in IC-7 (instantaneous para show correct value)
    
11. Meter is showing power fail duration "09549" after power on/of in push button mode display - DONE

////-------------------------------------------------------------------------------------
15/03/2022
A test code is being provided which will always show the instantaneous power on display
This is to be used to measure efficiency of our charger

A #define CHARGER has been introduced in em_display_Gujarat.c file to produce the test code
This #define has been then commented 
////-------------------------------------------------------------------------------------
22/02/2022
A Copy(20) has been saved
RTCOUT will be activated now
////-------------------------------------------------------------------------------------
20/02/2022
Gaurav has sent a mail to activate the RTCOUT (P150) - need to enable RCR2.RTCOE = 1
The idea is to measure the RTC pulse time accurately and then to add or subtract a value
to correct / adjust the RTC counters to make the time more accurate
How the frequency/time interval is to be measured is not known as yet (what is the reference)
Also
(a) A command will be required to communicate to the meter the error in RTC so that it may be adjusted
(b) The adjustment value will need to be stored in e2rom so that it may be loaded upon reset
 
////-------------------------------------------------------------------------------------
08/02/2022
A EEPL3P_PCB_VER2_5_GUJARAT_BIDIR_FACTORY_VER_028 had been released on 04-Feb-2022
A Copy(19) of this folder which compiles to the release code is being saved
Copy(18) is similar / nearly identical to Copy(18) which is also preserved

Gaurav has sent an email regarding the handling of unused pins

Dear Sir 
please find below table for unused pins in 3 phase hw ver 2.5.2 for handling . These pins are not in use in any case please take care of them accordingly
Handling of unused pins
sr.no.	Port	Pin No.	 
1				P0			1			P06						DONE - made output and 0 always
2								100		P07						DONE - made output and 0 always
3	 			P3			35		P36	/ SEG30		DONE - made output and 0 always
4								40		P31	/	SEG25		DONE - made output and 0 always
5				P4			8			P41						DONE - made output and 0 always
6								6			P43						DONE - made output and 0 always
7								7			P42						DONE - made output and 0 always
																		WHAT ABOUT P40 WHICH HAPPENS TO BE THE TOOL INPUT PIN?
8				P5			80		P51	/ SEG33		DONE - made output and 0 always
9								79		P52	/ SEG34		DONE - made output and 0 always
10			P6			27		P62						DONE - made output and 0 always
11			P12			15		P121					NOTHING DONE - are input
12							14		P122					NOTHING DONE - are input
13			P15			12		P150					DONE - made output and 0 always

Test code will now be sent with these changes with Board ID 39 and ver 00



EEPL3P_PCB_VER2_5_GUJARAT_BIDIR_FACTORY_VER_029
being released
////-------------------------------------------------------------------------------------
04/02/2022
Production code for Gujarat BIDIR is to be released.

As per Gaurav's mail of 03 Feb 2022 reproduced below:

Dear Sir 
I have performed below tests on gujrat bidir meter code and all tests are satisfactory 
1. Billing in battery mode.
2. MD Reset in battery mode (power fail before end of MD interval period & power returns in next interval )
3. Tod zone energy updating in power fail mode ( if power fails before end of zone) as well as power on mode for both Import & Export.
4. Single action schedule
5. Meter power on without both batteries
6. RTC running without RTC battery (rtc working if any 1 battery available )
7. Tod settings
8. battery power consumption
9. Load survey data recording

Previously reported  observations verified and found satisfactory.
Kindly send released version of the same containing Version no. for Board PGVCL (pin code) prefix 39

A Copy(18) has been saved
We are going to produce production code as well as the binary image
Binary image requires mot file to be generated - The procedure for converting mot file to image is 
written in BootLoaderNotes.txt located in E:\PRAVAK_this\RNSS3P20

To change the files from Intel Hex to Motorola 
In the Project Tree CC-RL (Build Tool) Property
Common Options -> Frequently Used Options (for Hex Output)
Change Hex file format from Intel Hex File to Motorola S-Record File

Thereafter follow procedure in BootloaderNotes.txt to produce bootloadable image


////-------------------------------------------------------------------------------------
02/02/2022
10:03
Three issues of 31/Jan/2022 have been addressed
Test code is now being sent - It will be upgraded to release in a separate issue
////-------------------------------------------------------------------------------------
31/01/2022
Gaurav's mail of 28/Jan/2022
Dear sir
I have noticed a issue in gujarat Bidir meter code "PCB_VER2_5_EEPL3P_GUJARAT_BIDIR_V00_03_Jan_22_1433" dated 3 jan 2022. 
1. In export mode zone MD kVA  values are being overwritten irrespective of checking the highest value.  
   (In every MD interval period MD changes for  particular zones) - DONE
2. In production mode after calibrating meter calibration status (Only status)  on display changes to default (becomes FFFFFF)
   after power on/off of the meter. - DONE
   (It is happening since we have made changes to prevent RAM data corruption. 
    and it is the same in Bidir & unidir meters ) 
3. In gujrat bidir meter when displaying voltage phase sequence on display in auto scroll mode, - DONE
   then status should displayed only when all three phase available else display "PS ----"

////-------------------------------------------------------------------------------------
03/01/2021
A Copy(17) is being saved before making any further changes

This folder before changes compiles to PCB_VER2_5_EEPL3P_GUJARAT_UNIDIR_TESTING_30_Dec_21

Following changes are now being made:

When power returns, the setInterruptPointers() call is being shifted to POWERMGMT_DoAfterStop
Also DI() and EI() calls are made to disable and enable the global interrupt flag

The current unbalance icon remains on under following condition - FIXED in tampers.c
	If there was current unbalance, and the meter is powered off before the tamper has been registered
	Now when the meter is turned on with only voltage applied, then the current unbalance icon turns on
 
VERNO for Gujarat Unidir has been made 00
12:08 pm
Code being sent

12:51 - Gaurav informed that
When there is no current, in the phase pf values come randomly as 0.01,0.02 etc
If a tamper is recorded then these pf values appear, as they do when instantaneous parameters are downloaded
Need to be fixed - DONE
In getInstantaneousParams where the linepf is sought, if the pf value is < 0.085, it is treated as 0.0

To make changes for BIDIR
0) ctldata checksum is computed every minute and capturedRTC.Control is used for storing the checksum - applies for BIDIR too
1) checking integrity of ctldata and capturedRTC when power returns - applies for BIDIR too
2) for TOD values on display, the update is now done every second, and the current energy values - already done mostly 
   are displayed instead of the last saved values
3) Same is been done when billdata is sought from DLMS - applies for BIDIR too
4) Fluctuation in value of systemPF has been addressed - applies for BIDIR too
5) TOD zone definitions have been corrected for 1100 hours - already corrected in BIDIR
6) High MD report in field should not occur any more, if it was caused by ctldata corruption - applies for BIDIR too

14:35
Code for both Unidir and Bidir are being sent


////-------------------------------------------------------------------------------------
29/12/2021
Code is being sent to Gaurav today - Following changes as listed in dates 28,27 and 25/Dec/2021 have been made

0) ctldata checksum is computed every minute and capturedRTC.Control is used for storing the checksum
1) checking integrity of ctldata and capturedRTC when power returns
2) for TOD values on display, the update is now done every second, and the current energy values 
   are displayed instead of the last saved values
3) Same is been done when billdata is sought from DLMS
4) Fluctuation in value of systemPF has been addressed
5) TOD zone definitions have been corrected for 1100 hours
6) High MD report in field should not occur any more, if it was caused by ctldata corruption

PENDING

1) RTC calibration
2) Change in Auto reset date
3) Using CRC instead of Checksum

Hex file sent at 10:36

11:45
what about the integrity of myenergydataand mymddata and for that matter a host of structures checked upon reset?

*******************************************************************************************************************
	init_read_common_data(); // this is the common meter data - 3
	g_Class07_Blockload_CapturePeriod=Common_Data.survey_interval*60;
	
#ifdef TN3P_BOARD

	if(Common_Data.displayProgrammed==0)
		copyFactoryDisplayProgram();
	else
		loadDisplayFileFromE2Rom();
		EPR_Read(DSP_PROG_ADDRESS, (uint8_t*)dspArr, DSP_ARRAY_SIZE);
#endif

	init_read_lastBillDate();	// read the last bill date
	init_read_ctl_data(); // - 5
	
	capturedRTC.second = 0;
	capturedRTC.minute = ctldata.minute;
	capturedRTC.hour = ctldata.hour;
	capturedRTC.day = NOT_SPECIFIED;
	capturedRTC.date = ctldata.date;
	capturedRTC.month = ctldata.month;
	capturedRTC.year = ctldata.year;
	
	retval = isCheckSumOK((uint8_t*)&myenergydata,sizeof(myenergydata));
	if(retval==0)
	{// check sum is not ok - we need to pick up these values from the multiple sets that have been stored
		init_read_energies(); // this common function reads all the energies
		update_saved_energies();
	}
	else
	{// here the checksum is ok
		if(total_energy_lastSaved==0)
		{// this will happen only if there was a reset
			update_saved_energies();
		}
	}
	init_read_md_data();  // this reads md values etc - current meter data
	init_read_tod();  // zone definitions and current zone data
	init_read_passive_tod();	// read the passive zone definitions and the activation time/status
	init_read_single_action_activation_data();	// read the activation time for single action schedule and status
	init_read_tamper_data();  // mytmprdata and pointers
	init_read_secret_keys();
	do_initial_things();  // this needs to be shifted to the area where power on is detected?
	gWhichPort=3;
	asendbare((uint8_t *)"Entering Loop\r\n");  	

	if(CALSW==0)
		calswitch=0;
	else
		calswitch=1;	
*******************************************************************************************************************
	





////-------------------------------------------------------------------------------------
28/12/2021
Plenty of changes are going to be made - 
An intermediate Copy(16) will be saved before making any further changes - 
This folder compiles to nothing
The last code that was sent was PCB_VER2_5_EEPL3P_GUJARAT_UNIDIR_TESTING_ONLY_27_Dec_21
Changes made for this testing code have already been undone

Changes as sought by Gaurav are to be implemented
Rohit has suggested the use of CRC16

When power fails and returns, we do not seem to be checking and verifying the integrity of
various ram variables - things like ctldata, capturedRTC, energies,etc may be need to be verified
for integrity

There is also a requirement of see current values on display as well as bill data where the			- 	DONE
last saved values are used - this is applicable to tod registers also

rtc calibration to be implemented.

fluctuation of systemPF - Computation has been changed slightly to avoid fluctuation due to truncation - DONE - TO BE TESTED

In the capturedRTC value when power fails, the Control byte is now used to store the checksum of the capturedRTC  - DONE
When power returns, the checksum (Control) of the capturedRTC is verified and if found corrupted, then
the capturedRTC values are repopulated with the ctldata date and time.

////-------------------------------------------------------------------------------------
27/12/2021
In response to the excessive md being made, code is being sent today
Attempt is being made to ensure that the ctldata checksum is computed whenever its component
values are change in per_minute_activity
While recovering from power fail, the checksum is being verified before calling do_initial_things

A command is being provided to corrupt the ctldata, make the energy values 0
A flag should also get setto prevent the per_minute_activity function from being called
This flag should get cleared when power returns

A flag CTL_FAULT_DEBUG was created, and hex file for testing sent. 
PCB_VER2_5_EEPL3P_GUJARAT_UNIDIR_TESTING_ONLY_27_Dec_21.hex

The flag is now being commented

In per_minute_activity, the ctldata.chksum is being updated on every entry

Also in powermgmt->POWERMGMT_ProcessMode1, the ctldata chksum is being verified, and if it 
is incorrect, then data stored in e2rom is used before calling do_initial_things


////-------------------------------------------------------------------------------------
25/12/2021

Gaurav's email of 23/Dec/2021
The following points to be addressed in Gujarat Unidir meter code dated 20 dec 2021
1. PF displayed on display to be refreshed every second or alternate sec. DONE
2. TOD kwh on display is being updated after 1 kWh ( or when Power =0;) it should be updated at every 0.1 kWh .
3.  Currently TOD zones definitions are -	DONE
Id     zone         script id 
0          0000          1
1          0600          2
2          0700          3
3          1100          2
4          1800          3
5          2200          1

change script is of zone "1100" from 2 to 4 

4. Currently we are saving kwh at 1 kwh or power = 0; . can we change it to 0.1 kwh for samples . DONE
   (ii) when any TOD zone switches then also we have to save energy data  
	 (if MDIP is greater than TOD zone time , at that time when the zone switched to the next zone ,
	 energy is not saved. )

5. Can we implement "change in auto reset date " & single action schedule separately by single action schedule.   NOT DONE
 (currently when doing  single action schedule it always becomes auto reset date .)  -Not on priority 

6.(Field reported issue) some meter's MD are recorded very high (55-60kW) 
   after analyzing downloading report of particular meters we found that, 
	 when meter's  power fail occurs and returns after few hours or days then 
	 meter showing a very high jump in kwh consumption in last load survey interval
	 (when actual power fail occurs)   . 
	 
	 

   Meter power fail occ     22/10/21   09:13:20   
   Meter power fail restore  22/10/21 14:28:33
   now load survey entry at 22/10/21 09:30 records very high consumption like 15-20kwh )   
   customer's normal consumps for other intervals are around 2-3 kwh for the entire period. 

////-------------------------------------------------------------------------------------
20/12/2021
A Copy(15) has been saved.
Gaurava's mail of 14/Dec/2021
Dear Sir 
I need Gujarat unidir code as per h.w. ver. 2.5 , last code used as per h.w ver 2.5 was" EEPL3P_GUJARAT_BIDIR_FACTORY_VER_00_24_Jun_21" 
older unidir code as per h.w. ver. 2.3 (obsolete)  
The earlier BIDIR code was saved in Copy(11)


The board GUJARAT_UNI_DIR_METER has been defined

Display and tamper files need to be changed

////-------------------------------------------------------------------------------------
29/08/2021
A Copy(14) has been saved
////-------------------------------------------------------------------------------------
26/08/2021
For DVVNL - we are providing a DVVNL_OPTION
11:53 Hex file being sent for DVVNL
////-------------------------------------------------------------------------------------
21/08/2021
We can now look at generating the DVVNL code

Gaurav's email of 17 Aug:

Please make below change in PVVNL code (it is separate requirement from PVVNL known as DVVNL  ) 
1. When checking for missing potential tamper then condition is 
Occurance :When phase voltage is less than 50 % vref (120V) 
And phase current is 10% of Ib (1 amp.)
Persistence time 5 mins.
Restoration: when phase voltage is greater than 60% vref (144V)
And phase current is greater than 10 % In (1 amp.) 
Persistence time 2 mins. 

Since this is a specific change between PVVN and DVVNL - this may be achieved by 
#define MISSING_POTENTIAL_CHECKS_CURRENT
If defined then the Current will be checked, else it will not be checked.

Additional #defines

#define EVENTDATA_RECORDS_KVAH	// eventdata_t is 36 bytes in this case

////-------------------------------------------------------------------------------------
20/08/2021

Gaurav had reported a bug in daily log which was not sending data after a few date changes

The error in r_dlms_data_mete->R_OBIS_Class07_FilterOneDailyLoadEntry() has been corrected
It was not accounting for the case when SMALL_DAILY_LOG was not defined as in PVVNL

10:18
The corrected hex file is being sent now.

15:53
Gaurav has indicated some mixup in recording of AC and DC magnets
We have added an interlock in tampers_PVVNL->check_setTamper
If a DC magnet tamper is ready to be recorded, then we check to see if there is an AC magnet tamper already recorded
If it is then the DC magnet event is not recorded.

Similarly if an AC magnet tamper is ready to be recorded, then we check to see if there is a DC magnet tamper already recorded
If it is then the AC magnet event is not recorded.

15:57
Sending this code

ABOVE CHANGE HAS ONLY BEEN MADE IN tampers_PVVNL.c
IF FOUND TO BE GOOD IT WILL ALSO NEED TO BE IMPLEMENTED IN tampers.c 

////-------------------------------------------------------------------------------------
18/08/2021
Gaurav has also sent code requirement for DVVNL which is slightly different from PVVNL

Changes sought in PVVNL have been implemented.
 Code being sent for Harware PCB_2_5
////-------------------------------------------------------------------------------------
17/08/2021
This folder compiles to PCB_VER2_EEPL3P_POINT_FIVE_CT_METER_FACTORY_VER0_00_13_Aug_21

Gaurav has sent two requests
1. For LT-CT meter (POINT 5 Class)
2. For modifications in PVVNL code

Change for LT ct 0.5 class meter hw 2.5.1
1. Remove calibration check points  from production mode	- DONE
2. In DLMS data name plate details IC-7 change meter category to C-1 - DONE

The code sent on 13_Aug_21 was with the #define CHECK_CAL_CONDITIONS
This causes the voltages and currents to be checked before calibrating
We need to comment this - It is better to shift this #define to the board.h file - DONE

If the above 2 changes are undone then code matches PCB_VER2_EEPL3P_POINT_FIVE_CT_METER_FACTORY_VER0_00_13_Aug_21

11:24
Hex file being sent with the above changes and a Copy(12)is stored as reference - NOT SENT
This file is drastically different from PCB_VER2_EEPL3P_POINT_FIVE_CT_METER_FACTORY_VER0_00_13_Aug_21

12:00
Gaurav has just now informed that PCBVER_3 is actually PCB_2_5
There is no version 3 - It is actually version 2.5 - and the earlier version in production was version 2.3

We will first save a Copy(12) before making any further changes - DONE

Now we will change all references of PCBVER_3 to PCB_2_5  - DONE
After this change the production.hex file matches PCB_VER2_EEPL3P_POINT_FIVE_CT_METER_FACTORY_VER0_00_14_Aug_21_NOT_SENT

So far so good

12:09
We will now compile this file with the PCB_2_5 option commented - This should produce PCB_2_3 code - DONE

Hex file is being sent for PCB_2_3 code which is essential that the #define PCB_2_5 is commented.
 
Post lunch
14:45

Will now generate code for PVVNL
The folder Copy(8) contains the last recorded configuration for PVVNL- Some changes were made in Copy(9) too which was then used
to make code for the POINT_FIVE Class meter.

Similarly a copy(12) of this folder has been saved which contains references to PCBVER_3
This folder now used PCB_2_5 and if the #define is commented then this folder will producecode for PCB_2_3

Code has been sent at 12:20 for POINT_FIVE CT meter

Now we will make the necessary changes to produce the PVVNL meter

Just for heck's sake we will save a Copy(13) to preserve the POINT_FIVE CT meter sent today  - DONE

We will now replace the display and tamper files - DONE

Changes need to be made to the display and tamper files accounting for use of script_ids
and PCB_2_5


Changes In PVVNL code (last code used EEPL3P_PVVNL_UNIDIR_FACTORY_VER_00_07_May_21)

1. Add daily kWh data for 35 days (kWh, kVAh,Kvarh lag, Kvarh Lead)- DONE
2. Add   (i) Avg. Power factor - DONE
      (ii) Voltage all phase	- DONE
      (iii) Current all phase	- DONE
at the last of auto scroll parameters list
3. display Battery status & NVM status on display - DONE
4. add high resolution kWh in push button mode after cum kwh - DONE
5. when scrolling display parameters in battery mode then communiton gets "on" - NO ACTION TAKEN


DVVNL  will be the same as PVVNL code - hence tamper and display files will be the same
There is a requirement 

1. When checking for missing potential tamper then condition is 
Occurance :When phase voltage is less than 50 % vref (120V) 
And phase current is 10% of Ib (1 amp.)
Persistence time 5 mins.
Restoration: when phase voltage is greater than 60% vref (144V)
And phase current is greater than 10 % In (1 amp.) 
Persistence time 2 mins. 


////-------------------------------------------------------------------------------------
13/08/2021
A section was added in wrp_mcu.c file for IS_MCU_RUN_AT_015MHZ
This was done after the making the file PCB_VER3_EEPL3P_GUJARAT_BIDIR_FACTORY_VER_00_24_Jun_21
Hence this folder does not compile to PCB_VER3_EEPL3P_GUJARAT_BIDIR_FACTORY_VER_00_24_Jun_21

Trying to see if undoing those changes in wrp_mcu if we can recreate the file
Because these are the only changes between this folder and Copy(10)

It works - This folder produces a hex file matching PCB_VER3_EEPL3P_GUJARAT_BIDIR_FACTORY_VER_00_24_Jun_21

We will save this as Copy(11) before making any changes for POINT_FIVE_CLASS_METER 

The last POINT_FIVE_CLASS_METER was sent using the folder E:\PRAVAK_this\RNSS3P20\Source3P_BIDIR_GUJARAT - Copy (28)

We now need to send the POINT_FIVE_CLASS_METER CODE USING PCB3 option - hence we will build it using this folder
Some comparisons will be made with the Copy(28) folder to verfiy that we have not missed anything significant.

Before anything else a Copy(11) is being saved

Now to build the POINT_FIVE_CLASS_METER
The #define POINT_FIVE_CLASS_METER has been uncommented
The #define PCBVER_3 is already defined in emeter3_structs

Checking METER_CONSTANT_6400	-	DONE OK
All the other options selected are normal
Check on POINT_FIVE_CLASS_METER - DONE OK

We now need to check the Display file em_display_Gujarat with BIDIR_COPY(28)
Since BIDIR_METER is not defined for this option it is a Unidirectional meter

The display file matches for content
In this folder the TOD zone clubbing is being done through Script ids.

This is definitely the latest implementation and the code will be sent now
////-------------------------------------------------------------------------------------
23/06/2021
Please find observations in attached code
1. When meter is in battery mode , then Vcc-5 (ac magnet sensor supply) is still available. 
		AUX_OUT in powermgmt->POWERMGMT_ProcessMode3 was being set to 1 This pin was P53 - CORRECTED
2. When I doing dc magnet test icon appears some time later (please do as per PVVNL code ) 
////-------------------------------------------------------------------------------------
23/06/2021
1. P53 (pin 78) is to be made low in battery mode - This pin generates VCC5 - DONE
2. P62 is not to be used for VRTC Backup Supply - DONE
3. P125 is to be used for VRTC Backup Supply	- DONE
	 
////-------------------------------------------------------------------------------------
21/06/2021
A Copy(10) is being saved
Hex file has been sent on 18/Jun/2021
////-------------------------------------------------------------------------------------
18/06/2021
A new PCB Version 3 has been made for 3P meters

This is mail received from Gaurav on 16/Jun/2021
As discussed please find attached updated schematic of 3 phase meter ( version no. 2.5) with change logs.

MCU 	Port			Old PCB (used In production 2.3)		New PCB (3.5 )
Pin
 6		P43				Magnet sensor 3											Not used
 7		P42				AC Magnet sensor 5									not used
12		P150			Supply for VRTC pin									not used
27		P62				Test point for RTC clock check			Supply for VRTC pin
33		P125			Magnet sensor 1 detection						Not used
35		P36				VCC pin for Magnet sensor						Not used
39		P32				not used														Test point for RTC clock check
77		P54				Magnet sensor 2 detection						Detection for AC magnet
78		P53				Not used														supply for AC magnet
81		P50				Magnet sensor 4 detection						Detection for DC magnet
100		P07				vcc for AC magnet										Not used
 

Note: In this hardware version all 3 DC magnet sensors  are connected to the same pin  (Pin 81) 

A new #define PCBVER_3 has been created - This will automatically account for all the changes above
NOTHING IS DONE FOR TEST POINT FOR RTC CLOCK

////-------------------------------------------------------------------------------------
03/06/2021

Gaurav's mail of 02/Jun/2021
(A)Dear Sir
please make below change in TOD zone
1. currentzone setting is as follow
zone id   Zone    script id
  0        0000       1
  1        0600       2
  2        0700       3
  3        1100       2
  4        1800       3
  5        2200       1

for DLMS billing data -change script id 4 of zone id 3
for Dispay -no change required 

FOR THIS REQUEST FOLLOWING ACTION IS TAKEN

For DLMS the new zone and script definitions will be as follows 

zone id   Zone    script id
  0        0000       1
  1        0600       2
  2        0700       3
  3        1100       4
  4        1800       3
  5        2200       1

Now this will cause energy to be accumulated in four registers
For display purposes, script ids 2 and 4 will be clubbed in the display function ("Remaining")
IT IS TO BE NOTED THAT THIS CHANGE WILL BE HARD CODED IN THE DISPLAY FUNCTION
IF SCRIPT IDS ARE CHANGED THEN SCRIPT IDS 2 AND 4 WILL ALWAYS BE ADDED IN THE DISPLAY

(B) In DLMS data when reading instantaneous frequency in IC-3 it showing wrong value due to its scalar unit 
kindly changes its scalar unit to "0" currently it is "-1" 
frequency value 50
scalar                10-1
  value becomes 50 x 10-1 = 5 Hz

FOR THIS REQUEST FOLLOWING ACTION IS TAKEN
	
In the r_dlms_user_interface function the frequency obtained by getInstantaneousParams(IFREQS, LINE_TOTAL)
has been multiplied by 10 - NO change made to scalar unit which remains -1
	

09:45 Hex file sent dated 03/Jun/2021

////-------------------------------------------------------------------------------------
30/05/2021
Gaurav's mail of 28 May 2021

Dear Sir 
In gujrat Bidir meter It has been observed that when auto scroll mode parameters are being scroll.
a) When meter starts from power fail then repeated parameters stars repeating after R phase voltage. 
   Which is 2 nd parameter of the list (1st is meter serial no.)
b) when meter starts scrolling as per above point , repeated parameters are stopped repeating after
   14 or 15 parameter of the list and remaining parameters scrolls without repeated parameters till 
	 3rd last parameter of the list.
c) after 1 or 2  complete cycle it works correctly. 


Previous pendency 
TOD implementation as per script IDs


The current implementation of TOD zones is as follows

Start		Zone		Range		Script	

	0				0			0-6				1
	6				1			6-7				2
	7				2			7-11			3
	11			3			11-18			4
	18			4			18-22			3
	22			5			22-24			1
	
Hence the energies are combined as follows - energy is stored in six registers indexed according to zone numbers

Script		TOD Zones		Names

	1				0 and 5			Night hours
	2				1						Remaining Hours
	3				2 and 4			Peak Hours
	4				3						Remaining Hours
	
In the new findZone function the zone number is not returned, instead the (day_action0[0].script_selector-1) is returned
This has an effect of grouping / combining the time zone definitions registers into script registers

If the start time definitions are left intact, this is what will happen

Start		Zone		Range		Script	

	0				0			0-6				1
	6				1			6-7				2
	7				2			7-11			3
	11			3			11-18			2
	18			4			18-22			3
	22			5			22-24			1
	
and the new script tod zone relationship will be as follows

Script		TOD Zones		Names 

	1				0 and 5			Night hours
	2				1	and 3			Remaining Hours
	3				2 and 4			Peak Hours

since script_selector now defines the register to be used, we don't have to do any summations
Also the MD's will also be simply computed.

For Unidir Gujarat the day_action0 has four scripts,
	
Start		Zone		Range		Script	

	0				0			0-6				1
	6				1			6-7				2
	7				2			7-11			3
	11			3			11-18			4// THIS is different in Gujarat Unidir
	18			4			18-22			3
	22			5			22-24			1
	
and the new script tod zone relationship will be as follows

Script		TOD Zones		Names 

	1				0 and 5			Night hours
	2				1						Rest
	3				2 and 4			Peak Hours
	4				3						Off peak
		
The day_action0 variables in r_dlms_data_ic.c have been separately defined for GUJARAT_UNI_DIR_METER
and GUJARAT_BI_DIR_METER meter

Implementing the above changes in both Bidir and Unidir Gujarat

We now need to fix the Display problem observed by Gaurav

Gaurav has reported problems while returning from power off condition

Two corrections have been made. One is the setting of various display related flags when meter enters 
POWERMGMT_MODE1. The second is in the main(), there was a special code for Gujarat for Mode 3, in which
only the repeat parameters were being shown. This code had somehow got removed, in the BootLoader version
which has now been reinstated

Also when meter enters POWERMGMT_MODE1, all flags such as fwdkeypressed etc have also been zeroed 

This ought to fix the issues

09:55
A test code for Gujarat BIDIR version 00 is being released

////-------------------------------------------------------------------------------------
14/05/2021
A Copy(9) has already been saved
Gaurav has reported that Bidir Gujarat meters have a problem regarding rising demand
It is possible that when meter undergoes a reset, the cltdata.kwh_last_saved values may be greater
then myenergydata.kwh since kwh is being saved every 1000 units(wh)
This will cause the rising demand to be computed as negative and not displayed
This may explain various malfunctions reported by Gaurav as per mail and quoted below

Dear Sir 
Code checked 'EEPL3P_GUJARAT_BIDIR_08_Dec_2020_1405_NODEBUG' ver. no. 3601.8b1

i have some issue with Gujrat Bidirectional meters display parameters "Rising demand  EXPORT" 
  here below i am sharing some observations 
1. when meter returns in power mode from sleep then EXPORT RD shows some uncalculated values 
   (meter runs in export mode for 15 min. RD at 15th minutes was 2.51 kW , then meter turned off 
	 for next 20 mins , & when meter powered up it has been noticed that recording of MD was correct
	 but RD values still showing "4.86" while meter has no power & after completing integration period
	 MD recorded same (4.86)
2. some times when meter powered up in export mode but RD demand not rising (remains 0.00) for time
   after that it stars rising from 0.0 , also some times it starts after completing 
	 integration period of 30 mins. 
	 
A mistake was noticed in do_initial_things which has been corrected
    ctldata.kwh_last_saved_export=myenergydata.kwh;  // this was there earlier
    ctldata.kwh_last_saved_export=myenergydata.kwh_export;  // it has been corrected now

If md interval is crossed then ctldata gets updated and is written into e2rom
If the md interval was not crossed then the incorrect ctldata values would persist

Hence an else has been added to if(doMD==1)
In this else 
	if(myenergydata.kwh<ctldata.kwh_last_saved)
		ctldata.kwh_last_saved=myenergydata.kwh;
Above has been done for kvah, kwh_export and kvah_export too.		
		
In the display and DLMS code also if(myenergydata.kwh<ctldata.kwh_last_saved) then ctldata.kwh_last_saved will be updated

The TOD implementation is now different - This will cause the TOD values to be shown incorrectly
New TOD returns the tod register as per the script_id
The Gujarat display file computes tod for a particular script by adding the TOD's for different zones
Need to make the requisite changes 

We will let the definitions of TZ_start_time0 remain the same - Changes will only be made in the display file

TOD changes will be done later

A hex file is being sent Version 00
////-------------------------------------------------------------------------------------
07/05/2021
Gaurav's feedback on code of 06/May/2021
1. when dining 2 wire operation ( only any 2 phase connected to meter without neutral) meter accuracy reaches -25 %


Two wire operation check is preceded by checking for Missing Potential
PVVNL does not use current to check missing potential - Hence when there is two wire operation
one of the phases potential gets logged as missing potential - this also prevents two wire operation
from being checked

WILL REMOVE THE MISS POT CHECK - NOW TWO WIRE OEPRATION WILL WORK AND MISSING POTENTIAL WILL BE LOGGED - IMPLEMENTED

2. when doing ac chopped signal test rev. icon appears . ( while on applying chopped ac signal meter detects it as ND)
REVERSE CHECK IS NOW BEING DONE ONLY IF THERE IS NO NEUTRAL DISTURBANCE - IMPLEMENTED

11:05 Hex file sent

////-------------------------------------------------------------------------------------
06/05/2021
In continuation with feedback of 03/May/2021
Gaurav's feedback on 06/May/2021
1. ND tamper to be recorded when any one phase has voltages greater than 360 V (150%of In) 
   persistence time 20 seconds for both occurance as well as restoration. DONE. 
2. When scrolling mode 1 (auto scroll mode) parameters by using push button than last - DONE
   (when scrolling stoped) should remain available at display for 5 minutes currently 
	 returning in 1 minute.(Mode 2  is okay) 
3. Over current tamper to be recorded when any phase current is greater than 72A (120% of Ib) - DONE
4. DC magnet - sometimes icon does not turn on at DC magnet while meter logs event. - DONE

15:15 Hex file sent
////-------------------------------------------------------------------------------------
03/05/2021
Gaurav's feedback on 30/Apr/2021

when performing DC magnet test at meter it has been found that sometimes MAG icon does not appear 
but meter start logging tamper at its persistence time .

NOTE: in Gujrat Unidir code ( with boot loader ver. 26 ) some times icon appears  after 48 seconds
meter logs event from appearing the icon 

No changes were made - However following were observed

1) Gaurav had indicated that removing the ac magnet hall sensor had caused the problem to dsappear
	Hence the ac magnet algorith was probably clashing with the dc magnets
2) Persistence time for magnet has been reduced to 10 seconds, but for ac magnet detection etc,
   58 seconds is continuing
3) acMagnetSense clears the HALLSENS_MASK flag which causes the icon to disappear probably
////-------------------------------------------------------------------------------------
27/04/2021
Gaurav had sent a feedback on 26/Apr/2021
1. During C-open event meter displaying C-open with date and time with a gap of blank screen for 5 seconds. 

A Copy(8) has been saved

10:07
Changes have been made and new hex file sent

////-------------------------------------------------------------------------------------
22/04/2021

Gaurav's feedback on 21/Apr/2021
please find below observations 
1. when capturing snapshot values for events , kvah value is being recorded as 0 always . DONE
	  While transferring data frome eventdata to g_Class07_EventBuffer the apparent energy was not being updated - FIXED
2. when doing current bypass tamper it is being logged when difference is greater than 10% of Ib( 1 Amp.) 
   change it to 15% of Ib (1.5 Amp)
	 In the logic of CTBYPASS ineutralDiff is now being compared to 145 (1.5A) - FIXED
	  
3. After c-open event c-open massage is appearing with date and time but it is scrolling per second 
   change it to 5 seconds.
	 When cover tamper is first set in powermgmt, at the time of registering the cover open tamper
	 the variable g_cover_display_state is made 255 and cover_disp_timer is equated to 10
	 In the displayCOPEN, when it enters the first time, the g_cover_display_state is incremented
	 Hence COPEN is displayed first
	 The cover_disp_timer being 10 also causes the display to be updated immediately in the first instance 
	 
10:15
	Hex file sent	 

////-------------------------------------------------------------------------------------
21/04/2021

Plenty of changes had to be made to accomodate the change requests of 20/Apr/2021

12:14
Hex File mailed
////-------------------------------------------------------------------------------------
20/04/2021

Gaurav's observations

following are the initial observations 
1. In push button mode Display parameters  below parameters are missing 
   (i) Cumulative power on hours for L2 are missing - DONE
   (ii) Tamper data - DONE
				1.Present status of tamper:
					a) Missing potential with phase identification
					b)      Current  polarity reversal with phase identification
					c)      Current  short & open.
					d)     Other tampers(magnet. ND)

				2.  Date and time of last tamper occurrence with tamper identification
				3.  Date and time of last tamper restoration with tamper identification.
     		4.Cumulative tamper count of all types of tampers
				
2. In push button mode when displaying LCD check the few icons are not glowing (MAG/BYPASS/MISS/VolUnBL/CurrUnBL/Rev.)
 
3. Meter is not recording energy in correct TOD slot(It is 14:38 according to time consumption 
   should be recorded in TOD 8 but is being record in TOD 6) 
4. In load survey data no. of profile entries is showing 8640 , 
   it means we are recording 180 days load survey data. 
5. Push button modes should return to auto scroll mode after 5 minutes , 
   while it is returning back in 1 minute and 10 seconds to auto scroll mode 
   ( There should be a indication when meter returns to auto scroll mode, like Auto/ Mode 1) 

in continuation to previous mail
Point No. 3  "Meter is not recording energy in correct TOD slot ( It is 14:38 according to time consumption
  should be recorded in TOD 8 but is being record in TOD 6)"
	script Ids are not correct for active calendar . resultant energy is not recording to their respective zones. 

10:44 Hex file (PRODUCTION) sent

14:42 Gaurav's feedback

Here are fresh observations 
1.  TOD registers to be record energy in ascending order of TOD script IDs.
2. In push button mode display when displaying Last occurred/restored tamper time  it is not matching with recorded event time in DLMS data .
        ( In DLMS data meter is capturing staring time when tamper actually started or ended. but on meter display it is showing +5 minutes (when tamper logged) )
3. push button mode display shall return to  auto scroll mode after 5 minutes currently returning in 1 minute.
4. When Enabling communication in battery mode there should be some indication when comm. enabled like "dnlod" 
5. Display mode 3 ( high resolution mode) is no longer required kindly remove it. 
6. When capturing snapshot values for event please add kvah also 
Addition to previous mail.
7. Once C-open event occurred then C-open massage shall be displayed continuously along with date and time of occurrence. 

Since major changes will be made to the findZone function, a Copy(7) will be saved
Copy(7) produces hex file of EEPL3P_PVVNL_UNIDIR_FACTORY_VER_00_20_Apr_21


Point No 1
CHANGES HAVE BEEN MADE TO FINDZONE FUNCTIONS FOR BOTH SIX AND EIGHT ZONES
THE FUNCTION WILL NOW RETURN THE (SCRIPT NUMBER -1) OF THE ZONE

Point No 2
We have the functions recordInstantaneousData, getCurrentInstantaneousData, and readInstantaneousData in memoryOps module
There is also a function called recordInstantaneousDateTimeEnergy
The recordInstantaneousDateTimeEnergy records the value of Time and Energy 1 second after the event occurs / or is restored
The recordInstantaneousData is called when the actual persistence interval has been completed
For the storage of datetime of occurence / restoration of the last and the second last tampers
we are doing so at the end of the interval - THUS THE DATE TIME DO NOT MATCH - THIS NEEDS TO BE FIXED

A new function readInstantaneousDateTime has been added in memoryOps - The energy value and the time are recorded one second
after the event is first detected - The code which stores the last and second last tamper details in set_tamperEvent_image
and clear_tamperEvent_image reads the date and time by calling readInstantaneousDateTime

THIS HAS CURRENTLY BEEN IMPLEMENTED ONLY IN tampers_PVVNL.c module	- DONE

Point No 3
Time has been changed to 5 minutes - DONE

Point No 4 - DNLD message
A message COMM-On will be displayed - DONE

Point No 5
High res display removed

Point No 6 - Addition of kvah in tamper event record - DONE

Point No 7 - Continuous display of C-OPEN with date and time - DONE

Point No 8 - Size of survey data - No of records (62) - DONE

Point No 9 - Change of tampers as per PVVNL - DONE
////-------------------------------------------------------------------------------------
19/04/2021

A Copy(5) of this folder had already been saved

A Copy(6) is being saved today

The difference between the two folders is that Copy(5) makes mot files and Copy(6) makes hex files

This issue needs to be fixed as we have a mot2bin which converts phase.mot to phase.bin and we
do not have a program to convert a hex file to bin

On the contrary the gang programmers at eppeltone do not burn mot files.

Hence the Copy(6)

Gaurav has sent a word file requiring code for PVVNL 10-60 meter
Display file and tampers etc are different

Changes to be made in Gujarat Unidir


PVVNL_UNI_DIR_METER has been defined in board_h
A Copy of em_display_Gujarat.c is made and renamed em_display_PVVNL - DONE
A Copy of tampers.c is made and renamed tampers_PVVNL - DONE
TOD zones have to be redefined - DONE

////-------------------------------------------------------------------------------------
04/03/2021
Version 26 is being released
This is for Gujarat Unidir

Following files are being released
1)A Bootloader.mot
2)A combined file containing bootloader and application EEPL3P_GUJARAT_UNIDIR_FACTORY_VER_026._mot
3) A Bootable image for the application EEPL3P_GUJARAT_UNIDIR_IMAGE_VER_026._bin

Files are released in a folder called ReleaseBundle_04_Mar_2021
////-------------------------------------------------------------------------------------
10/02/2021
Version 24 is being released
This is for Gujarat Unidir

Following files are being released
1)A Bootloader.mot
2)A pvkbl.eed (containing encrypted password)
3)A combined file containing bootloader and application EEPL3P_GUJARAT_UNIDIR_FACTORY_VER_024._mot
4) A Bootable image for the application EEPL3P_GUJARAT_UNIDIR_IMAGE_VER_024._bin


////-------------------------------------------------------------------------------------
09/02/2021
All the changes in the ...\Source3P_BIDIR_GUJARAT folder upto 04/02/2021 have been updated in this
Application Folder
////-------------------------------------------------------------------------------------
29/01/2021
14:57
A Copy(3) is being saved before starting work

Following changes to be made:
1) Improve code for recovering energies upon reset, write and read etc
2) If kwh is to be assumed as 0 in any case, last energies must be picked up from the last bill
3) Provision to reset the meter to enter bootloading mode
4) Provision of a particular pass sequence to initiate bootloading
5) Provision to exit bootloading if no response received within a few milliseconds(500?)
and stuff like that (See objectives section of 11/01/2021

////-------------------------------------------------------------------------------------
12/01/2021
Sending bootcode and user code files to Gaurav
Version Number is 19
Code is for GUJARAT_UNI_DIR_METER
////-------------------------------------------------------------------------------------
09/01/2021
10/01/2021
11/01/2021
Got the boot loader working
Also learnt how to section the application program to start at 0x4000
Had to insert an .ORG statement in the cstart.asm file and started the T01_Trigger_n from 0x4100 onwards

The sections information is as follows:

[Section Information]
Version=1.0
Entry=6
Group1=T01_Trigger_n,.sdata,.constf,.data,.text,PFDL_COD,.textfbss_f,WrpAdcText_f,WrpAdcConst_n,EMMetroConst_n,.RLIB,.const,.textf,.SLIB,EMMetroText_f(04100)
Group2=ADC_Data_n,.bss,.dataR(FC400)
Group3=DTC_Vect_n(ffd00)
Group4=DTCD0_n(FFD40)
Group5=DTCD1_n(FFD48)
Group6=.ramvect_n,.sbss,.sdataR(FFD50)

I have the On Chip Debug option enabled at present - Need to see if there is any effect when this option is disabled

I will remove earlier folders of Source3P_BootLoader by archiving them under Failed Bootloader code
and rename this folder from Source3P_BootLoader_Test to Source3P_BootLoader

This folder has been compared and updated with Source3P_BIDIR_GUJARAT
A Copy(2) has also been saved before making any further changes

18:07
Status as of now is that the bootloader and application code appear to be working fine
One loaded the bootloader first, and then loaded the application via the phase.mot route
The application is working fine

We now need to make some changes to the bootloader program

Objectives

1) Reduce the timeout so that if no input is received on the serial port then it should exit in say 100 to 500 ms
2) Make sure that only genuine activity on the serial port is recognised
3) Add code in the application code to allow the meter to be reset - this is required when the firmware
	 needs to be updated
4) Would be nice to have a facility to verify that the image entered from 0x04000 is correct
5) While in console mode - to wait for a signal to start the freshly loaded program
6) Allow a timeout in console mode which is say of the order of several seconds before jumping to application
7) Whenever a reset occurs to ensure that application code is run as soon as possible (100ms target)
8) We may need to update the communication routines in the bootcode
////-------------------------------------------------------------------------------------
08/01/2021
Chu Lih Kwek (CLKWEK) from Singapore and Vikas Sharma had been working on this code well past midnight
Singapore time
Could not fix the problem
Had added a watchdog reset in timer3 interrupt (r_tau0_channel3_interrupt) in r_cg_tau_user.c
Had also added a watchdog reset in r_dsadc_interrupt in the r_cg_dsadc_user.c
Observation was that something was causing excessive load on the CPU resulting in
the code in the main loop functioning too slowly resulting in a watchdog reset / illegal function reset


My observation is that this is being caused by the _r_dsadc_interrupt_asm being mapped to RAM
I feel that after the dsad interrupt has been mapped into RAM the intdsad_interrupt becomes
the service routine which calls the existing assembly function _r_dsadc_interrupt_asm

A procedure is followed to convert the _r_dsadc_interrupt_asm to a regular routine by comenting
the vector directive and making the label _r_dsadc_interrupt_asm public

However, it turns out that context saving takes place in two places -

	First in the intdsad_interrupt which calls the _r_dsadc_interrupt_asm
	Second in the _r_dsadc_interrupt_asm itself as remnant of the earlier implementation as an interrupt
	
This could be causing the context to being incorrectly restored and resulting in the 
C code r_dsadc_interrupt being called repeatedly resulting in excessive CPU load 

09:57
Will attempt to test this hypothesis now

IT WORKED

A working copy of this code is being saved

////-------------------------------------------------------------------------------------
07/01/2021

Restarting

We will not map the dsadc interrupt to RAM
All others will be mapped
Need to find out why the RAM mapping works / does not work for some cases
and to identify those cases

NO_BOOT_CODE is commented in iodefine.h

Only some interrupts will be mapped

Only the rl78i1c project is being generated - there is no subproject yet

INTDSAD is removed from My_interrupts.c
intdsad_interrupt() is commented
The RAM_INTDSAD_ISR is not assigned in main()

This has worked
One can try another approach

Let us get the _r_dsadc_interrupt_asm assigned to RAM
1) Uncomment lines 3 and 4
2) Comment lines 6 and 7
3) Comment RETI
4) Uncomment RET
5) Uncomment #pragma interrupt intdsad_interrupt in MY_interrupts
6) Uncomment implementation of intdsad_interrupt
7) Assign RAM_INTDSAD_ISR = &r_dsadc_interrupt_asm

Now test the working
////-------------------------------------------------------------------------------------
06/01/2021
Have finally been able to get my application code running without the bootloader
Subproject has been done away with
The #define NO_BOOT_CODE has been used

Interrupts are defined regularly. This much is working fine
the r_dsadc_interrupt_asm had to be converted to an interrupt routine as the asm
file does not allow the use of NO_BOOT_CODE or at least I dont know how to do it
In the r_cg_cgc file the following line was added

// this has already been set in bootloader code
#ifdef NO_BOOT_CODE 
    CMC = _10_CGC_XT1_SELECT_ENA | _01_CGC_SYSOSC_OVER10M ;     
#endif    


Now we will change the interrupts to memory - Presently the NO_BOOT_CODE define will be commented

Changes will have to be made in the r_cg_cgc and the r_dsadc_interrupt_asm

There seems to be a problem, once the interrupts are mapped to memory
Stopping for the day
////-------------------------------------------------------------------------------------
05/01/2021
Analysis of the mot files of rl78i1c, phase and bootCode revealed that
the rl78i1c and phase are identical - except that the rl78i1c includes the vector table
the option code bytes and a few other things
However from 0x4000 onwards the code is the same

The rl78i1c itself does not seem to be working
One will confirm it again right now with "Erase Flash" option to remove all traces of BootCode
CONFIRMED - the rl78i1c itself does not work

The basic Application folder appears to be a match of Copy(30) or (31)
Changes include 
	Incorporation of a sub project boot code
	Addition of MyInterrupts and remapping of interrupts to RAM
	Loading and Executing from 0x4000
	Section layout is manual - with some warnings
	
One will attempt to use a switch "BOOTCODE" which is turned off would produce the application code only
Try executing from 4000 without interrupts being switched to ROM, using manual section layout
Try executing from 4000 without interrupts being switched to ROM, using automatic section layout
Try and figure out what is causing the problem

All interrupts are with #pragma and one interrupt is in an asm file


////-------------------------------------------------------------------------------------
03/01/2021

This thread involves integrating the bootloader with the metering application

The boot loader code sits at a lower end of the memory
All interrupts are mapped to RAM

The bootloader code is functional and allows the user code to be loaded into Flash
However after a successful call to the Application code which starts from 0x4000
the application goes through the startup function and messes up at around the time
the DLMS_Initialize function is called in phmstart

Surprisingly, the serial port UART3 stops working and even though there are bytes 
available in the transmit buffer, the send interrupt stops coming

Still do not know what is causing this bug -

It could also be how the sections have been defined

A copy(4) has been saved before starting work

What is interesting is that when the rl78i1c code is directly loaded into the MCU it 
shows the same symptoms

When the DLMS_Initialize call was commented the code proceeded upto step 12 or 123 in the LCD display
before resetting again

Building the rl78i1c generates the following warnings:

W0561100:Cannot find "WrpAdcData_n" specified in option "start"
W0561100:Cannot find "EMMetroData_n" specified in option "start"
W0561100:Cannot find "WrpAdcDataR_n" specified in option "start"
W0561100:Cannot find "WrpAdcBss_n" specified in option "start"
W0561100:Cannot find "EMMetroDataR_n" specified in option "start"
W0561100:Cannot find "EMMetroBss_n" specified in option "start"
W0561121:Address cannot be assigned to absolute section ".monitor2" in start option

Two map files rl78i1c_new and rl78i1c_regular have been analysed
In the regular case the allocation of sections is automatic whereas in the bootloader case
the allocation is manual - our manual allocation may not be perfect

////-------------------------------------------------------------------------------------
27/11/2020

Following changes requested

Upon power fail, and return, all tamper persistence counters must be reset
RECORD_DELAY to be made 15 seconds
A function clearPersistenceCounters()in tampers module has been added
which is called in POWERMGMT_ProcessMode1

VERNO is now 16

10:32 Hex file built and code sent for BIDIR meter GUJARAT 36016B1

13:30 Hex file built and code sent for UNIDIR meter GUJARAT 36016U1


////-------------------------------------------------------------------------------------
22/11/2020
GUJARAT BIDIR - 21/Nov/2020 - NODEBUG - 36014B1
I have verified all aboe points below is feedback
1. when feeding  current less than 99 mA then -(ve) sign in current  & power values appears in between value ( 0.-99)

This problem has been fixed by adding another variable to the function LCD_DisplayIntWithPos
uint8_t LCD_DisplayIntWithPos(long lNum, int8_t position, int8_t noOfDecimals)
The number of decimals is now intimated to the function which uses this value to determine
where the - sign is to be put

It has been verified that the display now shows the '-' sign correctly for numbers
having 0,1,2,3 decimals

18:25
BIDIR code being generated Version 36015b1 - NODEBUG

18:26 Code sent

     
////-------------------------------------------------------------------------------------
21/11/2020
A Copy(31) is being saved
09:33
Gaurav's email of 20/11/2020 - GUJARAT BIDIR - 20/Nov/2020 - NODEBUG

please find feedback 
1. For Class1 meter, current <=7 mA will be 0, per phase power <=1.6watts is 0 -	DONE
   "Change per phase Power to 2.4 watts" & for current 10mA 
2. When downloading Meter Data in battery mode , meter is sending  instant frequency's	- DONE
   value (50Hz) which should be "0"
3. After clearing C-open tamper, there is a dummy entry available in event id class (others)	- DONE
   with default date and 0 values for parameters. & when C-open tamper occurred again then 
	 these dummy values were replaced by correct values . 

Need modification in version no. 
  1	2		          3 4 5		       6			      7
  BoardID	      Version No	   B/U/T/S		Class(1/5)

Board ID should be frist 2 digits of  PIN code of respected  Board (ZONE)
For PGVCL (Bidir meter) Pincode starts with 36 hence Board ID should be 36

Digit 6   
B=Bidir, U=Unidir, T=Test code, S=sample.

addition to previous mail
1. when doing starting current test at 20mA  , then incrementation in energy should 0.00062	- DONE
   kwh per pulse while meter kwh counter increased by 0.001( initial 0.28000 after incrementation 0.28100)
	 
2. when doing starting current test at 20mA in Export mode then -(ve) sign disappeared from power
   .also meter is showing instant PF as 1.45 in this condition .
	 A CHECK OF pos <5 WAS BEING DONE IN function LCD_DisplayIntWithPos in em_display_common
	 for a 2 digit value such as 0098 the negative minus sign was not being displayed by code
	 THE CHECK (pos<5) has been removed 
	 
BIDIR code being sent Version 36014b1

////-------------------------------------------------------------------------------------
20/11/2020

EEOVER command should send the same string as displayed on LCD in PROD mode

The following description is for the seven digits for display meter version / type & class
	1		2			3		4		5				6			7
  BoardID	  Version No	   B/U		Class(1/5)

	dbuf[0] = BOARD_ID/10;
	dbuf[1] = BOARD_ID%10;
	
	dbuf[2] = VERNO/100;
	dbuf[3] = (VERNO - (dbuf[2]*100))/10;
	dbuf[4] = VERNO%10;
	
	#ifdef BIDIR_METER
		dbuf[5] =	LCD_CHAR_B;
	#else
		dbuf[5] =	LCD_CHAR_U;
	#endif
	
//	dbuf[6] = SPLCODE;	// not used any more
	dbuf[6]=METER_CLASS;

The same pattern will be used in response to EEOVER command

ZAP and ZPCL will work only in PROD mode

When can kwh become 0 after several years?

In update_energies_stored function both (kwh, kvah) and (kwh_export, kvah_export)
are now being checked for rollover

We need a check for CLRCVR since it works in USER mode
Added a check that kwh or kwh_export if > 2000 then CLRCVR won't work

For Class1 meter, current <=7 mA will be 0, per phase power <=1.6watts is 0
For Class 0.5 meter, current <=3 mA will be 0, per phase power <=0.6watts is 0

Will send Bidir hex file now with version code 13
DEBUG completely turned off

14:34
Code sent
////-------------------------------------------------------------------------------------
19/11/2020

Rohit's mail
To summarize our discussion, we need the following changes
For Class 1 meters – We need to ignore current <= 6 ma and forcibly make currents to 0
For Class 0.5 meters – We need to ignore current <= 2 ma and forcibly make currents to 0
For all meters we need to ignore voltage < 4 volts and forcibly make voltage to 0

1) If voltage goes below 4V it should be read as 0	always - DONE
2) If current goes below 7mA it should be read as 0	for Class 1 meter - DONE
2a)If current goes below 3mA it should be read as 0 for Class 0.5 meter	- DONE
3) Need to send code with Debug monitor not burnt into flash

Unidir code being sent with version code 12
ALSO DEBUG will be completely turned off
////-------------------------------------------------------------------------------------
18/11/2020
Gaurav wants that for Unidir Gujarat meter, if there is cover open tamper in battery mode
then pressing the pushbutton should cause the display to stop displaying C-OPEN and move
to displaying the other parameters

The change has been implemented - can be compared with Copy(30)

A Unidir code will now be built

09:25
Code for Unidir Meter built and sent

I am still able to debug the code - although the On Chip Debug Option has been disabled
AM NOT TOO SURE IF THE SECOND REQUIREMENT OF Set Debug MONITOR AREA is also required to be set to NO

////-------------------------------------------------------------------------------------
16/11/2020

09:18
GUJARAT_BI_DIR_METER Hex File of 15/Nov/2020 16:25 hours emailed

A Copy(30) is being saved to preserve this code
Option bytes are 7E39E0
////-------------------------------------------------------------------------------------
15/11/2020

Gaurav had indicated that the starup problem if meter gets reset in battery mode had still not 
been fixed.

In the startup function before the EM_Start() is called the LVDEXLVDF is checked and the
g_powermgmt_flag.is_ac_low flag is set or cleared depending on whether ac power is there 
or not

Earlier, if there was AC power available then the EM_Start() was called, but there was
no code for the else condition

Now code has been added for the else condition, in which if ac power is not there then
the function POWERMGMT_DoBeforeStop is called and subsequently STOP is executed
Current consumption is now satisfactory

    POWERMGMT_DoBeforeStop(); // All peripherals off, system will go to STOP mode in polling processing
  	R_INTC0_Stop();	// Stop the pushbutton interrupt
    NOP();
    NOP();
    NOP();
    STOP();

It ought to wake up from this place only if power actually returns
When power actually returns however meter does not start

The following sequence of functions was earlier called when ac power returned

      R_WDT_Restart();
			POWERMGMT_ProcessMode1();
			POWERMGMT_setCurrentMode1();

This was not working properly
Hence the functions above have been commented and a while(1) has been used to force
a reset when ac power returns

			while(1);	// force a reset - when power returns
			
//      R_WDT_Restart();
//			POWERMGMT_ProcessMode1();
//			POWERMGMT_setCurrentMode1();

Now the problem has been solved. If meter is in battery mode,and a reset occurs, then
meter does NOT draw heavy current - instead it draws a few microamp, 5 microamps measured
by our meter

15:42
Gaurav's mail on building version number:

Dear Sir 
please find below meter ver. no. implementation control 

Version no.
"AB CD.E F"

AB 11- 99 for board identity
   11 Gujrat,
   12 TNEB,
   13 KSEB,
CDE   decimal no. for ver. no. (incremental)
   CD for major changes
   E for minor modification
F for special code
   U for unidirectional
   b for bidirectional
   C for CT Meter
	 t for Development / Test Code

for example current Gujrat bidir meter

1101.1 b

16:25
Version number completed - display only in PROD mode

////-------------------------------------------------------------------------------------
12/11/2020
14:40
Some changes have been made to startup and powermgmt to ensure that when power is not there
and meter gets reset then current drawn should still be in microamps and not milliamps

14:42
A test code is being sent
////-------------------------------------------------------------------------------------
11/11/2020
09:11
A Copy(29) is being saved before making any more changes
This folder compiles to EEPL3P_GUJARAT_BIDIR_09_Nov_2020_1913

Two issues need urgent attention

1) When power is NOT there and meter gets reset, it draws 3 to 5 mA
2) DEBUG OPTION byte needs to work properly

Gaurav called yesterday, reporting about the problem (1)
We need to have a mechanism, that when meter starts from reset, and if ac power is NOT there
then the meter MUST enter Mode4

10:53
A check for LVDEXLVDF is made in the main while(1) loop and the g_powermgmt_flag.is_ac_low is set / cleared accordingly
Hex file generated and code sent


////-------------------------------------------------------------------------------------
09/11/2020
This folder compiles to EEPL3P_POINT_FIVE_CT_METER_30_Oct_2020_1912
A Copy(28) is being saved before starting again after considerable gap

Copy(28) is for the POINT_FIVE_CLASS_METER 

Gaurav has listed the followng issues required to be fixed in the PROD code

Pending Points which have Higher Priority 

1. Tamper occurrence and restoration captured time should be as tamer started or removed - DONE
   while captured snapshots of Voltage current PF & kWh can record after 5 seconds.
	 
2. In Gujarat production code when push buttons get pressed in battery mode the meter	- DONE
   shall display calibration status. (Gujarat Production Code)
	 
3.  when meter is running at low load (450 Watt, 150 watts per phase) load survey consumption is being record - DONE
    in alternate entry while sum of all entries (kwh Consumption)  returns  equal to total kWh
		
		IN LOAD SURVEY THE CONSUMPTION IS CALCULATED BY THE EXPRESSION
			(total_energy_lastSaved-ctldata.last_saved_kwh)
			Now total_energy_lastSaved only gets updated when kwh consumption is >= increment values
			To avoid this problem, whenever the do_md_stuff and load survey functions are called
			the update_energies_stored is called to ensure that energies do get updated. 
			THIS SHOULD FIX THE PROBLEM
		
4  Meter  is not showing  Complete list of parameters in auto scroll mode when scrolling -	DONE
   by pressing forward key , returning back after Cumm. KVARH (lag) (With respect to export KWH)
	 ,while scrolling rev. in this mode  all  parameters are available. (Gujrat Bidir)
	 
	 
5. In auto mode display, when displaying MD kW tod wise (for both import/export) MD icon - DONE
   is not glowing for current as well as billed  (Gujrat Bidir)
	 
	 MD ICON IS CONNECTED TO BABY DIGIT 8 - SOME BUG IN DIGIT 8 IS CAUSING MD ICON TO BE TURNED OFF
	 WORKAROUND IS TO SET THE MD ICON AFTER WRITING TO BABY DIGIT 8
	 
6. When Powering up meter in Production mode (Jumper J23 short) ,the meter is not getting - DONE
   power up until not resetting the meter by hardware.
	 
	 In R_PORT_StopCreate the P3.0 pin was being made output, and 0 was outputted
	 When power returned this was causing VBACK to become 0V, and EXLVD interrupt was not coming too.
	 
	 P30 HAS NOW BEEN MADE INPUT WHEN THE MODE4 IS ACTIVATED - PROBLEM FIXED
	 
7. When calibrating neutral meter returns "DONE" massage while neutral does not get - DONE
   calibrated , on display meter shows "Er" massage  

Pending Points Only for Gujarat Unidirectional  
1. In battery mode During C-open Tamper, when displaying c-open there should be provision
   to scroll mode 1 parameters using scroll buttons. (Unidirectional only )  
2. Push Button mode & High resolution mode shall return to auto scroll mode after 5 min.
   since the button left unattended , currently returning in 1 min. ( (Unidirectional only )


08:32
A folder E:\PRAVAK_this\RNSS3P20\Source3P_BIDIR_GUJARAT_SplTamperRecording contains code for the
special tamper recording. Bugs had been reported in this code. Since then  this folder had been set aside
We will pick up code segments / functions from this folder and incorporate in the main thread


Step 1 - Create space for storing the eventdata by decreasing allocation for energy recording - DONE
Step 2 - Change the kwh increment to 1 kwh from 0.1 kwh - DONE
Step 3 - Create the TAMPER_SNAPSHOT_DATA_BASE_ADDRESS and TAMPER_SNAPSHOT_DATA_BASE_ADDRESS - DONE
Step 4 - Modify wre2rom - DONE
Step 4 - Add the functions recordInstantaneousDateTimeEnergy and recordInstantaneousData to memoryOps - DONE
Step 5 - Add a variable onDelay to check_setTamper and check_clearTamper in tampers.c
Step 6 - Add code to check_setTamper and check_clearTamper in tampers.c
Step 7 - Create RECORD_DELAY
Step 8 - Debug for proper tamper recording

12:47
Hex file sent - Tamper persistence reduced to 30 seconds for occurence as well as restoration

15:05
Hex file sent
1. Time recording for transaction events is fixed.
2. At low load, survey (consumption) will be recorded in every interval - FIXED
3. Complete list of parameters is now being shown in Mode 1 - DONE
4. MD icon is now glowing when TOD MDs are being displayed for import as well as export - DONE

16:10

The CALSW is powered from the input AC supply - When pwoer failed Port P30 was being made output
This has now been changed and P30 remains input - Now meter starts in PROD mode when ac is applied

In battery mode CALSW will always read 0 - hence we will never know that it is in PROD mode
To avoid, this a variable calswitch is now being added

CALSW will be read only when powered on, and its value will be stored in calswitch

18:34

19:09
CHECK_CAL_CONDITIONS is uncommented - Hence checks for voltage and current are being performed
when Phase Voltages and currents ae calibrated

For reasons unknwon at present, if neutral current is checked before calibration, then we keep getting
Error

Hence checkNeutralCurrent is NOT being called when CAL3 command is given

NEUTRAL is now getting calibrated properly
TAMPER PERSISTENCE TIME which had been reduced to 30 seconds is now once again made 300 seconds


19:12

Hex file sent  - 
DEBUG OPTION BYTE DOES NOT SEEM TO BE WORKING - YET- THIS IS A BIG ISSUE



////-------------------------------------------------------------------------------------
30/10/2020

10:00
This folder has been sourced from Copy(27)
The Copy(27) code had been directly modified to fix
(a) Errors in Lag and Lead at low currents for POINT_FIVE_CLASS_METER
(b) Bug reported that in Bidir meter, CLASS_04 was not sending data for Export MDkw and MDkva
Above things have been fixed
At present three new variables have been included for pulsing
These variables store power in deciwatts
This has created a problem that when power is computed for magnet and neutral disturbance cases
this pulsing power is currently not being updated - NEEDS TO BE FIXED

The earlier Source3P folder which contained code for Special Tamper Data Recording etc has been setaside
and renamed Source3P_BIDIR_GUJARAT_SplTamperRecording

10:12
Further changes will be made to this folder at present

This folder produces code for EEPL3P_POINT_FIVE_CT_METER_29_Oct_2020 which was sent to Gaurav
by email yesterday at GNOIDA itself

Gaurav has reported two bugs:

1. When powering up meter with out current meter generates few pulses (5-7). DONE
2. When testing starting current test at 5mA current then meter is unable to read current (not reading below 10 mA)  

We also need to fix the pulsing power for Magnet and neutral disturbance cases

Received a new library from Renesas (Vikas Sharma)
Works beautifully, power and current can now be measured upto 1 watt and 1 mA

14:24
Code sent


17:59

Gaurav wants that calibration should be performed without checking voltage and current values - DONE
A #define CHECK_CAL_CONDITIONS has been introduced. If it is commented then calibration conditions
will NOT be checked

Under Magnet , current Imax should be 10 Amps - DONE
and power per phase should be 240*Imax
Two #defines MAGNET_IMAX_CURRENT and MAGNET_IMAX_POWER have been created

If power per phase is < 0.6 watts then it should be treated as 0 - DONE
If current per phase is < 3 mA it should be made 0. DONE

Total kvarh (lag+lead) is being shown in high resolution display of POINT_FIVE_CLASS_METER - DONE 

18:32 Code sent

19:07
Gaurav reports that in High resolution display for kvarh the LAG icon is on - DONE
He also wants CLRCVR command to be active in User mode - DONE



////-------------------------------------------------------------------------------------
29/10/2020
Changes are being made to this folder (Copy 27) taking it ahead of the E:\PRAVAK_this\RNSS3P20\Source3P_BIDIR_GUJARAT
folder

a) Pulsing is being done at 6400 imp/kwh
b) Calibration will be done at 2Ampere, Maximum 15A

Calibrating at 2A did not seem to make any difference

When 0.8Lead is applied then error at 250mA is -0.32% and at 100mA is -0.74%
Below 250 mA for lead case increase power by 0.4% 

Meters were inaccurate at lower currents in lag and lead
This has been corrected by addition of three new variables

	int32_t total_active_power_pulsing;	// this is in deciwatts
	int32_t total_apparent_power_pulsing;
	int32_t total_reactive_power_pulsing;

These variables are used only for pulsing, and contain power in deciwatts

This has fixed the error at low currents for lag and lead - Beautiful


////-------------------------------------------------------------------------------------
16/10/2020
*************************************************************************************************
*	The problem of the MEMTEST not detecting an incorrect device (24C256/24C128/24C64/24C32)			*
*	has been fixed.																																								*		
*	In the checkMemory function, we were using the following command to set bits 15,14,13,12 to 0	*
*		temp_ptr&=~(BIT15);	// make bit 15 0																												*
*	whereas the correct command should have been 																									*
*		temp_ptr&=~((uint32_t)BIT15);	// make bit 15 0																							*
*************************************************************************************************

////-------------------------------------------------------------------------------------
14/10/2020

Refer to points left undone on 13/10/2020
Also refer to Rohit's wishlist as per email of 11/Aug/2020

There should be a facility to ZAP the meter, in case the data is corrupted
This has happened when TNEB code was loaded on a meter which earlier contained Gujarat code
The do_initial_things was not exiting at all
This happened because Common_Data contained bad values for survey_interval and the ctldata
contained bad values for lastTime - this caused the do_initial_things to get stuck and the meter
was not booting at all

If CALSW is 1 then PROD mode, If 0 then USER mode

Commands added (will work only in PROD mode):

	MEMTEST
	CREEP
	STARTING
	DISPRESET
	CAL0
	CAL3
	ZAP
	CLRCVR
	
Bypass icon will stop glowing if CT open condition is encountered
CAL_STATUS is now displayed

10:03
PROD code is now being sent for BIDIR_GUJARAT

11:30
Gaurav called to inform that P30 has not been made input - CONFIRMED
P30 is now made input, Internal pullups are disabled

11:45
New code is being sent

////-------------------------------------------------------------------------------------
13/10/2020

11:50
At GNoida
Vikas has sent a new library with a new implementation of EM_SetVoltageThreshold(uint16_t vlow)
where the low voltage can be passed

The define EM_CONFIG_DEFAULT_VOLTAGE_LOW must not have a value less than 50, so that
EM_INIT will pass (not return) with error
The actual voltage threshold can be set with the new function call
THIS IS WORKING FINE - OTHER IMPACTS TO BE ASSESSED

12:15
KWH_INCREMENT has been made 1000
Freeing up locations for storing energies - DONE
Locations 0x1300 to 0x1B00 are now free

To allow single shot calibration automatically

A Copy(26) is being saved before making any further changes

15:24
Calibration is now happening automatically for all three phases with a single CAL0 command - DONE
Neutral calibration has also been checked - TO BE FURTHER VERFIED ON SHOP FLOOR


In PROD mode, when power is removed, display should be off
If button is pressed it should indicate whether calibration has been completed or not
If rybSnd then show PASS, else show FAIL


PROD STAGE - JUMPER IS INSTALLED - PIN (P3.0) READS HIGH (1)
USER STAGE - JUMPER IS REMOVED - PIN (P3.0) READS LOW (0)


In PROD mode Command to read or write bytes from any address
RANGE CHECK ALL MEMORY BANKS


USER CODE - IF load in any one phase is suddenly made 0 while all three voltages are there, then
BYPASS icon lights up in some cases and reamins lit - BYPASS tamper is NOT recorded and CT OPEN is recorded
BYPASS icon SHOULD NOT TURN ON


REFER ROHIT's mail of 11 Aug 2020 for chcklist of points
Here it is
*************************************************************************************************************
	Production oriented things – Gujarat Bidirectional & Unidirectional
	Production mode will be entered if Jumper J23 is shorted
  i. 	During Production Mode the display cycle shall be as below
			Voltage and current for all three phases and total pf – each for 1 second
			Total power, date and time each for 2 seconds
			Calibration status for 2 seconds
				Calibration status means that we shall display “FFFF” initially, 
				each alphabet is for each phase so when R phase is calibrated and
				saved then it should change to “RFFF”, when all phases are calibrated then we shall display “RyBn”
				Please keep in mind that we cannot calibrate Neutral along with all phases so its better that we make
				a separate save command for neutral and other phases.
			Push button mode display cycle- This is required so that the status can be physically 
				verified before packing – Should return to auto scroll if button is not pressed for 5 seconds
					Version Number
					Date and time
					Calibration status
					Memory status(explained below)
					Serial no.
					Tamper count
					Kwh
					Kvarh
					Kvah
					MD Kwh
			Some fixed data from second memory
			Some fixed data from third memory
			All tamper icons to be shown on display
			If Current/Voltage phase sequence is reversed then the “PhaSE” 
				should be continuously displayed so that this meter is sent to repair section.
			In production mode for Bi Directional meter – Reverse tamper icon shall be 
				displayed if any connection are reversed.
			We need memory clear check routine – If EEPROM is not cleared then the 
				MEM should be displayed continuously
			Starting and Creeping commands
			We need USER defined command for testing starting test – Also we need to confirm 
				if we are fixing power at lower currents and at creeping voltage
			Reset/power off occurs
				A separate USER command like “RESET” is sent to meter
				Push button is pressed
 
			We need to make sure that RTC does not return to initial stages i.e. it should always be more than the last know verified saved value
			We need to solve the problem of meter being in reset state at low battery voltage
			Alpha Numeric Serial Number
			Bootloader
			VRTC low voltage interrupt check
			
	GSM based Smart meter design

////-------------------------------------------------------------------------------------
12/10/2020

For the Gujarat board the tamper time must be the time that the tamper was first detected
and the captured data must be 15 seconds after the first detection
For this purpose, we need to capture the data and store it in 30 different locations in 
memory corresponding to each of the tampers
The date_time must be stored first, and the captured data 15 seconds later
The eventdata structure needs to be stored - E2ROM space need to be allocated
Can't we do it like this
We capture the data only at the time of recording, but the time recorded should be five minutes
before the present time - ie we should be able to subtract five minutes from the present time
We need something like decrementDateTime(int minutes)

////-------------------------------------------------------------------------------------
09/10/2020
A Copy has been made of this Copy(25) folder, which has been renamed Source3P_BIDIR_GUJARAT
The earlier Source3P_BIDIR_GUJARAT has been renamed Source3P_BIDIR_GUJARAT_Production

09:07
The E:\PRAVAK_this\RNSS3P20\Source3P_BIDIR_GUJARAT\rl78i1c\middleware folder contains the following libraries
EM3P4W-BQFR.lib							14-11-2016		1,013KB
EM3P4W-SetVRMSThres.lib			11-06-2020		  104KB

The first library is the emeter engine library, and the second was provided to measure voltages below 120V

In an email of vikas.sharm.aj@renesas.com of 11/Jun/2020, Vikas had sent us two solutions for the problem
of voltages < 120V not getting measured. One was to use the library of 14-11-2016(existing) and to add a 
new library provided called EM3P4W-SetVRMSThres.lib
This required the function EM_SetVoltageThreshold(); whenever a call to  EM_Init or EM_SetCalibInfo
was made. This was done and the solution worked well

However, Gujarat now wants the voltages to be measured below 50V
When the value of EM_CONFIG_DEFAULT_VOLTAGE_LOW is set below 50 in platform.h then
for some strange reason the meter does not clear the startup. It returns with error and is forever stuck
in the   while (startup() != STARTUP_OK) loop in function main()

This may be a good time to try the new library sent by Vikas on 11-06-2020
This library is located in E:\PRAVAK_this\Renesas\3 Phase lib for vol_thres with the following details

EM3P4W-BQFR.lib							11-06-2020		  960KB

We will not need the EM3P4W-SetVRMSThres.lib and all the calls of EM_SetVoltageThreshold() will need to
be commented

09:19
Am leaving for Greater Noida. Need to address the following issues
(1) Bug relating to fundamental kwh not being incremented when 5th harmonic is injected
(2) Attempt to see if the new library solves the below 50V problem
(3) Try to determine why new production code did not work
(4) Will need to get in touch with Krishan to find out how to implement the bootloader

09:27
All calls to EM_SetVoltageThreshold() have been commented
The libaries EM3P4W-BQFR.lib and EM3P4W-SetVRMSThres.lib have been renamed
The new EM3P4W-BQFR.lib of 11-06_2020 has been included in the \rl78i1c\middleware folder

We will now build the code with the value of EM_CONFIG_DEFAULT_VOLTAGE_LOW set to 25 and 
see what the new code does

DID NOT WORK - Even the new library does not run when the EM_CONFIG_DEFAULT_VOLTAGE_LOW is set below 50V

11:29 at GNoida
Old library EM3P4W-BQFR.libhas been restored alongwith EM3P4W-SetVRMSThres.lib
Three calls to EM_SetVoltageThreshold() have been uncommented


The myenergydata.kwh_fundamental was not being incremented when voltage distortion was 10% and current distortion was 10%
This was traced to the fact that the variable "factor" was not being assigned in all cases, leading
to an unitialized value being used
The factor = 1.0; has now been placed before the if block which modifies it. - FIXED & DONE

14:41
CT Open - 
Only when tamper conditions are there must the tamper be occured  and / or restored
Under any other conditions, the counters must be forced to 0. DONE

Fundamental kwh is now being recorded - DONE

15:20
Hex file sent

Further remaining changes are to be made as per email of 08/Oc/2020

Tamper occurence and restoration -the snapshot of parameters must correspond to the start of the occurence / restoration

When the tamaper is first sensed, a snapshot will be taken and stored in memory (e2rom)
Upon completion of tamper persistence, this data will be read from memory, when the tamper is being recorded
If a tamper is sensed, snapshot will be taken - what if the tamper condition is removed say within five seconds?


////-------------------------------------------------------------------------------------
06/10/2020
Gaurav has sent an email from Gujarat
This folder Copy(25) produces hex code of 29/Se/2020 16:22

Please make below changes in Gujarat Unidir code dated 29/09/20 16:22
1. Meter should display instantaneous voltage below 50 V - LIMIT BROUGHT DOWN TO 25 VOLTS - DONE
2. In display mode 2 when displaying total tamper count please print tC instead of tF
Above changes will be implemented in this folder and marked 06/Sep/2020

VOLTAGE LIMIT LOWER THAN 50V CAN CURRENTLY NOT BE SET
IT IS BEING RESTORED TO 50V SINCE METER STOPS BOOTING

15:00 hours
1. When scrolling mode 1 parameters by push button then repeated parameters (kWh kvath lag bill md kw)
Should be part of the part of parameters (shall be displayed every time)
2.  In mode 2 when displaying md kva current month then turn on r icon - DONE
////-------------------------------------------------------------------------------------
01/10/2020
This mail was received from Gaurav on 30/Sep/2020 and contains the thigns required to be done
for PRODUCTION meters

following is the details for new production code 
PGVCL Production code (Bidir Meter)

Following are the previous bugs
1. After completion of 18 hrs display on time in battery mode ,when the meter gets powered up
   it takes 5-7 seconds to start display.

Existing Calibration Points to be correct
1. Meter is reading Default current 5.9 A each phase due to which default accuracy becomes (-46 to -49% )
   change value of default current current .
2. B phase takes 20 seconds to be calibrated while R & Y Both takes 10 seconds.-----------Disscussed 

   Changes to be done in new production code
1. Meter shall enter in calibration mode  when jumper J23 shorted (MCU Pin no. 98 P21/ANI1/AVREFM)
2. During production mode all tamper icons shall be functional while not record any tamper
2. calibration mode display parameters are as follows.

  Parameters to be displayed in auto scroll mode
         Parameter               Display time
 a. Phase voltages R,Y,B           2 seconds
 b. Phase current R,Y,B,N          2 seconds
 c. voltage current phase sequence 2 seconds
 d. Power phase wise               1 seconds
 e. Power Total                    2 seconds
 f. PF phase wise                  1 seconds
 g. PF total                       1 seconds
Above display shall be stuck in following conditions
 (i)   if meter could not be calibrated
 (ii)  if current and voltage phase sequence are not same 
If display stuck due to any above fault condition then it should be restored by a specified command "dispreset"
Parameters to be displayed in battery mode
       a.   Cal done if meter got calibrated
       b.   "Cal fail" if not calibrated
3.  special commands
    a. Creep            -----------> send pass/fail (if all phases current = 0 & total power =0 send pass, else fail)
    b. starting current -----------> send pass/fail (if each phase power is >4.5 watt and equal to 4.8 watt send pass else fail)

4. We need only  1 command to calibrate all 3 phases. and 1 for neutral
   after calibrating all 3 phases; the meter shall display "RYB cal" and "n cal" for 30 seconds .
5. meter shall not be calibrated if voltage and current of individual phases are 
   less than or greater than threshold values.( V > 210 V, & V < 270 V,   I > 7 A & I < 15 A )
6. Boot loader for Firmware upgradation using UART  
7. Provision to set alphanumeric meter serial No., ( Numeric part shall be displayed on display
   while downloading data  By DLMS then Complete Alphanumeric serial no. shall be available.


IT IS VERIFIED THAT
1) PINS NOT USED FOR AD CONVERSION CAN BE USED AS DIGITAL IO - USER MANUAL - CHAPTER 15, 15.2 (1)
2) IN THE r_cg_adc files, the AVEREFP and AVREFM pins are NOT USED - INTERNAL VOLTAGE IS VREF+ AND VSS IS VREF-
3) SECTION 4.2.3 ALLOWS PORTS TO BE USED AS DIGITAL BY SETTING DIGITAL MODE IN ADPC REGISTER
4) CONFIRMED THAT P20 AND P21 CANNOT BE USED AS DIGITAL IO 

10:19
A Copy(25) is being saved before making any changes

////-------------------------------------------------------------------------------------
30/09/2020

This mail was actually received on 15/Sep/2020
Dear Sir 
following is the details for new production code 
DGVCL Production code

Following are the previous bugs
1. Mag icon locking issue  
2. PF disturbed after 40A current (overflow)
3. After completion of 18 hrs display on time in battery mode ,when the meter gets powered up it takes 5-7 seconds to start display.
4. on interchange of Phase neutral wire meter start pulsing 3 times faster.
5. After setting TOD zones meter gets reset continuously
6. Rev tamper to be checked when all 3 phases current > 1 Amp.

Existing Calibration Points to be correct
1. Meter is reading Default current 5.9 A each phase due to which default   accuracy becomes (-46 to -49% )
   change value of default current current .
2. B phase takes 20 seconds to be calibrated while R & Y Both takes 10 seconds.

   Changes to be done in new production code
1. Meter shall enter in calibration mode  when jumper----shorted
2. During production mode all tamper icons shall be functional while not record any tamper
2. calibration mode display parameters are as follows.

  Parameters to be displayed in auto scroll mode
         Parameter               Display time
 a. Phase voltages R,Y,B           2 seconds
 b. Phase current R,Y,B            2 seconds
 c. voltage current phase sequence 2 seconds
 d. Power phase wise               1 seconds
 e. Power Total                    2 seconds
 f. PF phase wise                  1 seconds
 g. PF total                       1 seconds
Above display shall be stuck in following conditions
 (i)   if meter could not be calibrated
 (ii)  if current and voltage phase sequence are not same
 
If display stuck due to any above fault condition then it should be restored by a specified command "dispreset"



Parameters to be displayed in battery mode
       a.   Cal done if meter got calibrated
       b.   Cal fail if not calibrated

3.  special commands
    a. Creep            -----------> send pass/fail (if all phases current = 0 & total power =0 send pass, else fail)
    b. starting current -----------> send pass/fail (if each phase power is >4.5 watt and equal to 4.8 watt send pass else fail)

4. We need only  1 command to calibrate all 3 phases. and 1 for neutral
   after calibrating all 3 phases; the meter shall display "RYB cal" and "n cal" for 30 seconds .
5. meter shall not be calibrated if voltage and current of individual phases are less than or greater than threshold values.
6. Boot loader
7. Provision to display alphanumeric sl. no on display.  
////-------------------------------------------------------------------------------------
29/09/2020
A Copy(24) is being saved. This copy was used to make code for EEPL3P_GUJARAT_UNIDIR_23_Sep_2020, not final yet

Code for GUJARAT_BIDIR is to be created

Gaurav sent observations on 28/Sep/2020
please find below observations from Gujarat Code (unidir/Bidir) 
1. Magnet Icon stuck on display when testing with 0.2 T DC magnet. PENDING
2. When checking   total kwh in DLMS instant. profile (IC-7) and 
   Billing profile (IC-7 there is difference in both values in the 2nd decimal .	DONE.
	 CURRENT VALUES HAVE BEEN REPLACED WITH LAST STORED VALUES
3.  when testing 0.2 T AC magnet then 2 magnet occurrence and restoration entries are logged. DONE
	WHEN AC MAGNET IS SENSED, DC MAGNET COUNTERS ARE ZEROED, AND HALLSENS FLAG CLEARED

Code sent at 12:50, 14:04 and 16:22
THE MAGNET ICON BUG HAS BEEN FIXED
There is an issue of resolving between AC MAGNET and DC magnet where a low power DC magnet may produce
a few pulses, which may cause ac magnet to be detected, and if the ac magnet line remains low for a minute
the tamper will get logged, although if there is no disturbance then the tamper will be restored in one minute
This is happening because the detection of AC magnet which takes 1 minute is also the same as the persistence
time for magnet tamper (1 minute) in the case of Gujarat.

////-------------------------------------------------------------------------------------
23/09/2020
Please find observations in Gujarat Unidirectional code dated 210920 
1. when meter is running at leading PF then meter is displaying system PF as unity also showing the same in DLMS data.
2. some times when meter is running at Unity PF it shows system PF as 1.001 at display as well as in DLMS data

////-------------------------------------------------------------------------------------
21/09/2020
The tamperKerala.c and and tampers.c have been synchronised
The function EM_LCD_DisplayStatus are the same in both Gujarat and Kerala display files
Need to check computation of systemPF for Gujarat

Guarav's observations in email dated 15 Sep 2020 for new Gujarat File
following is the details for new production code 
DGVCL Production code

Following are the previous bugs
1. Mag icon locking issue  
2. PF disturbed after 40A current (overflow)
3. After completion of 18 hrs display on time in battery mode ,when the meter gets powered up
   it takes 5-7 seconds to start display.
4. on interchange of Phase neutral wire meter start pulsing 3 times faster.
5. After setting TOD zones meter gets reset continuously
6. Rev tamper to be checked when all 3 phases current > 1 Amp.

Existing Calibration Points to be correct
1. Meter is reading Default current 5.9 A each phase due to which default   accuracy becomes (-46 to -49% )
   change value of default current current .
2. B phase takes 20 seconds to be calibrated while R & Y Both takes 10 seconds.
	In EM_CALIB_Start function in r_calib_sampling.c file the variable g_is_quarter_shift_calibrate is set to 1
	only for LINE_PHASE_B - This may be responsible for B phase taking 20 seconds - NEEDS TO BE INVESTIGATED FINALLY


   Changes to be done in new production code
1. Meter shall enter in calibration mode  when jumper----shorted
2. During production mode all tamper icons shall be functional while not record any tamper
2. calibration mode display parameters are as follows.

  Parameters to be displayed in auto scroll mode
         Parameter               Display time
 a. Phase voltages R,Y,B           2 seconds
 b. Phase current R,Y,B            2 seconds
 c. voltage current phase sequence 2 seconds
 d. Power phase wise               1 seconds
 e. Power Total                    2 seconds
 f. PF phase wise                  1 seconds
 g. PF total                       1 seconds
Above display shall be stuck in following conditions
 (i)   if meter could not be calibrated
 (ii)  if current and voltage phase sequence are not same
 
If display stuck due to any above fault condition then it should be restored by a specified command "dispreset"



Parameters to be displayed in battery mode
       a.   Cal done if meter got calibrated
       b.   Cal fail if not calibrated

3.  special commands
    a. Creep            -----------> send pass/fail (if all phases current = 0 & total power =0 send pass, else fail)
    b. starting current -----------> send pass/fail (if each phase power is >4.5 watt and equal to 4.8 watt send pass else fail)

4. We need only  1 command to calibrate all 3 phases. and 1 for neutral
   after calibrating all 3 phases; the meter shall display "RYB cal" and "n cal" for 30 seconds .
5. meter shall not be calibrated if voltage and current of individual phases are less than or greater than threshold values.
6. Boot loader
7. Provision to display alphanumeric sl. no on display.  

10:00
A hex file EEPL3P_GUJARAT_UNIDIR_21_Sep_2020 has been sent
Gaurav reports that the system pf calculated is not correct for Gujarat
In the computation of systemPF, in energyIntegration file, the temp_total_apparent_power, for non-Kerala meter
is being recomputed as the pythagorean sum of temp_total_active_power and temp_total_reactive_power powers
THIS WILL MAKE THIS FILE PRODUCE THE SAME systemPF as that of Copy(17)

////-------------------------------------------------------------------------------------
18/09/2020
This folder is sourced from Source3P_BIDIR_GUJARAT - Copy (23)
The Source3P_BIDIR_GUJARAT has been renamed as Source3P_BIDIR_GUJARAT-new_devel and
contains changes required to incorporate a soft rtc
Gaurav wants a code for Gujarat Unidir with all bugs upto Kerala meter fixed
This folder will be rebuilt for Gujarat Unidir
////-------------------------------------------------------------------------------------
07/09/2020
Code with two different flag ids is being sent from Copy(23)

9:34
Hex file created for EEO
9:40
Hex File created for UEI

Gaurav reported that Company name should be Universal Electrical Industries Limited

Also magnet icon remains permanently on, under some cases
When meter is switched off and then turned on, one should check the mytmprstatus and
if magnet and acmagnet tampers are not recorded, then the magnet icon should be turned off

14:09
14:14
Hex files sent for EEO and UEI

Gaurav reports that mag icon is now ok - WONDER WHY EARLIER IS NOT OK

AC Magnet was setting and clearing at 60 seconds, it has been changed to 	- DONE
MAGNET_TAMPER_PERSISTENCE_ON and MAGNET_TAMPER_PERSISTENCE_OFF

Meter is hanging when manufacturer name is being asked for - DONE

15:56 Hex file created for UEI
15:59 Hex file created for EEO
Both files sent
////-------------------------------------------------------------------------------------
05/09/2020
rtc battery fail features have been largely implemented, except for our own software rtc

11:08 Code sent
Gaurav reported that rtc was not working time was not increasing even after resetting the meter

12:12
loopCount variables used in R_RTC_Create & R_RTC_Start have been made uint16_t and compare
value for timeout has been set to 30000
rtc is now incrementing if the meter is reset while battery connection has been restored
Hex file sent again
rtc setting has been checked using dlms

15:57
If battery is removed or connected then it requires a reset for the rtcFailed variable to be updated

While power is there, the LVDVRTCF gives an indication of whether battery is connected or not
Does LVDVRTCF even work in Mode3 - Yes it does

Whenever the LVDVRTCF changes state we are resetting the meter - this does  away with the problem
of meter hanging etc

Need to change tamper persistence to 15 minutes

A Copy(23) is being saved
We will implement the pravakRTC function

////-------------------------------------------------------------------------------------
04/09/2020
Working on rtc battery fail

11:00
Gaurav reports that in the code sent on 31/Aug/20, if there is a Cover Open Tamper then
when power fails, the display remains on and does not go off in 20 seconds as required
in Kerala specs
For Gujarat display must remain on for 18 hours and hence this bug has probably escaped
detection
In TNEB this problem is not there
Needs to be resolved along with battery fail / rtcFail
A variable rtcFailed is being created

If battery is not there then the 32 KHz clock also stops - this affects LCD display
LCD display has been switched to Fil by setting WUTMMCK0 as 1
This is now causing the meter to always start from reset - needs to be investigated

13:42
Hex file being sent to test operations without rtc battery

////-------------------------------------------------------------------------------------
03/09/2020
Implementing RTC battery fail
If RTC battery is removed, then rtc will stop functioning, since its supply is independent
However when meter boots, and R_RTC_Create function is called, it may hang since there are
several while loops which may never exit
To resolve this problem, we need to exit the while loop with a fail message and declare the
RTC non functional
We will need a backup provision for 1 second interrupts in case of rtc failure as all time related
functions such as display tamper registration, erngy accumulation etc will all cease
We will need a pseudo rtc or a backup software rtc
How will we then generate a 1 second interrupt when power fails


**********************************************************************************************
*In the checkFrequencyDisturbance function the variables variance_R,variance_Y and variance_B*
*were not being initialised to 0. Since variances were computed only when freqArrIndex was 0,*
*it was resulting in unitialised values of variances being compared with 50 and falsely      *
*reporting a frequencyDisturbance - CORRECTED 																								*
*********************************************************************************************

14:48
Making the maximum current 90A - will require recalibration
This was not required- systemPF calculation was overflowing - computation expression is changed

Appearent power cmputation was being done dwice - one for perphase and one for tthree phases
The three phases comupataion has been commented
Cover Open now alternates with autoscroll

16:06 Hex file sent

18:11
Back at PRAVAK
A Copy(22) is being made before starting work on rtc failure
////-------------------------------------------------------------------------------------
02/09/2020
Received the meter yesterday night.
This code compiles to EEPL3P_KERALA_UNIDIR_TEST_31_Aug_2020
for the following lines in tamperKerala
 
  	check_setTamper(&acMagnetCtr, computeMask(AC_MAGNET),60,14,0);
    check_clearTamper(&acMagnetCtr, computeMask(AC_MAGNET),60,14);

Lines to be actually used are

  	check_setTamper(&acMagnetCtr, computeMask(AC_MAGNET),MAGNET_TAMPER_PERSISTENCE_ON,14,0);
    check_clearTamper(&acMagnetCtr, computeMask(AC_MAGNET),MAGNET_TAMPER_PERSISTENCE_OFF,14);

For testing the magnet icon problem - we are setting the MAGNET_TAMPER_PRESITENCE_ON and OFF to 60 and 60 respectively

A Copy(21) is being saved before testing - The code does not seem to be running when the MAGTEST option is enabled

*****************************************************************************************
* FOUND THE REASON WHY THE MAG ICON WAS REMAINING ON																		*
*****************************************************************************************
The variable pulsesStartedComingFlag must be 0 for the MAG icon to be cleared
Now if for some reason this flag was set owing to two pulses received by application of DC magnet
then when the magnet was removed and Line P42 when high, BUT acMagnetSense was NOT 1, then
the pulsesStartedComingFlag would NEVER be cleared

To correct the situation, in tamper file, when 58 seocnds have lapsed and four pulses have not been received
we clear the acMagnetSense - here the pulsesStartedComingFlag MUST ALSO BE CLEARED

Also the acMagnetCtr is being used to count 58 seconds - THIS IS NOT GOOD
Another variable acMagnetSecondsCtr must be used for the same 

All points except rtc battery have been address
One issue regarding Neutral Disturbance remains
Two phases have 416 volts and one phase has 240 - yet Neutral disturbance is getting logged
The freqDisturbed variable was also being checked - This is being removed and a test code is sent
TAMPER PERSISTENCE has been made 300 seconds for KERALA only for testing purposes

15:08 Test Code sent
IT IS CONFIRMED that when R-R, Y-Y, N-B and B-N are connected then
Vr = 416, Vy = 416, Vb = 240 , Iryb=10A
When freqDisturbed variable is not considered then ND tamper is NOT recorded, Power computed is 9700w
When freqDisturbed is considered then ND tamper GETS recorded, Power computed is 10700w
It implies that under this condition, frequency is getting disturbed

16:53
Sending a code to TEST the frequency values in this case
Gaurav reports that all frequencies are coming as 50 Hz

////-------------------------------------------------------------------------------------
01/09/2020
Gaurav's feedback

1. Rev tamper is being recorded while current > 1 Amp. DONE
2. Voltage unbalance tamper is to be checked when all 3 voltages are >  60% vref (144V) . DONE
3. Cum. power fail duration value showed corrupted 5608889 in DLMS data as well as on Meter Display. BOGEY?
4. Battery status on display - LVDVRTC has been created, enabled and started - DONE
5. When Neutral and any phase of the meter is interchanged then the meter shall record - DONE
		as per relevant electrical condition, also do not log ND tamper. (ND shall be logged only 
		when any 2 phase voltages > 350 & any 1 phase has voltage <50V Or when injecting chopped AC signal) 
6. In battery mode display when displaying RTC then seconds updates after every 6 seconds.DONE

in addition to magnet tamper remaining on of 31/08/2020 - DONE on 02/Sep/2020
////-------------------------------------------------------------------------------------
31/08/2020
07:59 - Hex file sent
Gaurav reports that when magnet is applied for 4 minutes (persistence time is 5 minutes) and then
removed then the tamper is not logged, but the MAGNET icon does not go away at all

////-------------------------------------------------------------------------------------
28/08/2020
08:06
Hex file sent
Spent the day at 7BRD, 13BRD and back to 7BRD
Received email from 7BRD in the morning regarding commercial bid opening - could not attend
AGC_ASSY was not going below -5V owing to very high gains

Gaurav's feedback
1. when changing any phase to neutral or shorting neutral to any phase OF THE METER, - DONE
	 meter Is pulsing fast (Aprx.2x) and active power displayed on meter remain same 
	 (Shows actual given power). this problem is exists since gujrat bidir dated 05/08/20 11:53 code
2.  Magnet detection in 5 min. and restoration in 10 seconds. DONE
3. Meter is getting reset continuously after changing TOD zones. DONE
		The variables g_Class20_calendar_active and g_Class20_calendar_passive had been defined as const
		whereas they were earlier Unsigned8. The definition has been changed to Unsigned8 - This is because
		in the R_OBIS_Class20_Activate_PassiveCalendar function the g_Class20_calendar_passive was copied
		into g_Class20_calendar_active using the memcpy function
		When the variables were defined as const this was not possible - it was an illegal instruction
		causing the MCU to reset
4. All tamper durations have been set to KERALA requirement - DONE
5. All tamper restoration conditions have been modified - unlike Gujarat - DONE
6. Changes to be required to DLMS - EEO etc - NOT DONE


Gaurav's feedback
Observations Kerala 290820 
1. Implement ND conditions as per TNEB - DONE
2. After activating activity calendar, if meter gets reset then meter start  - DONE
		recording in default TOD zones
3. When doing ct open tamper for 2 phases ( R & Y  opened) and any 1 phases's - THIS IS OK
	 ct closed before tamper persistence time then Tamper indication for that phase
	 still blinks till all ct not closed. 
	 (while tamper records only for 1 ct open which completed persistence time)
4. CT reverse tamper to be checked if phase current > 1 Amp. DONE
in addition to previous mail. 
5. (a) when we are changing MD integration period to 15 min from 30 minutes, 	-	CORRECTED - 
			 (MD INTERVAL WILL ONLY BE CHANGED WHEN 30 MINUTES OR 00 MINUTES OCCUR)
			 (HOWEVER, IF QUERIED THEN THE Common_Data.new_mdinterval WILL BE RETURNED)
			 integration period changes back to 30 mins. automatically  on 00 minutes
       or on 00:30 minutes which comes first.  
   (b) when we changes MD integration period to 15 min. from 30 then Rising demand gets doubled. STANDS FIXED.
////-------------------------------------------------------------------------------------
27/08/2020
08:16 hours

Gaurav's feedback
Feedback 260820 KERALA

1. when displaying TOD wise Maximum Demand in kW since last reset is showing previous month MD also - DONE
   there is no MD still showing date as 00:00:48 in all 3 zones
2. Parameter No. 16 & 17 from push button mode parameter's list are interchanged . DONE
3. after parameter no. 42 MD kva from History 2 to 6 , displaying CUM BILL kVAh from History 2 to 6 . DONE
4. turn on CUM icon when displaying TOD wise Cumulative Forward kWh in auto scroll mode - DONE
5. when displaying Bill period cumulative kWh in auto mode value is displayed without leading 0 , turn on CUM icon - DONE
6. Turn On CUM icon when displaying TOD wise cumulative kWh for last bill period in auto scroll mode . DONE
7. Turn On CUM icon when displaying Bill period cumulative kVAh in auto scroll mode . DONE
8. when displaying Tamper details in MODE 2 , meter is showing last occured tamper for 2nd last occur tamper
  (miss potential done  o1 MISSP- 28:08:20  16:00:00
                       o2 MISSP- 00:00:00  00:00:00  
                       r1 MISSP- 00:00:00  00:00:00
                       r2 MISSP- 00:00:00  00:00:00  )
9.  Push button mode shall return to auto mode after last press of key . DONE
10. High resolution mode shall return to auto mode if key is not presses for last 30 minutes . DONE
11. Power fail duration (in inst. profile IC-7 OBIS 0.0.94.91.8.255 )  is not matched with display Power fail duration. DONE 


12:16
Mistake found as to why the occured tamper was featuring in all 4 locations - point 8 above
In displayTamperName(uint8_t eventCode) in em_display_Kerala the variable mytmprdata.latestTamperCode
was being incorrectly used instead of the correct variable eventCode

A corrected hex file is being generated

12:59
Gaurav's feedback
Feedback  270820  Kerala

1. Mode 1 & 2 display parameters are not scrolling from 1 parameter to last parameter by pressinging rev. DONE
2. Display mode should be change after pressing both key together for 5 seconds - DONE
3. Need following additional information for display parameters in BCS report
   (i)   Phase sequence                                  0.0.96.50.46.255
   (ii)  Rising demand in kva with elapsed time  (Demand 0.0.96.50.42.255)  (time 0.0.96.50.43.255)
   (iii) High Resolution Parameters (all parameters)

4. Display mode 2 is not switching to auto scroll mode after 1 minute of inactivity . DONE
5. Cumulative power off duration in DLMS inst profile is in hours change it to minutes . DONE
6. In battery mode display showing only LCD check , not scrolling by push button. DONE

Added by me - Battery status - NOT DONE yet

Please find below OBIS codes

these OBIS code may be used for High resolution register in IC-3 - DONE
0.0.96.50.11.255 kwh
0.0.96.50.12.255 kVAh
0.0.96.50.13.255 kVArh lag
0.0.96.50.14.255 kVArh lead

These OBIS may use for newly added energy Registers Lag/lead IC-3 - DONE
0.0.96.50.15.255  kWh Lag
0.0.96.50.16.255  kWh lead
0.0.96.50.17.255  kVAh lag
0.0.96.50.18.255  kVAh lead 

Gaurav's feedback 18:07

1. When displaying MD kva tod wise for last bill period in auto scroll mode , showing MD date as 00:00:48 - DONE
   while there is no Billed MD , after billing shows the correct value.
2. New added OBIS codes in IC -3 showing 0 . DONE
3. OBIS 0.0.96.50.46.255 for Phase sequence showing value 55040 when phase sequence is FWD. DONE
4. Rising Demand's elapsed time is showing 55043 . DONE
5. In auto scroll mode when displaying Present tamper status , showing total tamper count - DONE
   (here we have to display only occurred tamper count)


////-------------------------------------------------------------------------------------
26/08/2020
A Copy(19) has been saved - which compiles to the Kerala Code of 24_Aug_2020
Whereever offsets are being computed for accesories memory in bill data etc
we should account for the offset by using TIMEZONES since BIDIR meter and KERALA meter uses
6 time zones and the Gujarat Unidir uses 8 time zones

Feedback Kerala initial Code dated 24/08/20

1. when displaying cum kwh of last bill point showing 0.000, - DONE
2. when showing Last bill point kwh tod wise then tod zone no. is same for all three zones also BILL icon is off - DONE
3. Remove frequency from Load survey data as it is amended in specification - DONE
4. when displaying MD kva of last bill , BILL icon is off - DONE
5. when displaying bill period cum kvah showing value 0.000. - DONE
6. when displaying TOD wise Bill period kVAh bill icon is off - DONE
7. when showing MD kva tod wise for last bill period , displaying current MD in all three zones - DONE
     and MD date time is showing MD value ( i.e. MD 7.042 Time 00:7.0:42 date 00:7.0:42)
8. meter is showing bypass icon in below condition
    Iryb 10A, Vryb 240 V, PFr 0.5 lag PFyb 0.5 Lead ;

////-------------------------------------------------------------------------------------
24/08/2020

14:11
First Kerala code sent
////-------------------------------------------------------------------------------------
21/08/2020
09:28

A Copy(17) is being saved. This produces hex file EEPL3P_GUJARAT_UNIDIR_TEST_20_Aug_2020_1032

Copy(17) represents the final copy of the Gujarat Unidir and Bidir meters
Copy(17) code for bidir will be different from the last Bidir code sent as certain changes
made to this folder affected the bidir hexfile

After saving Copy(17) will start modifications for Kerala Tender

KERALA TENDER START

1) Copy and rename em_display_Gujarat as em_display_Kerala - DONE
IMPORTANT : Hex file produced after adding em_display_Kerala is different from EEPL3P_GUJARAT_UNIDIR_TEST_20_Aug_2020_1032
						even though the source files are identical
2) Modify the board file to include KERALA_BOARD - DONE
3) Changes in emeter3_structs
4) Load survey - DONE
5) Energy Incrementation - DONE
6) Billing
		class07_billing_entry_t g_Class07_BillingBuffer - DONE
		Average pf needs to be computed for lead and lag cases also in addition to cumulative - DONE
7) Tampers - file tamperKerala and hex file tampers.h
8) Display						

////-------------------------------------------------------------------------------------
20/08/2020
Gaurav had sent a report of how the function EM_GetPowerFactor(line) behaves
It seems to send the magnitude of the pf of individual phases except when
PF is 1 and all phases are reversed then it sends -1 
(This appears to be the only case when the function returns a negative value)
Thus in getInstantaneousParams a new variable absTempFloat is used to store the 
magnitude of the pf and then checks are performed to see if the magnitude is<0.005
or if the magntiude is <0.995 in which cases pf is returned as 0, pfvalue with sign or 1 respectively

Gaurav's feedback of 19/08/2020 at 16:08
1. During  current Reverse tamper , when capturing tamper parameters then PF value is being captured 0. DONE
2. When Meter is getting power up and displaying ver. no. replace meter ver. to LCD lamp test. DONE on 19/08/2020
3. If Resetting MD manually (by push button or single action ) between Demand integration period in that case  - DONE
  Rising Demand should not get Reset till completion of Demand integration period . PLEASE SEE EXPLANATION BELOW
	
	ctldata.kwh_last_saved is updated when md is made
	However, when bill is made this update is also performed in clearMymeterData thereby paving the way for the
	next md to be computed, by starting fresh
	Some boards such as TNEB want it this way, whereas some boards don't
	A #define MD_RESET_SYNCHRONOUS will cause the ctldata.kwh_last_saved values to be cleared only when the mdinterval
	is over
	This will introduce a bug, as detailed below
	
	Existing MD = 2.96kw
	08:00	Demand = 1.68 being less than 2.96 is ignored and ctldata.kwh_last_saved is updated
	08:25 Demand till now for 25 minutes is 4.08 - mdinterval is not yet complete but bill gets made
				If MD_RESET_SYNCHRONOUS is defined, then previous month MD will remain 2.96kw and
				in the next bill the MD will be 4.08, whereas, MD for the billed month should have been 4.08
				To capture the 4.08 value for the moth being billed, the md must be computed before the bill
				is made to log the 4.08 figure in the bill month
				NOW in the next month also, If MD_RESET_SYNCHRONOUS is defined then the MD will be 4.08
				IF the User had a demand of 4.08 then it will appear in two months
				
				OPTION - Do not make the md before making the bill, and let the higher MD appear in the next month
				
				
09:40 Hex file sent		

10:30
Gaurav reports that display is not scrolling - none of the keys are working	

10:32
Incorrect check being performed in KEY_PollingProcessing - CORRECTED - Code sent	
////-------------------------------------------------------------------------------------
19/08/2020
A Copy(15) has been made
The Copy(15) produces hex file EEPL3P_GUJARAT_UNIDIR_TEST_18_Aug_2020_1439
However, the BIDIR code was not matching EEPL3P_GUJARAT_BIDIR_TEST_16_Aug_2020
This has been corrected and now this folder produces the correct hex files in both cases

Before making any further changes a Copy(16) ias being saved

1.  When displaying TOD zones kwh, display blinks with an interval of  1 second .

2. Bypass not getting logged when all currents are of same sign
	We need to used mixedPowers instead of g_TamperStatus&REVERSE_MASK even for UNIDIR meter - DONE

3.  Meter is Showing PF 0.001 Lead at display as well as in DLMS data while there is no current in any phase. DONE
	Changes made in getInstantaneousParams and computation of systemPF in energyIntegration

4.When logging CT reverse tamper ( all rev.) , current values are being recorded 0 for all phases.
	getInstantaneousParams(ICURRENTS) returns +ve and -ve values, but eventdata_t stores unsigned - eventdata_t CORRECTED - DONE
	Also g_Class07_EventBuffer uses int32_t to store current values, but in R_OBIS_Class07_FilterOneEventEntry
	ATTR_TYPE_LONG_UNSIGNED has been used and only bytes are picked up from g_Class07_EventBuffer.current_value_IR etc - DONE
	THIS MUST BE CORRECTED - THIS WILL AFFECT BOTH BIDIR AND UNIDIR METERS - DONE
	CHANGES MUST BE MADE TO TNEB TOO

5.Last Billing Date - stored in variable g_Class03_BillingDate - DONE
	This is a crucial figure which is used to compute poweroffduration
	In both composeCurrentBillData and write_history_data_new, the g_Class03_BillingDate was
	being set to g_Class07_BillingBuffer.bill_date
	The assignment in composeCurrentBillData has been commented

FROM THIS FOLDER ONWARD - BIDIR CODE HEX FILE WILL NEED TO BE A NEW ONE - WON'T MATCH EARLIER

10:10 Hex file sent

16:08 Gaurav's feedback
1. During  current Reverse tamper , when capturing tamper parameters then PF value is being captured 0. 
2. When Meter is getting power up and displaying ver. no. replace meter ver. to LCD lamp test. DONE
		KEY_PollingProcessing function exits if init_done is not set - this should make the LAMPTEST work nicely - DONE
3. If Resetting MD manually (by push button or single action ) between Demand integration period in that case
  Rising Demand should not get Reset till completion of Demand integration period .

17:45
A test file to display pf as reported by library is being sent
Changes have been made in autoscroll display where voltage readings have been reaplced with pf for each phase
Must be restored later


*********************************************************************************************************
* 	RESULTS OF PF READINGS REPORTED BY EM_GetPowerFactor(line) for individual phases
*	Applied		Current		pf_R	pf_Y	pf_B	systemPF(computed)
*	UPF				Reverse		-1		-1		-1				1
* 0.5 Lag		Reverse		0.5		0.5		0.5			-0.5
*	0.5 Lead	Reverse		0.5		0.5		0.5			+0.5
* 
* UPF				Normal		+1		+1		+1			+1
*	0.5 Lag		Normal		0.5		0.5		0.5			+0.5
*	0.5 Lead	Normal		0.5		0.5		0.5			-0.5
*
* IT TURNS OUT THAT EM_GetPowerFactor ALWAYS RETURNS THE MAGNITUDE EXCEPT WHEN IT IS -1
*********************************************************************************************************

////-------------------------------------------------------------------------------------
18/08/2020
10:14 am - Hex file sent

11:20 am
Verbal feedback
1) Display of TOD is blinking
2) for -ve power cases, non of the kvarh registers is incrementing - DONE
3) pf sign value in display is now ok
4) when meter is running in lead, then apparent power should be equal to active power - DONE

14:38
Hex File being sent - TOD display does not appear to be blinking now - GKW	- god knows why
For some strange reason - this folder is NOT producing an identical hex file for BIDIR_meter

18:04
Gaurav's feedback
1.  When displaying TOD zones kwh, display blinks with an interval of  1 second .
2.  As Rev. icon appears on display bypass ion being cleared while all 3 currents have rev. current  , 
		and Bypass condition actually persists.
3.  Meter is Showing PF 0.001 Lead at display as well as in DLMS data while there is no current in any phase.
4.  When logging CT reverse tamper ( all rev.) , current values are being recorded 0 for all phases.  
5.  In  IC-3 time stamp of the last billing (OBIS- 0.0.0.1.2.255) is showing the current RTC while there is no bill made. DONE

A reference for Bidir meter in today's date is created
////-------------------------------------------------------------------------------------
17/08/2020
This folder produces code for both Bidir and Unidir meters for Gujarat
Bidir code matches hex file of EEPL3P_GUJARAT_BIDIR_TEST_16_Aug_2020
which is different from hex file of EEPL3P_GUJARAT_BIDIR_TEST_10_Aug_2020_2056 at one location only
A value of 42 used in earlier file should have been 34 which is corrected

0930 hours
Hex file sent for Unidir meter
A Copy(14) has been saved

Gaurav's feedback:

Feedback 17/0820_1500 hrs. Gujrat Unidir 
1.   When displaying TOD zones kwh, display blinks with an interval of  1 second.
2.   When displaying kVArh lead in mode-2 turn on lead icon instead of ld. DONE
3.   When displaying MAXIMUM DEMAND OF PREVIOUS MONTH IN KVA in mode 2 turn on BILL icon. DONE
4.   When displaying Cum MD kva in mode 2 turn on CUM icon & remove C. DONE
5.   When displaying HR registers in Mode 3 write Fd when displaying fundamental kWh. DONE
6.   Mode-2 & 3 are not returning back to auto scroll mode after 5 mins from last key pressed (taking 15 mins.).DONE
7.   After generating bill when downloading, the billing profile in IC-7 buffer is not showing any data. SHOULD WORK NOW
8.   In billing profile Tod wise MD data (for both kw & kva ) are being sent only for 6 tod zones while names are available for 8 zones. DONE
9.   when doing current reversal tamper in any 1 or 2 phases BYPASS icon appearing. DONE
10.  when meter is running on lagging PF & all current are flowing rev. then kvarh lead energy is  being updated and at leading PF lag energy
     getting update. also in inst profile PF Signs are accordingly
		 REQUIRES EXPLANATION
10.1 In above condition Display PF during lag showing lead and during lead showing lag.
11.  when meter is running in REV (all three phases) then tamper count increasing like ( Cr =1, Cy =2, Cb=3) - DONE
12.  when MD is being recorded it has been found that MD time showing some values in seconds ( MD recorded at 12:30:00  data showing  12:30:10) - DONE
13.  when meter getting power up and showing LCD check at that time Tamper status icons are blink (if tamper condition persists)
14.  In battery mode display parameters meter is not showing MD of last month. DONE
15.  In auto scroll mode when pressing rev. key from 1st parameter of list it should jump to last parameter of list. DONE
16.  In mode -2 push button mode when pressing rev. key from 1st parameter meter displays (B phase CT open count)  which is middle parameter
     of last instead of last parameter - SHOULD WORK NOW
Addition to previous mail
17.  When doing Dial test,  it has been found that the difference between Total kWh and fundamental kWh is 4% , while this test has been done
     when there were no harmonics in system. DONE
17.b when we done dial test with harmonics in system (Vin, Iout) then difference between total kwh and fundamental kWh was 4 % which is correct.		 

////-------------------------------------------------------------------------------------
16/08/2020
While converting from Bidir to Unidir, a bug has been noted in r_dlms_meter code in the
R_OBIS_Class07_FilterOneBillingEntry function
While sending apparent_MD Date, the buf->from_value and buf->to_value were being incorrectly
compared with 42, should have been 34

Default value of meterType for Unidirectional meter

Billing - DONE
Display - DONE
Load Survey - DONE
Daily Log - DONE
Class 03 - DONE
Class 04 - DONE
Instantaneous Params - DONE
Time Zone Definitions - TZ Data - Same for Nidir & Bidir
Individual Reverse Tamper Counts - DONE
Tamper Icon operations - DONE
Fundamental Energy Computation - DONE



////-------------------------------------------------------------------------------------
13/08/2020
A Copy(13) has been saved. We will be making the Gujarat Single Phase Meter from this folder

Gujarat Bidir meter
RAMDATA SECTION:  00002fa6 Byte(s)
ROMDATA SECTION:  00003bc6 Byte(s)
PROGRAM SECTION:  0003054a Byte(s)


For Gujarat Unidirectional Meter we need to use a different display file
It is sourced from em_display_Gujarat.c and called em_display_Gujarat_unidir.c

Unidir
RAMDATA SECTION:  00002e1c Byte(s)
ROMDATA SECTION:  000039cc Byte(s)
PROGRAM SECTION:  0002e197 Byte(s)

////-------------------------------------------------------------------------------------
10/08/2020

A Copy(12) has ben saved
Gaurav had called from Rajkot Gujarat
He alslo mailed the following observations

1. When changing any phase current direction from import to export in Meter running condition 
	 then BYPASS icon appears on display until we do not change current direction to import 
	 (BYPASS tamper is not recorded)
2. When doing magnet test it once has been found that MAG icon stuck on display after removal
   of tamper condition while tamper restored . 
	(After doing ON & OFF meter several times icon was still there) 

If there is Potential Missing, Neutral Disturbance, Mixed Powers or DC/AC magnet
	then Current Bypass, CT-Open and Current Unbalance Icons will be switched off

If there is Potential Missing then Voltage Unbalance Icon will be switched off

20:56 Code sent
	
////-------------------------------------------------------------------------------------
07/08/2020
Apparent power and subsequent apparent energy is to be computed as follows:
This is how it is recommended in the books

apparent power(3-phase) = sqrt(sum(active_power(phase)*sum(active_power(phase) + sum(reactive_power(phase)*sum(reactive_power(phase))
system pf = sum(active_power)/apparent power;
sign of system pf = product of sign of active and reactive powers

A Copy(11) is being saved before making any changes

13:14 Code sent

14:15
Gaurav reported that system pf is being shown as 49.000
Correction has been made in case IPFS of getInstantaneousParams (converting systemPF to Float and dividing by 1000

14:18
Code sent
////-------------------------------------------------------------------------------------
06/08/2020
After speaking with Rohit yesterday around 17:30 hours, it was decided that the ac magnet detection will - DONE
be confirmed upon the arrival of the second or the third pulse - This information will be used to
display the icon - rest at the end of 58 minutes if the adequate number of pulses have been received
the ac_magnet tamper will be logged and pulsecounter cleared
The pulsesStartedFlag once set will be cleared only when the ac magnet senor line goes high for 1 second

Gaurav has reported an incorrect power event entry when meter is reset, the fail date is all 0's - FIXED

10:08
Hex File sent

Pending
1) Meter serial number in alphanumeric form

14:10
Feedback on 06/08/20 10:08 code 
1. Remove decimal values from CUM MD import which is a repeated parameter. DONE
2. "On" r when displaying current Month MD kW export also for TOD zones. DONE

14:47 Code sent.

People want that if there is magnet indication of anykind, then Bypass and Unbal indications 
for current must go off

16:32 Code sent


////-------------------------------------------------------------------------------------
05/08/2020
1) Points of Rohit's mail of 01/08 are to be addressed
2) energyIntegration module to be added - DONE
3) At all places whether DLMS or Display or any other function every one must access 
	  instantaneous parameters through the getInstantaneousParams function


ac magnet
If a pulse is detected, we should set a flag call acTamperPossible
While the acTamperPossible flag is set
if the sensor output remains low or if number of pulses in a minute are > 5 then we have an ac tamper condition
if the sensor output goes high for 2 seconds or so then there is no ac tamper

11:53 code sent

Gaurav reports that
200mT  5 pulses in 10 seconds			30 pulses/minute	Tamper logged in 60 seconds
10mT   15-20 pulses in 10 seconds	120 pulses/minute	Tamper logged in 120 seconds
Since we have used an int8_t for acMagnetPulseCtr, it may be overflowing (>127)
We have two choices - either to make it uint8_t or int16_t - Will go for int16_t - DONE
Neutral current and Vector current in display used for Testing have been removed - DONE
For negative powers (export) meter was not pulsing - ABS used in wrp_em_adc - DONE
In DLMS r_dlms_user_interface PF_TOTAL forcing pf <0.02 to 0 bug has been fixed - DONE

15:14
Code sent 

LCD_CHAR_O added to lcd_config file

////-------------------------------------------------------------------------------------
01/08/2020

Rohit's mail
We need a leading zero to be shown on LCD display while showing serial number, for example, 
the serial number on name plate is 012561 but is displayed as 12651, we need to show leading
zero along on the display, only one “0” needs to be shown, FYI, when we enter the serial number
during production we enter it as “PGBTP012561”, it’s an alphanumeric serial number along with 0.

The repeated parameters in auto mode i.e. Cum. Total import Kwh, Cum. Total export Kwh, Kvarh lag, - DONE
import MD etc. are to be shown without decimal digits. However cumulative import MD parameter
displayed during auto scroll shall be displayed with decimal digits.

We should clear CT bypass and current unbalance tamper icon/flag if Magnet is detected, this is	-	DONE
because in almost all the cases if the meter is being affected by magnet the CT will get saturated
and some or the other current related tamper may also be registered at that time if not cleared.

We need to do something regarding the AC magnet test logic, at present if the AC magnet is applied
till 50 seconds and then removed, the “MAG” is displayed on LCD for another 15 seconds and the meter
goes to Imax(even when the magnet  is removed in the last 15 seconds of the 1 minute cycle). 
I think we should rethink the logic to detect AC magnet, we will also test on Tuesday and update on the same.

In Mode 1
In case Rising demand at present we are displaying “r”, we need to change it to “rD” - DONE  
In case Current/Present demand(KW) we need to display “r” along with value. 	- DONE
This has to be done in present MD of current month and of all three zones(import & export)  - DONE   
In case of cumulative MD import which is one of the repeated parameters, import icon - ALREADY THERE
shall also be displayed
“Cum” icon to be displayed in total reset count, total tamper & programming count. DONE
For anomaly
i.  We need to remove RTC anomaly - DONE
ii. Under normal circumstance we need to display “1111” i.e. everything is OK - DONE
iii.If voltage tamper is there then we need to display u i.e. “u111” - DONE
iv. If current tamper is there then we need to display C i.e. “1C11”	- DONE
v.  If Other tamper is there then we need to display o i.e. “11o1”		- DONE
vi. If memory anomaly is there then we need to display m i.e. “111m”	- DONE
vii.In baby digits, we need to display “An” - DONE

In Mode 2
“Cum” icon is to be displayed in Total tamper counts i.e. on voltage, current to….  DONE
Magnet count. All of them.
At present the locking period for any parameter during display  is 5 minutes this has to be increased
to 15 minutes in case of Bidirectional meters.
This is a special requirement by the auditing team, let me know if its possible
When we enter any LCD display mode then “MODE X” is displayed, the requirement is such that 
if any mode is entered it should first be in auto scroll mode, i.e. the parameters should scroll 
in every 10 seconds till the cycle is over and then display should return to MODE 1(auto scroll). 
However if and only if push button is pressed while displaying “MODE X” then the parameter at 
which push button is released should lock for 15 minutes and then the display should go back to 
MODE 1(auto scroll). Any similar type of feature which is easier to implement shall also be accepted.
////-------------------------------------------------------------------------------------
31/07/2020
When R and Y cts were opened - ct open tamper was not being record - DONE
mistake found in countCurrentGT95 function - only r,y and y were checked instead of r,y,b
code sent at 16:10 with 10 seconds persistence
////-------------------------------------------------------------------------------------
30/07/2020
Rohit wants the BIDIR meter to compute net power
Two phases may have positive power and one may have negative - we must use algebraic sum
to compute the net power and the sign of the algebraic sum to determine whether meter operates
in import or export mode

Before making any changes, this folder produces code matching EEPL3P_GUJARAT_BIDIR_26_Jul_2020_FinalSample._hex

Modification is to be done in energy_incrementation()

NetPower - DONE
CurrentBypass - CHECK - display modified
Current Sign - DONE

Code being sent at 12:45 hours
////-------------------------------------------------------------------------------------
26/07/2020
16:38
Gaurav called up to say that cover open tamper is not coming on
The g_powermgmt_flag.is_cover_int was not supposed to be checked and at GNoida
one forgot to make the change before handing over the code
Code being sent now with the check for cover_int being commented.
If cover int is not checked this folder compiles to EEPL3P_GUJARAT_BIDIR_26_Jul_2020_FinalSample
	else it compiles to EEPL3P_GUJARAT_BIDIR_25_Jul_2020_1838_Eighteen
Checked that it does
Closing at 17:05
////-------------------------------------------------------------------------------------
25/07/2020
Late last evening, Gaurav had reported that
(a) Meter was not getting calibrated - they were resetting
(b) First bill was being read as all 0 values

The problem was traced to excessive RAM usage by the CHOPPED_AC tamper handling functions
in the FrequencyDisturbance module and the addition of Phase Current Sequence Detection
By commenting these functions the meter was getting calibrated again

The first bill being all 0s was caused by using 
	tmonth = decrementMonth(1) instead of tmonth = Common_Data.history_ptr-1
THIS IS INCORRECT - WE MUST CONTINUE TO USE
	tmonth = Common_Data.history_ptr-1
	
To solve the problem of ram usage, variables such as
	ldn_name, meter_rating, g_Class20_week_name1, g_Class20_week_name2
	g_Class20_season_name1, g_Class20_season_name2
	g_Class20_calendar_active, g_Class20_calendar_passive
	were replaced with const strings

Further overcurrentCtr's,lowpfctr and rtc_calendarcounter_value_t were commented
Lastly UartSendBuff size was reduced from 266 to 64

All this has resulted in the RAM being reduced from 0x346E to 0x3342 ie by 300 bytes
RAMDATA SECTION:  00003342 Byte(s)
ROMDATA SECTION:  00003bba Byte(s)
PROGRAM SECTION:  0002fad7 Byte(s)


We can now safely allow operation of Current_Phase_Sequence and FrequencyDisturbance - DONE
RAMDATA SECTION:  000033ba Byte(s)
ROMDATA SECTION:  00003bba Byte(s)
PROGRAM SECTION:  0002ff40 Byte(s)
RAM usage has increased by 120 bytes as expected

First bill being all 0's has been corrected

The remaining thing is clearing of the Cover Tamper - CLR CVR
We must use the interrupt once and not clear it - so that subsequent tampers get detected by polling
[
	clear the mytmprdata.tamperEvent_image and save it to memory
	clear the g_Class07_Event_CurrentEntry[5] entry and make it 0
	clear the g_powermgmt_flag.is_cover_int flag
	clear the g_Class01_EventCode[5] entry and save to memory
]

	
Further jobs remaining to be done include
1) Handling reset when meter starts from battery mode
2) Programming the Chip using the serial port
3) Further RAM and Code reduction (convert byte flags to bit variables)
4) Disabling the On-Chip Debug Function


09:32 
User code of 25/Jul/2020 sent

10:16
Gaurav reports that meter is resetting once calibration is attempted to be saved - CAL4 command

10:23
Code sent with FREQ_DIST_CHECK commented - RAM variables are retained
RAMDATA SECTION:  000033ba Byte(s)
ROMDATA SECTION:  00003bba Byte(s)
PROGRAM SECTION:  0002fc88 Byte(s)

10:41 - Problem remains - Meter not getting calibrated
Code sent with FREQ_DIST_CHECK uncommented and CURRENT_PHASE_SEQUENCE commented - Memory retained
RAMDATA SECTION:  000033ba Byte(s)
ROMDATA SECTION:  00003bba Byte(s)
PROGRAM SECTION:  0002fdd9 Byte(s)

11:00
Problem persists
Both functions being commented and RAM also not being used
RAMDATA SECTION:  00003342 Byte(s)
ROMDATA SECTION:  00003bba Byte(s)
PROGRAM SECTION:  0002fafc Byte(s)
Code sent

11:28 - Problem persists
Gaurav reports that file sent at 1100 hours is also resetting the meter
Technically this is the same file as that sent on 24/07/2020 at 1848 hours
The only difference is that some variables have been commented - which include the UartSendbuff
whose size was reduced from 266 to 64, and variables in dlms files as well as 
the variable rtc_calendarcounter_value_t g_last_rtc_time in event.c
This variable along with its usage is being uncommented - all others related with dlms
and the UartSendBuff are same as 1100

Left for Greater Noida
13:30 at Greater Noida
Problem was traced to the UartSendbuff[266] in pravakComm Making this 64 was causing CAL3 command to
cause meter to reset
To solve the problem of low memory the MAX_APDU_BUFFER_SIZE was made 768
Now meter works properly with Current Phase Sequence as well as CHOPPED AC code turned ON

Two codes were mailed to Gaurav from GNoida itself -called
EEPL3P_GUJARAT_BIDIR_25_Jul_2020_1835_Three and EEPL3P_GUJARAT_BIDIR_25_Jul_2020_1835_Eighteen
These allow meter display to remain on for three minutes or eighteen hours
After elapse of the period if pushbutton is pressed then meter comes ON for 35 seconds.


////--------------------------------,-----------------------------------------------------
24/07/2020
A Copy(7) is being saved before starting work.
Code sent from this folder was EEPL3P_GUJARAT_BIDIR_23_Jul_2020_1145

Almost all queries had been addressed
Feedback provided by Rohit for code of 23/Jul/2020 is as under

The following are changes are required in the test code.
    Anomaly code	- DONE
    RYB ICON indication to be changed –  DONE
        If voltage and current are available then RYB to be displayed continuously.
        If only voltage is available then the particular phase icon should blink.
        If voltage is not available – then icon should disappear.
    Scroll cycle while pressing the button should roll over in up or down mode in Auto or Any Mode. DONE
    Push button is highly sensitive now, it changes one/two parameter at a single press,
			response time of push button to be increased. DONE
    In “DAY display” Friday is been displayed as triday, “TOD” icon is being displayed - DONE
			while displaying Saturday and Sunday.
    When consecutive bills are generated, data being sent of MD KVA for export TOD zone
			2,3,4 are getting corrupted in the previous bills.
			
			
Bills were getting corrupted because sizeof g_Class07_BillingBuffer was 596 bytes and BILL_PTR_INC was 512
It has now been increased to 640
This has required all memory addresses to be relocated. We will have to ZAP from 0x300 onwards
Also in write_history_data - we must use 
	tmonth = decrementMonth(1) instead of tmonth = Common_Data.history_ptr-1;
The above two lines are incorrect - decrementMonth(1) MUST NOT BE USED - 	tmonth = Common_Data.history_ptr-1; IS CORRECT
Last thing is that Lamptest is now coming out nicely.

16:51 hours
Gaurav reports that Meter is not getting calibrated anymore

A Copy(8) is being saved to preserve this code - and the calibration issue will be taken up
The earlier memoryOps.h has been copied into this folder and the latest one has been named memoryOps_new.h

The clearE2Rom will now be reset to clear starting from 0000

17:42 hours
Current sequence code is being suppressed to see if calibration problem is resolved
A #define CURRENT_PHASE_SEQUENCE has been defined in emeter3_structs_h
Hex file sent at 17:49

18:22 hours
Reported by gaurav that problem started with Chopped AC code sent on 21/Jul/2020 - sent at 17:33 hours
We will suppress the CHOPPED AC code - Essentially the contents of the FrequencyDisturbance file
All frequency disturbance code is now excluded
File sent at 18:30 hours
Gaurav reports that in this code - Calibration is being performed successfully

We will now send the code with the new memoryOps_new.h .The file will be renamed to 
memoryOps.h and the memoryOps.h file will be renamed memoryOps_old.h
The ZAP function will now clear from 0x0300

18:48
Hex file sent with new memory addresses - CURRENT_PHASE_SEQUENCE and Chopped AC FREQ_DIST_CHECK
have been excluded

This file is also working - hence it appears that we are running out of RAM

A Copy(9) is being saved as one intends to do some optimisation

////-------------------------------------------------------------------------------------
23/07/2020
Tamper sequence and limits have been rationalised and fixed
There should be no false tampers, and missing pot and ND will not be logged together
Now to do current sequence
////-------------------------------------------------------------------------------------
22/07/2020
This folder was sourced from Copy(6)
Another folder called Source3P_BIDIR_GUJARAT_Battery_Consumption was also sourced from Copy(6)
which is a separate thread currently, meant to deal with reduced battery consumption
and also to account for meter starting from reset in battery mode. PENDING

A new module FrequencyDisturbance has been added to allow detection of Chopped AC in Neutral Disturbance 
tamper.

Ultimately the battery consumption will be merged into the main thread

Rohit's and Gaurav's observations:

22/07/2020 - 17:51
Please find below observations 
1. when doing Potential missing tamper then "ND" tamper is being logged also 
	( & "ND" get restored when all 3 phases are available )
2. when the meter is getting power On/Off the "ND" tamper is being logged
	 and being restored after 20 seconds
3. when changing Frequency 50 to 52.5 or 47.5 then "ND" tamper is being logged
	 and getting restored after 20 seconds .

22/07/2020 - 15:17

Sir, I missed one point, in any case of magnet or ND tamper meter should only run in import mode. DONE

22/07/2020 - 14:34

Further to the changes in the below mentioned mail, we need to do the following changes for ND conditions

    As soon as ND is detected - DONE
        “N” icon should start blinking
        Meter should start recording at 240 Volts UPF
        Meter should stop recoding at Vref if ND condition is removed
        Logging has to be done after the persistence time or persistence time can be subtracted from actual time at the time of logging.
    At present the meter always starts in ND condition, we need to rectify this.
    If in any case the frequency is above 55 or below 45, then we need to go in ND condition, i.e. recording at Vref and UPF. 

20/07/2020 - 17:43

The following changes are required as per initial report received from testing authorities in Gujarat based meters

    Phase sequence of current also to be displayed after phase sequence of voltage. DONE
    “Day” to be added before date & time - DONE
    Add “R/RI/RD” in Rising demand parameter - DONE
    Remove “-“ in Peak, remaining and night TOD demand, we can display PH, rH, nH - DONE
    Anomaly code – Is user defined, I suggest we use five digits to display the present status of Tamper, - DONE
		 	RTC failure and EEPROM status
        Digit 1- if “1” then it means that at present a voltage related tamper is going on
        Digit 2- if “1” then it means that at present a current related tamper is going on
        Digit 3- if “1” then it means that at present any other tamper is going on
        Digit 4- if “1” then it means that at present RTC battery is low
        Digit 5- if “1” then it means that at that EEPROM failure is there
    If none of the above anomaly is there then we will show “00000” or “GGGGG” if all are there then 
			we will show “11111”/”FFFFF” or sir may decide any other type of display which is easier to implement.
    Scroll cycle in Push button should roll over in up and down mode, at present it is stuck at the  - DONE
			last of first parameter.
    Mode change to be done in 1 Second instead of 5 seconds - DONE
    Response time of push button to be increased(decreased?).	- DONE
    RYB ICON indication to be changed	- DONE
        If voltage and current are available then RYB to be displayed.
        If only voltage is available then the particular phase icon should blink.
        If both voltage and current are not available – then icon should disappear.

 

////-------------------------------------------------------------------------------------
19/07/2020
In checkCover g_powermgmt_flag.is_cover_int flag is not being checked
g_powermgmt_flag.is_cover_int is cleared when power goes off
During power fail if display is off, and cover_int comes display will go to mode3
UART is only being switched on when button is pressed for four seconds in mode3
This should reduce current consumption
In mode 3 if cover tamper is there then message will be displayed

11:36
User code sent
////-------------------------------------------------------------------------------------
17/07/2020
A Copy(5) which compiles to the test code of EEPL3P_GUJARAT_BIDIR_15_Jul_2020_TEST
is being saved before starting work

Gaurav reported that load survey gave a proble after a few days of data being recorded
We are starting with 0x07400
SURVEY_INTERVAL 15
sizeof(small_surveydata_t) 28 bytes
Hence one days data needs 28*96=2688 bytes
Bytes available in first chip = 10000-0x7400 = 35840/2688=13 days
Gaurav has reported that the problem appears after () days 

Following changes have been made
In EPR_Write_Helper function we are returning if size==0
In EPR_Read_Helper function we are returning if size==0
In R_RTC_Create the RTCIC1 interrupt has been made rising edge

User Code sent to test if Cover Open Tamper is now working

////-------------------------------------------------------------------------------------
15/07/2020
Magnet icon is not coming on properly
Problem located in line 1793 of em_display_Gujarat file && used instead of || - FIXED
Does C_Open pin have internal pullups - NO - All Pullups are off
To add a display item which will show which of the Hall sensor is 1 - DONE
Test code being sent
////-------------------------------------------------------------------------------------
14/07/2020
Attended the pre-bid meeting at 13 BRD - Spoke to Prmaila mam of logistics
need to submit a new Form 68 according to her for ACU

Load survey is working fine

Gaurav had called
1) He wants Cover open sensor logic to be inverted - When input is high then COVER is open - DONE
	In r_cg_rtc.c file the RTCIC1 interrupt has been made rising edge
3) He wants a test code to check 18 hours operation - make it five minutes or so - DONE
2) Also need to implement a new algo for ac_magnet - DONE

Whether ac magnet is logged to dc magnet is logged, meter should go to imax
Same is for the icon - which should be on if either ac_magnet or dc _magnet is present
and off only when both are absent

A signal for ac_magnet_sensed is required
Whenever a pulse comes, this signal should go high - however if a pulse does not come for 15 seconds
this pulse should go low, The 15 second timeout counter must be reset with every pulse,a dn must be decremented
every second
Presence of this signal for 1 minute is to be treated as ac_magnet being there for 1 minute(persistence time)
However once the signal goes off, which it will if a pulse stops coming for 15 seconds, then another 45 seconds
should be used to account for the 60 second persistence of the ac_magnet

Two User Codes sent : EEPL3P_GUJARAT_BIDIR_14_Jul_2020 and EEPL3P_GUJARAT_BIDIR_14_Jul_2020_TEST
////-------------------------------------------------------------------------------------
13/07/2020

Implementing read & write access across chip boundaries

To obtain tighter packing and efficient use of e2rom space, especially for load_survey it 
is imperative that ptr_inc should not be a multiple of 8/16/32/64/128
If ptr_inc is not a multiple then it is possible that the record being accessed may cross chip boundaries

We will modify the EPR_write and EPR_Read functions to deal with this situation

EPR_write and EPR_Read have been successfully implemented - Now we can write across chips

We can now fit the load survey data for 62 days

To fit load survey data for 62 days the size of small_surveydata_t must be 28 bytes
This can be achieved by using uint8_t for storing V_r,V_y,V_b - DONE
Voltages will be stored without decimal - DONE
If the value becomes more than 255, then one bit will be stored in bit14 of I_r, I_y, and I_b - DONE
The function perform_VI_averaging is being modified to have voltage without decimals - DONE
Changes are to be made in get_lp_data to account for one bit of Voltage which is stored in Current(Bit14) - DONE
Now to change the SURVEY_PTR_INC - DONE

TESTING Code has been loaded into meter with us
Regular code with #define TESTING commented is being sent to Eppeltone

14:45
Survey data does not appear to be recorded properly - when downloading using dlms date values are incorrect
There was some error in initial count also when meter was zapped - one entry less was being displayed
NEEDS TO BE INVESTIGATED & FIXED

Load survey bug has been fixed. All references to surveydata_t have been commented - only small_surveydata_t is used
This fixed the bug
Secondly the voltage averaging is done with one decimal, and prior to dividing it by 10 to store in in the survey data
the value is being rounded off.

TESTING code has been load and load set at 2400 - We will let the meter run for a while
19:34 Signing off

////-------------------------------------------------------------------------------------
12/07/2020
A Copy(4) has been saved - Last code sent to User was on 11/07/2020

We need to implement
1) proper loading of mddatetime for import and export when asked for in Class_04 - DONE
2) implement read and write access to E2rom across chip boundaries - current code handles
	 page boundaries, but within the same chip/device
////-------------------------------------------------------------------------------------
11/07/2020
08:57
A Copy(3) has been saved before starting work

A disturbing error has been noticed - With no battery when things boot from power up,
the kwh becomes 0. NEEDS TO BE FIXED BEFORE ANYTHING ELSE

FIXED - The energies structure size was 86, but the ENERGY_PTR_INC was only 64 - hence the MESS 

Other pending thing for Gujarat bidir meter is 
(a) Implementation of tampers with proper icons and interlocks

////-------------------------------------------------------------------------------------
10/07/2020
Gaurav's feedback

Please find quick feedback
1. when displaying PF in auto scroll mode then import icon is on - DONE
2. when showing rising demand on display , export icon is on - DONE
3. display flickering each second when displaying TOD values - DONE
4. Meter is showing 12465  power fail duration while meter just started from ZAP	- PENDING
5. meter is showing corrupted value in import TOD zone (peak hours 068157.4)	- CHECK
6. meter is running in zone 4 (off peak) but increment being in tod 3 (rest)	- CHECK
Addition to previous mail
8. Billing profile has issue - CHECK
	(i) meter start from fresh after zap check recording in all TOD zones it is correct
  (ii)  now bill made ; 
				after billing 2 billing entries created 1 st with current RTC in which 3 TOD zones values cleared
        in 2nd entry all values are corrupted   & in current enetry all TOD zones energy cleared
9.  After billing following values corrupted on display -	CHECK
		(i) Billing MD kw Import 
		(ii) avg PF for last billing period
10. When displaying TOD values on display , for TOD zone 06:00-07:00 -	CHECK
		(Rest) showing total of (Rest+off-peak)
11. When meter is running in export mode and changed to import the import 	-	CHECK
		TOD kwh values showing corrupted .
12. Meter is recording current unbalance & low voltage tamper at given condition while condition satisfying	- PENDING
    voltage unbalance tamper (Vr=240, Vy=240, Vb=168 70%of Vref & Ir=10A, Iy=10A,Ib=0A)
13. when displaying cum MD then C & cum both icons are on -	CHECK


1. display flickering each second when displaying TOD values -               not done still have flicker - DONE
2. in export mode when displaying PF meter is showing -(ve) sign for UPF (PF - 1.000)	- THIS IS OK
3. when displaying rising demand with elapsed time please on Time icon  - DONE
4. When displaying TOD values on display , for TOD zone 06:00-07:00 -    THIS IS OK - ELSE 1 ZONE VALUE WILL NOT BE SHOWN - OFFPEAK & REST COMBINED
        (Rest) showing total of (Rest+off-peak )                              Not done 
5. In ND tamper condition meter is not capturing actual values at time of event occurrence condition - DONE
   (meter captured Vryb 240 V instead of Vr=415, Vy= 419, Vb=0)
6. recording overvoltage with ND        
7. Mag tamper icon not glowing ( tamper being logged and restored correctly )
8. in load survey data export kwh value showing 37957 one after another - DONE.
 After billing export TOD zones kWh & kVAh values are becomes same as current tod zone in which meter
  running currently it has been noticed only in current billing entry while in billed entry values are proper . CHECK
	
	
18:41 hours
One has been noticing a very peculiar situation regarding magnet tamper
With Magnet permanently applied the tamper is occuring, then restoring in endless cycles
at time period equal to the persistence time - THIS HAS TO BE FIXED
This folder produces code of EEPL3P_GUJARAT_BIDIR_10_Jul_2020_1831.hex
A Copy(2) is being saved to preserve this code before messing any further	

Gaurav had indicated that kvarh_lead_value_export was not appearing in dlms - it has been fixed for billing, - DONE
 but not for current data - DONE
 
Found the bug that was causing the MAGNET tamper to be occured and restored
The ac magnet tamper was using the same mask compute(MAGNET) 
The correct usage should have been compute(AC_MAGNET)
If magnet tamper is there and ac magnet tamper is not there, then after the magnet tamper
has occured, it gets restored sine the ac_magnet is not there, and the same maks has been used. MYSTERY SOLVED.
19:28 shutting down for the day
////-------------------------------------------------------------------------------------
07/07/2020
This folder is sourced from a folder of same name from E:\PRAVAK_this\RNSS3P
On 06/07/2020 the TNEB code was finalised
Now going to work on Gujarat_BIDIR to bring this code upto date

////-------------------------------------------------------------------------------------
28/02/2020
A Copy(81) is being saved before starting work.
This folder produces code matching EEPL3P_USER_BIDIR_22-Feb-2020_1953._hex
We will now begin work on the TamilNadu meter which is Uni as well as Bidirectional
////-------------------------------------------------------------------------------------
22/02/2020
06:00
Had left the meter running 
Made a bill - Transfer appears to be OK
Will check exportMode in TESTING

In the display - offset numbers will have to be corrected

Status of observations
1. Billing data corruption	- Appears to have been fixed - DONE.
2. Cover open in battery mode	-	DONE.
		A function checkCoverTamper() has been added in powermgmt.c
		This checks cover open tamper in both Mode1 and Mode3
3. export sign 0.2% meter must remain in export mode down to very low currents - (< 50mA)  DONE. 
4. battery mode display has two extra things in it - not needed - DONE. 
5. Phase sequence - ryb
6. To correct the displays

09:10
RAMDATA SECTION:  000033ea Byte(s)
ROMDATA SECTION:  00003981 Byte(s)
PROGRAM SECTION:  0002f68a Byte(s)
Renesas Optimizing Linker Completed
------ Build ended(Error:0, Warning:32)(rl78i1c, Release_BQFR) ------

Code sent at 10:38.

13:33
A Copy(80) has been saved - will now implement the phase sequence monitor


Gaurav feedback

2. Avg. PF for last billing period showing 33.023	- DONE
3. Add kWh export in instantaneous parameters list in IC 7 ,  (OBIS code- 1.0.2.8.0.255  IC-3) - DONE
4. When meter running in export mode showing – (ve) sign twice before value of current and power
5.  Avg. Current value in load survey data are not correct - DONE
6. During Tamper events in export mode current (R,Y,B) values are not captured - DONE

Code sent at 17:27

Gaurav had indicated in point 1 above that current MD values before and after making the bill
were being displayed correctly in DLMS, but on LCD display the bill values were corrupted
Since in the new data structure of g_Class07_BillingBuffer the MD values are stored as int32_t
hence the multiplier for the index needed to be multiplied by 4 instead of 2(earlier) in
display states 28,29,30 and 36,37,38. This has been done

Gaurav's mail
Please add – (ve) sign for following values in inst. Parameters  IC-7 when Export mode
Inst current (R, Y, B)   1.0.31.7.0.255, 1.0.51.7.0.255, 1.0.71.7.0.255
Active power kW   1.0.1.7.0.255
As discussed with Rohit  sir please skip phase sequence display implementation for now only.

Code sent at 19:53

////-------------------------------------------------------------------------------------
21/02/2020

This file is closely related to Copy(78) and Copy(77)
It appears to be closer to Copy(78)
average values type has been changed to unsigned int

RAMDATA SECTION:  000029ea Byte(s)
ROMDATA SECTION:  00003993 Byte(s)
PROGRAM SECTION:  0002f6ae Byte(s)

06:30
#define TESTING incorporated
RAMDATA SECTION:  000029ea Byte(s)
ROMDATA SECTION:  00003993 Byte(s)
PROGRAM SECTION:  0002f644 Byte(s)
Renesas Optimizing Linker Completed
------ Build ended(Error:0, Warning:26)(rl78i1c, Release_BQFR) ------

09:15
Buffer size being increased from 512 to 1024
RAMDATA SECTION:  000033ea Byte(s)
ROMDATA SECTION:  00003993 Byte(s)
PROGRAM SECTION:  0002f6aa Byte(s)
Renesas Optimizing Linker Completed
------ Build ended(Error:0, Warning:26)(rl78i1c, Release_BQFR) ------


10:25
Device size was 128 byes, but some addresses were aligned at 64 bytes
Device size has been made 64 bytes

16:28
We will make the device page size as 128 bytes again - since many of our data structures are 64 bytes
we need to ensure that the addresses are aligned to 0xhh00 or 0xhh80
Will save a Copy(79) before making changes

pagesize has been made 128 bytes
clocking rate has been halved
////-------------------------------------------------------------------------------------
19/02/2020
Bill Data Corruption
We are having a global data structure g_Class07_BillingBuffer
We also have another structure one structure billdata_t billdata which is used to read / write into e2rom
write operation is carried out in memoryops.write_history_data_new()
read operation is carried out in r_dlms_data.get_bill_data()
The billdata_t structure is redundant and we can use g_Class07_BillingBuffer itself
This will save a lot of stack

The length number in the profiles need to recalculated and corrected where necessary

// g_Class07_BillingBuffer has been expanded to include export data
>Build\Release_BQFR\rl78i1c.lmf Build\Release_BQFR\rl78i1c.hex
RAMDATA SECTION:  000029ea Byte(s)
ROMDATA SECTION:  00003957 Byte(s)
PROGRAM SECTION:  0002f8df Byte(s)

// after removing billdata_t - there will now be much less load on the stack
RAMDATA SECTION:  000029ea Byte(s)
ROMDATA SECTION:  00003957 Byte(s)
PROGRAM SECTION:  0002f6ae Byte(s)


Phase sequence - 
At the rising zero crossing the slope is a positive maximum - Use three consecutive points to identify the zero crossing
Cover Open in Battery mode - is the count of 10 creating a problem


////-------------------------------------------------------------------------------------
18/02/2020
spent the day at GNoida and fixed several issues 
At the end of the day the pending points were :
1. Billing data corruption
2. Cover open in battery mode
3. export sign 0.2% meter must remain in export mode down to very low currents
4. battery mode display has two extra things in it - not needed
5. Phase sequence - ryb
A copy(77) is being saved before starting work
////-------------------------------------------------------------------------------------
17/02/2020
08:09 hours
In find_num_between_lp_entries the address computation now uses SURVEY_PTR_INC instead of sizeof(surveydata_t)
which is the correct thing to do 
When power failed and returned since we are storing full survey data with date and time, we should not have been
filling the in between lost hour records as done during DLMS testing
However the current code seems to be mixing up the earlier GUJARAT feature with the DLMS testing meter of Copy(60)
Needs to be fixed. ?

Hex File sent 09:55 

17:26
OBSERVATIONS
1. Accuracy is still holds on - 6%   
2. In display Mode 2 Please prefix Av. befre average PF.
3. Reactive Power  not showing in export mode at lag pf.
4. In display Mode - 1  when  showing phase wise current (export) r,y, b, icon not glowing (-ve sign ON)
5. when Meter is running In export mode showing BYPASS icon . ( probably due to change in current sign,  in previous code no such thing observed )
6. In  Inst. Profile , current and Power values should be with - ve sign when  export .
7. After C-open event Event garbage profile entries created.
8. When meter is running in Import mode , kwh export energy is recorded in load survey data  (220 fixed value)
9. PF vale is not available in load survey data
10. Increment is found in last 2 digits of KWh and kvah value in high resolution mode (when making meter On and off in export Mode.)
11. In daily load kwh OBIS of kwh export not added.

////-------------------------------------------------------------------------------------
16/02/2020
11:08
A copy(76) which is intermediate stuff has been saved before starting work
In the Load Survey of the BIDIR meter which resembles the regular one, except that one more data element has
been added kwh_consumption_export
Bug related to computing address on the basis of SURVEY_PTR_INC has been fixed. survey data is now coming correctly
////-------------------------------------------------------------------------------------
14/02/2020

Gaurav's feedback

    Cumm. MD kw import is not displayed when auto mode display scrolling automatically 	-	DONE
			( when scrolling by push button then it is available)															
    Non solar Hour kWh export counter not increasing  ( in non solar hours.)						- DONE
    When resetting MD by MD reset button “reset” massage 																-	VERIFY TIME
			holds on LCD for a long time .
    CT open/Current unbalance /Bypass  tamper not logged in Export Mode									-	PENDING
    During Voltage unbalance tamper BYPASS icon appear on LCD
    Movement in Last 2 digits for kWh and kVAh in high resolution mode still happening 	- DONE
    In display mode -2 Inst. Reactive power kVar showing 0 in export mode 							-	EXPLANATION NEEDED
			( while value. Was 6.2 kvar)
    Dnld icon is not function properly some time does not appear												- VERIFY/PENDING
    High Voltage and low voltage count not implemented ( while event is being record)
    Meter is sending inconsistence values for load survey data 													-	DONE
			(attached buffer , Meter zapped and the taken buffer)
    In daily load kwh , kWh value is ok Kvah value is showing 0													-	DONE
    When generating bill by shifting RTC billed data is displayed inconsistence.
    C-open in battery Mode
    Accuracy changed to -6.8% when communicate																					-	VERIFY
		
Over the phone Gaurav has provided the following feedback

* kvar value during export mode is the incorrect one - one side gets recorded 					- VERIFY/ EXPLANATION NEEDED
	the other doesnt, we are recording the wrong one																		
* During communication, meter goes slow by 6%, In DLMS code error 											-	VERIFY
		would return to zero; in this code it doesnt
* daily log kwh and kwh_export are correctly stored - 																	-	DONE
		however OBIS code for kwh_export needs to be added
		

////-------------------------------------------------------------------------------------
13/02/2020
07:00
Completing the display file
Code sent at 11:02 hours

Gaurav's feedback : 13:25
1. Voltage current and power (active apparent & reactive ) should be signed (- ) sign for export 
2. Auto display parameter sl. No. 17 of list . Kvarh lag exportlag icon / symbol missing
3. Billing MD kw export  for TOD zones export sign/symbol  required.
4. In display  mode 2  after the last parameter of the list															-	DONE 
		if key is pressed showing blank display . 
5. In display mode 3 for kWh & kVah  import high resolution last 2 digits are increasing while meter is in export mode. DONE 
6. In auto display mode  when resetting MD with key showing garbage value for kWh import (67895.2) night hours 
7. When changing phase sequence meter still displaying ryb 
8. Pf sign changed to C from L when exporting energy.
9. C-open display is appearing after 5 min (meter zapped several times and c-open switch is disconnected)
10. In auto display mode cumm. MD in import kw is missing from  repeated  parameters . DONE



Addition to previous mail.

    LCD Segment checks displayed on meter display for 10 seconds when meter get power on after short break.( 10-15 Mins.)
    C-open tamper is not logging when it  occurs in battery mode ( after opening cover C-open should appear immediately ) functioning properly in power on mode.
    In battery mode display Meter is displaying cumm. MD kW import ( it is not required)  kWh export to be displayed.
    In display mode II when displaying Avg. PF for last billing period   ON “Bill” icon on LCD
    When Meter cover open tamper is logging then garbage entries are created in event profile .
    Meter Accuracy drifted to -6.8 % during communications and , it is not corrected till meter power on/off
    Mode -II & III will return to auto mode after 15 mins. 
////-------------------------------------------------------------------------------------
12/02/2020
Gaurav had indicated that the BIDIR meter code was hanging at step 2, 5 and also hanging
whenever meter was being zapped from user code.
Turned out that in the do_survey_update  function the following call
	clear_structure((uint8_t*)&surveyData,sizeof(surveyData))
was using SURVEY_REC_SIZE which had been set to 32, whereas the actual size was 30
This was corrupting the stack, and causing the meter to hang.  SURVEY_REC_SIZE has been done
away with and replaced with sizeof(surveyData) and SURVEY_PTR_INC is being used to amend the
survey_ptr address

We can now begin to code the BIDIR meter in earnest

19:28 hours
Closing for the day- saving a Copy(75) for backup purposes 
 
////-------------------------------------------------------------------------------------
10/02/2020
Can we consider a modification to the code so that the maximum number of zones can be made 8 or 6.
This will reduce ram requirements as well as e2rom requirements
////-------------------------------------------------------------------------------------
02/02/2020
On 17 Jan 2020, a preliminary code was sent for Punjab.
This folder produces code of EEPL3P_USER_PUNJAB_17-Jan-2020
It is being saved as Copy(74) as we intend to produce Bidirectional meter code for Gujarat
////-------------------------------------------------------------------------------------
16/01/2020
EPR_DEVICE_SIZE in eeprom.h has been increased to 0x30000
All the three devices are working
Copy(73) represents the GUJARAT code

In the rl781c/application/display&button/lcd folder a file em_display_Gujarat.c has been included
Change this file manually when the code is to be compiled for other boards
////-------------------------------------------------------------------------------------
15/01/2020
A new meter has been received which has three E2roms
addresses are
00000 - 0ffff
10000 - 1ffff
20000 - 2ffff

A #define BANKTEST is used to write the test code to check the three memory banks

A test code is being developed to access all the three memory locations - in pravakComm.c
we want to select a page, 32 byte aligned address, and read or write a string to it
SELp					- 	select the page 0,1,2
ADDRnnnnn			-		select the address
WRnaaaaaaaaaaa	- 	WR n characters of string aaaaaaaaaa
RD							-	read from current address
////-------------------------------------------------------------------------------------
12/01/2020
A Copy(73) is being saved before making any further changes
09:33 hours
Certain changes have been made in this file which are very specific to Gujarat Board
Major elements are:
1. Display modes, display controls and key handling
2. DC Injection/ Harmonics Treatment and a few other tampers
3. Load survey
4. High resolution display handling
////-------------------------------------------------------------------------------------
05/01/2020
01:30
We are changing the intercept for correction in 0.5 and 0.25 lag cases
////-------------------------------------------------------------------------------------
04/01/2020
File of 03 Jan sent at 10:30 hours
Pending
1) To change time limits to 300 seconds and 18 hours
2) To modify power in dc injection test to use actul values of voltage and assumed 21.21 current
3) To include if possible that in Mode3 if button is actually pressed then display goes off after one round
4) To fix load survey

A Copy(72) is being saved before making any more changes

15:27 Hours
Code implemented to allow puh button wakeup for 40 seconds after 5 minutes of mode3
Cover open bug fixed
DC injection now uses actual vltage and multiplies by 21.21 
Hex file of 04 Jan 2020 sent

17:49 hours
Final code being sent 
 Bug of C-OPEN in power fail mode has been fixed
 Times have been restored to 18 hours for power fail display and five minutes for returning to autoscroll
////-------------------------------------------------------------------------------------
03/01/2020
at G noida- spent 2 hours on noida expressway
Fixed a lot of issues
////-------------------------------------------------------------------------------------
02/01/2020
////-------------------------------------------------------------------------------------
01/01/2020
The TDR03 value has been reduced from 0xEA5F to 0xE9AB to reduce the time for the timer3 interrupt
to enable a higher value of energies to be accumulated. 

Gaurav's observations

1. Switching between modes to be done with 5secs. DONE
2. Sometimes when meter getting power on from sleep mode it shows lcd segment checks for 20 secs. And does not start pulsing till then.
3. Display mode header shall be displayed only for 2 secs. Also header name shall be Mode 1,2,3 currently it is mode 0,1,2 DONE
4. When pressing up and down scroll key rapidly mode is being changed . FIXED
5. When meter is in communication mode shall display dlod or Hdlc on display also in battery mode .
6. Cover open display to be implement.
7. When resetting MD via MD reset button , display Reset for 2 seconds. DONE
8. When all 3 phases are available Display R,Y,B icon continuously. DONE
   8.1 when meter has over voltage or low  tamper start blinking respected phase icon (R ,Y,B ) DONE
 8.2 when any phase of 3 phases failed turn off respected icon (R ,Y,B )  and on MISS icon. DONE
 8.3 in auto display mode when meter shall display phase voltage turn on r , y, b icon on segment. DONE

9. Tamper persistence time as per technical specifications. DONE
10. No. Of tamper events as per per technical specification


ALL ISSUES ADDRESSED - CODE SENT
Stopping at 12:40

16:33
Gaurav informed that meter is not coming out of the COMM state - fixed
There are two rtc interrupt handlers - one of them works n mode1 and the other in mode3
the comm time function is now being called in both
******************************************************************************************************************
* The function EM_CALIB_RTCConstantInterruptCallback is only called from r_cg_rtc_user.c -> r_rtc_rpd_interrupt()*
* However in this code we do not set the r_rtc_rpd_interrupt in powermanagement mode 1													 *
* Probably this may be the reason why calibration does not work in this code																		 *
******************************************************************************************************************
Gaurav also called to say that C-OPEN message should only disable MODE-1, other modes should function
Specifically
Tampers :           
Minimum of total four hundred (400) events (occurrence and restoration) of all types of tamper with date and time
 shall be available in compartment in the meter memory on first in, first out basis. 
Compartments classified as under.
1. For voltage related event- 150 events (occurrence and restoration) - DONE 150
2. For current related event- 150 events (occurrence and restoration)	- DONE	150
3. For other remaining events- 100 events (occurrence and restoration)	- DONE	100
Moreover, minimum 25 power fail events with duration is required in BCS data. - DONE 50
At occurrence of Top Cover Open tamper, meter display shall show “Cover Open”
permanently in auto mode during power ON and OFF both conditions. No display
parameter should scroll in auto mode. However meter shall continue to record energy and
display parameter shall available in push button mode. Snap shot value for occurrence and
restoration of event should be available together in the report.

DC Injection is also done with assumed power at the last stage
Harmonics also done
////-------------------------------------------------------------------------------------
31/12/2019
Pulse on duration reduced from 30 to 25 milliseconds
KWH_INCREMENT changed from 100 to 1000 - We now save every kwh
Tamper processing performed every other second
ENERGY_PER_PULSE has been decreased a little assuming that 3906.25 is not achieved
Hex file sent at 11:28 hours

14:29
A copy(71) of this folder is being saved
We will shutdown all features of the meter except the display to see what hapens to the meter constant
////-------------------------------------------------------------------------------------
28/12/2019
10:18 am
A file had been sent at 19:19 yesterday. Error was -50%.
This has been fixed, and a few other points have also been addressed
Code being sent today at 10:20

14:56
At G Noida
Making a copy(70) before testing at site
////-------------------------------------------------------------------------------------
27/12/2019
Code on 26/12/2019 had been sent from Copy(69)

11:28
Hex file EEPL3P_USER_GUJARAT_27-Dec-2019_1128 sent

Gaurav's feedback:
1. kWh , kVarh, kVah, and kWh tod wise,  showing values with 1 decimal but  to be divided by 100. 
		i.e. meter run 0.6kWh showing 60.2 same for others. DONE. 
2. Auto mode is not scrolling automatically once push button pressed , last parameter holds for a long time. DONE 
3. Instantaneous values are not refreshing in 1 sec. DONE. 
4. RTC time is not refreshing every sec. when scrolling with button , while it is ok in auto scroll . DONE
5. When Battery mode display is on it shows last tamper icon which was on display during power ON . DONE
6. short list parameters (kWh, kVarh lag & MD ) are scrolling only between RTC time to cumulative MD in mode 1
7. Rising demand with elapsed time is not being displayed during auto scrolling.while it comes when scrolling with button. DONE
8. In push button mode L1 indication is on with cumulative MD kVA - DONE
9. In mode 3 ( High Resolution Mode)  kVarh should have Lag icon. DONE
10. During events it should display respective tamper  icon  for each event ( e.g. currently showing BYPASS during CT open, )
11. when doing any tamper , tamper icon should be available immediately, 
		currently it comes when press button ( comes with next display sequence) DONE
		
17:19
Hex file sent
In emeter3_app.c in the pf correctio for 0.5 and 0.25 lag cases, slope and intercepts had been calculated for 10Amps and above
Hex file sent does not contain the check for 10 amps and above which has been added after file had been sent		

////-------------------------------------------------------------------------------------
25/12/2019
A Copy(69) is being saved before starting work
////-------------------------------------------------------------------------------------
25/12/2019
09:42 resuming

more feedbck:
1. Battery Mode display , parameters to be displayed 18 hours - DONE
2. Display when C-open Block mode 1
3. No. of Tamper events as per Specification
4. Tamper Persistence time as per specification
5. kVarh LED Pulsing  
6. Accuracy Correction at 0.5 L , 0.25 L
7. Self diagnostic features
8. Firmware ver. on display in push button mode is 0.101 it should be 1.01 - DONE.

USER code being sent. with Harmonics and DC Injection at 15:27 hours

A user code with error sign corrected was sent at 17:30 hours

Since we can test only phase wise DC injection the harmonics present check in current
is being commented (we were checking only r-phase) and a new hex file is being sent

////-------------------------------------------------------------------------------------
24/12/2019
A Copy(68) is being saved before starting work. 

DC injection
	If CurrentHarmonics>40%, and pf < 0.85 and Voltage Harmonics < 5%(almost nil)
		and (dc level in current > some value)
			then use apparent power * Some Factor (1.05) or so to compute power
	Note : This factor will change as current changes from 5A to 10A to 20A or so		 
Harmonics
	If in phase - do nothing
	If harmonics are out of phase - increase power by 8%
	if(Vthd>0.07)&&(Ithd>0.37)&&(pf<0.93)) increase pwoer by 8%
Load Survey

Gaurav's feedback
18. Created 152 days load survey data , only  3 days entries corrupted , ( Only Date is being corrupted ,  interval is okay ) 



1. When powering on meter does not show LCD check (DONE)

2. Display H1 instead of L1 for historic data - DONE

3. kWh kVah and kVarh should be 6+1 digits - DONE

4. Rising demand is not displayed when auto scrolling. ( Not addressed ) 

5. Cumm MD is increasing after billing ( need clarification)

6. when scrolling by push button in auto mode kwh kvarh md  parameters comes randomly. ( Done )

7. instantaneous values to be refreshed in 1 sec.

8. Display “Rc” instead of “bc” for reset count - DONE
9. In auto scroll mode if push button pressed once , parameter is not scrolling for 5 min 

11. Voltage fail, current fail, Voltage unbalance etc. count increasing for both occ. as well as rest.(sent in prev. mail) ( Done  tested separately for Each phase)

12. Current bypass count not increasing (sent in prev. mail)   ( Done )

13. Total power on hrs and power fails hrs icon . (sent in prev. mail)   ( Done )

14. Parameters are scrolling after 10 sec in push button mode (sent in prev. mail)   ( Done )

15. Kvah value become -95       

16. push button mode returning back to auto mode in 5 min. irrespective pushing button. ( Not addressed )

17. TOD night not showing correct value it should be (tod1+tod6 ) while we are showing only tod 6  ( Done)


19. in auto scroll mode after LCD segment check and RTC time showing blank  display for 10-10 sec.

20. RTC time is not being refreshed in 1  sec.

21. Mode is changing when pressing Up and down key one by one for 4-5 times .

1. Current Failure count values are increasing in R phase only on display, for all 3 phases. DONE.
16. push button mode returning back to auto mode in 5 min. irrespective pushing button. ( Done , but switching in 5 min 10 sec instead of 5 min) 


////-------------------------------------------------------------------------------------
23/12/2019
Hex file sent at 12:36 hours
////-------------------------------------------------------------------------------------
20/12/2019
Gaurav's mail
    Load survey data still being inconsistent attached xls. File - HAVE ASKED GAURAV TO CHECK WITH RENESAS GUI
    In auto scroll mode when scrolling by push button not showing (kWh, kVarh Lag, Md ) one time - BEING WORKED UPON
    Total power on time in hours and total power fail time in hours icon is not appreciate - FIXED
    Mode 1 (push button mode) parameters are scrolling after 10 sec. - BEING WORKED UPON
    Current bypass count is not increasing - FIXED
    For phase voltage missing , current fail ,voltage unbalance ,count are increasing with occurrence as well as restoration. - FIXED 
////-------------------------------------------------------------------------------------
17/12/2019
08:10 hours
tod display added in autoscroll
reset count changed to billing count in autoscroll
A lot of things have been fixed - switches are kind of working fine
code has been sent to gaurav
A copy(67) is being saved to preserve the code

////-------------------------------------------------------------------------------------
17/12/2019
09:32 hours
A copy(66) has been saved before starting work
Mode-1, Mode-2 and Mode-3 should be displayed at the time of changing of mode

When load survey is being read in DLMS time of 24:00 hours creates confusion, it must be changed
to 00:00 hours of the next day - DONE.

When the day was Sunday it was shwn as N/A. We were sending days as 0 to 6, 0 being Sunday, 1 Monday etc
It has been changed to 1 to 7, with 1 being Monday, and Sunday being 7. Now Sunday is being shown. DONE.

Gujarat Zone definitions:
Start			Name		Script	Zone
00	-	06	Night		01				0
06	-	07	Rest		02				1
07	-	11	Peak		03				2
11	-	18	Offpeak	04				3
18	-	22	Peak		03				4
22	-	24	Night		01				5

Hence night data is stored in zones 0 and 5
Off peak data in zone 3
Peak Data in zones 2 and 4
Rest in zone 1
////-------------------------------------------------------------------------------------
16/12/2019
12:21 Hours
A Copy(65) has been saved before starting work

A variable g_display_update_type is being created. Its functionality is described below

Value	Function
 0		display will increment after lapsing of scroll interval
 1		Fixed - display will not change till Up or Down button is pressed
 2		Fast + scrolling - display will be updated every second
 3		Fast + fixed - display will update every second but will not change till Up/Dn button is pressed
 
 Pressing Up and Down Arrow button together will change g_display_mode
 g_display_mode
 Value	Function
 0			Autoscroll with intermediate display of values after every state
 1			On Demand display
 2			High resolution display
 3			Auoscroll with button press without display of intermediate value
 
 Combination of the two flags will cause following display
 
 g_display_mode	display_type
 			0							0					autoscroll + intermediate display every step					
			0							1					fixed display (autoscroll parameters only) with push button
			1							1					On Demand display
			

////-------------------------------------------------------------------------------------
15/12/2019
Started work in the morning
Load survey has started working but is a little buggy
*************************************************************************
*	VERY IMPORTANT																												*
*		in file r_dlms_data.c function R_OBIS_SetObjectAttr line 2714				*
*		there is a code to revent rtc to be set in the past									*
*		This code needs to be improved to allow rtc to go back a few minutes*
*		if the rtc happens to run fast																			*
*		ALSO THIS CODE MUST BE UNCOMMENTED																	*
*************************************************************************
Following had to be redefined as per Gujarat load survey model

g_Class07_BlockloadScalerBuffer in r_dlms_data.c 
g_Class07_BlockloadCaptureObjects, g_Class07_BlockloadCaptureObjects,g_Class07_BlockloadCaptureObjects_Scaler
	g_Class07_Blockload_Buf in r_dlms_data_ic.c

Function do_log_update() is NOT USED in Gujarat Board. 

A brand new function backupLogDate is written ONLY FOR GUJARAT BOARD
Data for each day is being stored in a page of 256 bytes of which 192 bytes (48*4) form the 
days data - 16 bytes after this are the current_date and 16 bytes are the backupdate
For interval of 15 minutes, data section will be 96*4 = 384 bytes + 16 (date) + 16 (backup date)
Table given for three cases

Interval	Data	Date	BackupDate	Datasize	Days	Total
	15			384			16		16				 	416			 90		37,440
	30			192			16		16					224			180		40,320
	60			 96			16		16					128			360		46,080
	
Everytime survey interval is defined, then all the data wil be lost
Fresh partioning will be done, and the values for no_of_days, SURVEY_END_ADDRESS etc will
now have to become ram variables and will need to be recomputed

We will test this with an increment size of 224

An intermediate copy(64) is being saved at 16:54 hours

16:55 hours
Puttin load survey aside and work on the display functions

	
////-------------------------------------------------------------------------------------
14/12/2019
Had started work on Gujarat Board - Meter provided by Gaurav had some communication issues
A new meter was received in the evening
Load survey was not working properly
////-------------------------------------------------------------------------------------
13/12/2019

To be able to store data for 180 days, we must store data in fixed regions depending on the time
For a day, first data is for 00:30 at index 0, next is at index 1, and the last data is for 24:00 hours at index (1440/SurveyInterval)-1
Hence we need a storage size of 48*4= 192 bytes
For each date, the logdata, which contains the date will be stored at ctldata.survey_wrt_ptr + 192
It is to be noted that the last record of the day which is for time 2400 hours must actually be timestamped at 00:00 hours of the following day
For all other records, the date in the logdata is to be used, alongwith time which is computed for the index
ctldata.log_wrt_ptr will now become redundant - alternately it may be computed as ctldata.survey_wrt_ptr + offset

It may be interesting to actually have storage area for 181 days. The present or current day's data will be filled from
offset 0 to n-1 for the n readings logged upto the last logged time.
The next record will be containing the oldest data in case of overflow 
Record numbers will vary from 1 to 8640 (180*48)
When it is required to send record no 1, since we have already stored n records for the current day,
we can start from the nth offset of the oldest day which actually represents the oldest record
Thus if we have 8 records in the current day, then 40 records of the oldest day + data for 179 days
will give us full data for 180 days - Thus there will be two pages - the newest and the oldest which
will have partial data

////-------------------------------------------------------------------------------------
13/12/2019
A copy(63) has been saved before starting work
This folder will mark the code for Gujarat specific code
Notably things that will change are:

Load Survey is different
	g_Class07_BlockLoadBuffer structure is different
	surveydata_t is different - kwh-consumption, kvah-consumption
	find_num_between_lp_entries, get_lp_data etc will need to be rewritten
	what about daily log
Handling of keys is different
Display parameters
TOD method


////-------------------------------------------------------------------------------------
12/12/2019
A copy(62) which is an intermediate version has been saved before starting for the day
High resolution energies implemented alongwith fundamental kwh
We may revert t int8_t instead of int16_t for high_resolution_k**h_value(s)

DC injection is the first thing to be done


Special things for UGVCL

1) Display sequence as per UGVCL Display parameters.pdf
2) Load survey data - 180 days
3) Harmonics
4) DC Injection
5) High resolution readings
6) Self diagnostic features - How to check

tamper persistence on/off - 5 minutes
tamper persistenc magnet/ power fail - one minute
tamper persistence cover open  - immediate

Display parameter in battery mode (on button press)
- Total KWH, KVARH (lag), MD KW of previous month - permanent
or at interval of one minute for 18 hours without push button use






////-------------------------------------------------------------------------------------
11/12/2019
A folder dated 09 Dec 19 had been created wherein four hall sensors were defined
and any one sensor being active would cause MAG icon to glow and meter to pulse at Imax
Changes of the 09-Dec-19 folder have been included here before starting work

To work on :

a) high resolution energies
b) harmonic injection - 5th harmonic (special handling to exclude other harmonics - how)
c) DC injection
d) switching off Vcc-3 in sleep mode to reduce current consumption

Need to include fundamental kwh in energy storage
since energies are stored with 3 decimals, if we could store the 4th and 5th decimal separately
as a number between 00 and 99 when the meter is running then 
	high res energy could be = low res energy * 100 + high res increment

///-------------------------------------------------------------------------------------
04/12/2019
A copy(61) has been saved.
Starting on Harmonics and Gujarat specific code
///-------------------------------------------------------------------------------------
19/11/2019
Gaurav's mail

Please find Magnet sensor Pin configuration.

    FEA_HALL_SENS1      PIN 33     P125/VL3/INTP1   (Already Implemented only display activation)
    FEA_HALL_SENS2      PIN 77     P54,SEG36             (Already Implemented only display activation)
    FEA_HALL_SENS3      PIN 06     P43/PCLBUZ0        (newly added)
    FEA_HALL_SENS4      PIN 81     P50,SEG32             (newly added)

We need to add a display which indicates which sensor is On/Off
These are the LCD character positions
1 2 3 4 5 6 7
x   x   x   x

We can send a special display sequence for testing magnets - DONE

A new hex file is being sent with only fixed display


///-------------------------------------------------------------------------------------
14/11/2019
Last night and early morning today, the password for LLS and HLS were not getting set correctly
A new meter was collected today and code was debugged.
The functions memset(secret1, 0, 9) and memset(secret1, 0, 17), as well as memcpy(secret1, p_secret, length)
and memcpy(secret2, p_secret, length) were not required as p_secret and secret[1]|[2] were the same
The bug was fixed by commenting the two lines at two places. E2rom writing was fine
This code has been released with time stamp of 1605
A copy(60) is being archived
//-------------------------------------------------------------------------------------
13/11/2019
Copy(58) contains the last code that was released before going to udaipur
Changes were made at udaipur, and Renesas sent a new dlms library on 13/11/2019
which was used to send fresh code to gaurav who is still at udaipur
Gaurav has indicated that there are 
(a) some problems with the saving of password keys (HLS & LLS)
(b) Cover open tamper is not getting recorded in power fail mode
(c) there is also a problem of number of cover tampers to be recorded 4 or 1
This folder will now be modified. It already contains the new dlms library
Hence a Copy(59) is being saved which represents the changes made at Udaipur
before starting to address issues raised by gaurav

Noticed that in power fail mode when cover tamper is done, then display seems to go from TOD 1 and TOD2 only
Even otherwise display seems to be stuck in TOD1 and TOD2 only - will verify from Copy(59)

16:43
Add a CLRCVR command and also make storage only for one cover tamper - DONE
Have also made changes to when the cover open tamper is being recorded
Cover Open Tamper is now being recorded in POWERMGMT_ProcessMode3 and POWERMGMT_ProcessMode1 (will be recorded just once)

17:56
Spoke with Gaurav just now
Things to be done:

1. Password Saving
2. Cover Open Tamper in Power Off mode - DONE
3. No of Cover Open Tampers =1 - g_Class07_Event_MaxEntries[5] has been made 1 - also EVENTS5_END_ADDRESS is for only one ENTRY - DONE
4. In Latest Tamper Restoration also to be shown - change made in wre2rom g_Class01_EventCode DONE
5. Meter Number Setting Command - DONE

//-------------------------------------------------------------------------------------
10/11/2019
Today is Audi's birthday. Fixed the green kapda on the terrace

Yesterday at close of work a copy(57) had been saved
We were working on fixing the bug in obtaining load survey data by range
For some reason data in e2rom got corrupted at index 216 This caused the search to fail

The meter data was zapped and fresh load survey data created. It was found that the algorithm
was working fine

We now need to fix the algo in two ways before going to udaipur

(1) If any load survey data date time gets corrupted - it should be ignored
(2) We must make the search faster by testing 48 records ahead

Both the points above have been implemented and are working correctly
A Copy(58) will be saved
This user code will be emailed to Gaurav and Rohit
//-------------------------------------------------------------------------------------
09/11/2019
10:30
A copy(56) had been saved at close of work yesterday
 	(1) get_tamper_data in r_dlms_data.c has been modified t account for indices on rollover
 	(2) a brute force simple algorithm for find_num_between_lp_entries has been implemented

Noted a problem with load survey - while generating survey data overflow by sending a time change
request every 10 seconds (23:59:55) and causing date to change thereby creating zero value survey records
one could fill the survey memory in around 7.5 minutes. It was found by doing this exercise twice that
data was getting corrupted at entry 847 onwards in first case and entry 849 onwards in the second case
To avoid delay - all the data was shifted to 2nd e2om by changing base address to 0x10000
while keeping survey rec size as 32 - 42 days data was found to be ok
To make the data for 45 days, survey_rec_size and surveydata_t are being made 28 

To be done today
	(1) improve the simple algorithm 
	
//-------------------------------------------------------------------------------------
08/11/2019
A copy(55) has been saved before starting work

Dear Sir

Please find observations below found during validation.

16. occurrence time for power fail event to be changed for 5 min. DONE with simple algorithm
17. current bypass logic to be changed (if ivector- i neutral > 10% of Ib ) - DONE
19. w/o battery power fail event is not being logged. IGNORE for PRESENT
20. when capturing power fail event's parameters recording -0.99 PF when UPF is given . DONE
21. in non roll over events defined profile entries are 4 , all four entries are storing same value. DONE - Only One cover open will be recorded
22. low pf event is being recorded when lead power factor is applied . FIXED - DONE
23. activity calendar is not activated w/o battery when  meter is power off and power on after execution time exceeded. FIXED. DONE. 
    calendar activation time is becomes corrupted value and bill generated  as meter power on.( execution time write to eeprom )
24. Meter RTC stops in power off condition when BT 1 is not connected , when connect BT 1 for few seconds (till reset display appears)
    in power off condition RTC start working . FEATURE
25. selective access by entry after rollover for events and billing profile when getting value 1 - 5 sending from index 0 to 4 while entry no. 1 is stored at index 6
26. IC-64 security setup is missing (IS-15959 page no. 6 clause 7.2) DONE. 
27. change mfg year default value 2018 to 2019 - DONE. 
28. C-Open ICON on LCD activated. DONE. 


//-------------------------------------------------------------------------------------
06/11/2019
A copy(54) has been saved before starting work
All inputs/switches have been converted to active low. Internal pullups are removed
Cover open switch has an exteral pullup of 470K
An additional memory (512) at address 01 which had been removed yesterday has been added
This will allow load survey of 45 days
Tamper storage will be increased too
Cover open tamper is being logged repeatedly overwriting earlier tamper at the same location
Battery current drain had become 2mA in mode3 due to active high inputs is now down to 60 to 70 microamps
In shutdown mode current is 13 microamps (should have been 2 microamps or so)- needs investigation


11:37 am
1) Shifting location of load survey to accomodate 45 days - DONE. 

//-------------------------------------------------------------------------------------
05/11/2019
In Port Stop Create AUX_OUT is being kept on
This has been restored to AUX_OUT being OFF, only only turned on when meter is not in mode4.
//-------------------------------------------------------------------------------------
01/11/2019  restarting after break

An intermediate copy(53) is being saved before making any changes today

All switches are now active high - This has been fixed in em_display.c - DONE
Cover open pullup to be removed and cover open is also to be active high

Change made in e2rom.c pageWriteE2rom and readMultiple_e2rom_internal to allow A2,A1,A0 addressing of multiple 24C512

P4.3 is now connected to Hall Sensor

KEY1 (Middle push Button is connected to P15.2)


Gaurav's mails:
//-------------------------------------------------------------------------------------
31/10/19
Dear Sir

Please find below points found during DLMS data validation.

22.   Selective access by date for load survey is not working properly
23   Avg. block load voltage (1.0.32.27.0.255, 1.0.52.27.0.255, 1.0.72.27.0.255) for R,Y,B values
 			are not correct in IC-3 it is showing 24 V instead of 240 - DONE.
24.   sometime showing -0.99 PF at UPF
25.   combined PF for all three phases is always 0.9 even when downloading in battery mode still sending 0.9 - DONE.
			What happens in battery mode - kw =0, kva = 0 etc
26.   active & apparent and reactive (lag &lead) energy in block load survey
 			IC-3 (1.0.29.0.255,1.0.5.29.0.255, 1.0.29.8.0.255, 1.0.29.9.0.255) values are not correct to be multiplied by 10 
			(i.e. showing 180 wh consumption instead of 1800 wh) same are being saved in load survey data - DONE.
27.   Profile entries in Tamper log events are showing 0 it should have no. of defined entries. - DONE
28.   Scalar profile for power factor for event logs is -2 while it is -3 in IC-3 it 
			should be -3 same to be implemented in billing profile  avg pf for billing period. DONE
			
PSPCL summary available as an excel sheet located in /RNSS3P folder

Rohit has sent three files located in E:\PRAVAK_this

23/10/19
DLMS validation observations New

    When getting daily load survey data by selective access by date getting inconsistence data  (entry starts from 7:30 AM always )
    C- Open hardware implementation tested and found ok pin no. DONE
			P151 RTCIC1 normally is high and getting low on pressing button. 
			( supply on switch Aux Vcc is coming from MCU only when MCU is active. ) 

Previous points pending

    Simultaneous operation. DONE. Channel priority set in DLMS_User.c . DONE. 
    Most recent tamper event for magnet not showing. DONE. 	
			
//-------------------------------------------------------------------------------------
19/10/2019  1203 hours at GNoida
Yesterday changes were made
Today's tasks
1) Any date before current date is not to be accepted for class 20 and class22
2) Single action bill is to be made using current time only - discussed with Gaurav
1) and 2) are done. Break for lunch

14:28 hours
A copy(52) has been saved

3) RTC date setting is not permitted if date is in the past
		In case date is today then time can be in the past			-	DONE
 
//-------------------------------------------------------------------------------------
12/10/2019  0921 hours at PRAVAK
Gaurav has had a baby daughter(04 Oct 2019). spoke to him enquiring about programmer which we could not find
ultimately found the programmer
13 BRD people had come for inspection - Wg Cdr Vijit and one WO on Thursday(9th?)

Gaurav had sent a mail on 09/Oct/2019
3 phase energy meter DLMS data Verification

    Device logical name (0.0.42.0.0.255) is EEPL3P it should be combination of Manufacturer DLMS flag id i.e EEOEPL
			What should it be? EEOEPL  - DONE
			
    Power factor has no sign it should be signed  - IC-3    UPF/LAG + lEAD -  DONE
			
    Signed reactive power 1.0.97.7.0.255 is not found in IC-3 (BOGEY)  - DONE
			(1,   0,   3,   7,   0, 255) - This is correct - In 15959 pdf this value is shown as (1,   0,   37,   7,   0, 255) 
			
    Block energy kwh 1.0.1.29.0.255 is not found in IC-3					DONE. 
    Block energy kvarh(lag) 1.0.5.29.0.255 is not found in IC-3		DONE.
    Block energy kvarh(lead) 1.0.8.29.0.255 is not found in IC-3	DONE.
    Block energy kvah 1.0.9.29.0.255 is not found in IC-3					DONE.
		
    Total power ON duration in minutes 0.0.94.91.13.255 is not found in IC-3  (for the month) - DONE
		Cumulative Tamper Count 0.0.94.91.0.255 is not found in IC-3  -  DONE
		
    When power resetting meter Both passwords HLS/LLS returns to default passwords. DONE
		Must be saved into eeprom. DONE
		
    When Changing profile capture period old data is available - DISCUSSION - NO CHANGE
		
    No parameter of block load survey found in IC-3 - ALL PARAMETERS DONE
		
    In IC-1 OBIS 1.0.0.4.2.255/1.0.0.4.3.255 (CT/PT ratio) showing value 1 & 2 - changed to 1 & 1 - DONE

    Scaler profile for Active power & Apparent power  is not correct it is 10 power -3 it should be 10 power 0  - DONE
		
    MD kw & Kva scaler profile IS not correct -	DONE

		No date earlier than meter date should be accepted - DISCUSS
			Class22	-	DONE
			Class20 - DONE
			rtc (future can be set, past cannot, present date - past time can be set) - DONE

		Most recent tamper - Class 1  96.11.0.255 	-	DONE
			In r_dlms_data_ic.c there is a variable called g_Class01_EventCode[7]
			For indices 0 to 5 we must store the latest event in the appropriate index element to reflect the latest tamper code for that block
			For eg if it is a voltage related tamper then what was the last tamper, etc. 
		
TO BE DONE
    Simultaneous operation is not working fine. Optical port has priority. 
		Optical port to have priority.
		
    Tampers logic to be incorporate as per PSPCL tender TS
		
		Magnet -	DONE  (Not getting logged in latest tampers)
		
		MD reset - DONE
		
		Neutral Disturbance 
		
		Cover Open - HARDWARE TO BE CHECKED - INTERRUPT DRIVEN - POWER SUPPLY TO BE ALWAYS AVAILABLE INTERRUPT EDGE TO BE DETERMINED ETC

     
//-------------------------------------------------------------------------------------
30/09/2019  0934 hours
The index  produced by the search method for range entries needed to be matched with 1 to 1440
by adjusting the index of the latest/oldest record.
This was the reason why whenever overflow had occured the load survey (by range dates) was working incorrectly
Modification yet to be done 
//-------------------------------------------------------------------------------------
30/09/2019	0914 hours
Changes for selective access by range had been implemented. A copy(50) existed not including the changes
File modified was r_dlms_data.c
It has been reportedd that access by range is not working correctly for 30 days load survey data
An intermediate copy 51 has been saved before starting work today after a very long gap
Last Code send was on 14/Aug/2019
Before starting any modification, the hex file produced by this folder matches that of 14 Aug 2019
//-------------------------------------------------------------------------------------
06/08/2019
A copy(49) is being saved

Two things are left to be done

1. If script id is 0 then that is to be treated as end of zone definitions and time of 00:00 is to be permitted
		including in the middle . DONE

2. selective access by range

3. integration of calibration with user code 
//-------------------------------------------------------------------------------------
02/08/2019
At GNoida
Pending issues

0 Script ID is now being recorded in the passive tods and is also transferred to active tods. DONE. 

1 Script ID is to be associated with each time zone definition - script id of 0 is to be treated as end of the zone definitions
	If user omits to provide a script id in the middle then subsequent zone definitions are to be ignore or what?
	Time entry of 00:00 hours is to be permmitted
	
2 100th entry garbage in daily log to be fixed - DONE. 

3 Meter generating pulses - DONE. total_active_power made 0 in POWERMGMT_ProcessMode4

4 Activity calendar (155) as well as SingleActionSChedule(154) to be recorded as events with codes 
  and programming count to be incremented - DONE. 
	
5 Selective Access - By range

6 Integration of Calibration wth User Code
//-------------------------------------------------------------------------------------
31/07/2019
Feedback received from Gaurav on 26/07/2019

1. TOD settings are being copied from assive to active - but it is not working
	Turns out that the first zone start time itself as 0
	We treat 0 in a zone definition that further zones are not defined
	To satisfy the user case that the first zone may contain 0, and yet other zones could be defined
	we will need to permit 00:00 hours in the first zone.
	To completely permit definition of 00:00 in other zones, and not be treated as end of zone definitions
	we will need to look at the next zone. If the next zone has a non-zero value then 0 will have to be permitted
	This may call for modifying the findzone function and associated functions in utiities.c
	
2. 100th entry of daily log is garbage
3. Meter still generating a few pulses
4. Meter accuracy at 60A is fine, but it is messed up at lower currents
	
//-------------------------------------------------------------------------------------
22/07/2019
TOD active and passive are now working fine
We need to replace their functions with ours to execute the tod changes (Class20) and md resets (Class 22)
We also need to account for the fact that the time intervals could be passed when power is not there

Things appear to be working fine - however there appears to be quite a lot of delay in billing
When a time match occurs, a acll to generate bill is made from R_OBIS_MeterDataProcessing()
This function is called every second


//-------------------------------------------------------------------------------------
21/07/2019
Upon reset, once zonedefs have been read, they should be transferred to TZ_start_time0
We can also make the zoneDefines variable as local and when required obtain the data from TZ_start_time0
We will be making some structural changes by making the zoneDefines as local variables
Better to save a Copy(46) - DONE. 

zoneDefines are now completely local and TZ_start_time0 arrays are now being used
Whenever the active one is updated, we will need to store the same in e2rom

Before that we must now account for the passive array
//-------------------------------------------------------------------------------------
20/07/2019
Activity calendar has been implemented with great difficulty. The memcpy function called
in R_OBIS_Class20_Activate_PassiveCalendar (r_dlms_data_meter.c) was creating a problem
Owing to so many pointers, it appeared that while copying the contents of passive to active
it was pointing the active pointer to the passive data location (pythonic - ironic)
A workaround by actually copying the data elements is working fine

We now need to save these values in e2rom, both active and passive so that in case of a reset
they may be restored
The switchover/activation date/time aslso needs to be saved, so that in the event of power failure
the value may be recovered, if it has been lost

Comparing of the time is a problem since the current algorithm performs the comparison every second
and if there was no power during the time, then the match will never occur - this needs to be rectified

Same things need to be done for single action (Class 22)

//-------------------------------------------------------------------------------------
18/07/2019
Gaurav has sent a mail with the following observations to be attended to:

    Software only.
        Cumulative Power fail duration becomes 0 after 1st billing done. DONE.
					In the function ComputeTotalMinutesInBillingMonth the retval was being
					returned as a negative number. After typecasting to int32_t problem was fixed
					IN ANY CASE A BETTER ALGORITHM MUST BE USED FOR CUM_POWER_FAILURE_DURN
        Daily log kWh data disturbs after 31 plus entries . DONE. 
					The CLASS07_DAILYLOAD_MAX_ENTRY had a value of 32, changed to NO_OF_DAILY_LOG_DATA. 
        Single action schedule to also  operate in battery mode . DONE
        Activity calendar. DONE
        When meter powered off and powered again with  no current meter generates few pulses. DONE. 
        Average voltage /current in load survey . DONE. 
    Bench needed
        Current unbalance tamper (redefine logic)
        ND tamper Implementation.
        35 kV LCD problem
        Accuracy after 45 A current.
//-------------------------------------------------------------------------------------
29/05/2019
Tampers have been implemented with proper interlocks
A Copy(44) is being saved
Breaking for lunch

//-------------------------------------------------------------------------------------
27/05/2019 & 28/05/2019
While working on momentary power application, and attempt to fix the problem of getting th
UART to send debugWe  messages, an important change made was the initial definition of 
g_powermgmt_current_mode and g_powermgmt_previous_mode, g_powermgmt_prev_main_mode
This fixed a few problems - the hanging of the meter in momentary power application was 
traced to the record_power_fail_event

We record the power fail with no regard to the minimum period of power fail
Changes will now be made to ignore power failures less than say a few seconds
For this a function will be created to compute the duration of the power failure
However we still need to account for the fact that what were to happen if power were to be
lost while the power fail event was being recorded

Handling of momentary power application is now successfully implemented
When the power_fail event is to be recorded, a delay of 5 seconds is implmeneted and then
the phase voltages are read. I fall of them are 0 then the registration of event is aborted

Load survey oldest entry first is implemented
Yet to be done for daily log
Making a Copy(43) and breaking for lunch
//-------------------------------------------------------------------------------------
24/05/2019
A Copy(42) is being saved before starting work
Points to be addressed:
1. Profile capture period - DONE
2. Handling of momentary power application	-	DONE
3. 35KV tamper lcd display problem
4. neutral distrubance tamper - Bypass icon - proper implementation of various tampers
5. Usage of RYB icons to display status
6. In load survey and daily log send oldest record first - Both DONE
7. Class 22 implementation - DONE
8. Class 20 implementation
//-------------------------------------------------------------------------------------
24/05/2019

M44_sectionVI_B.pdf - tamper cnoditions described - pg 28

1. Profile capture period incoorectly reported in attribute 4 of  class 7 (1.0.99..1.0.255)
2. During momentary power disruption, meter is hanging, and battery current is 7 mA
	(Meter is off, voltage is applied and removd instantaneously)
	When the meter has entered mode1, and the pwoering up process has been initated, at that time a power failure is 
	catastrophic. THE LOGIC SHOULD BE THAT DURING THE INITIATION PROCESS IF THERE A POWER FAILURE THE PRORCESS MUST BE ABORTED
	
3. In 35 KV tamper, LCD display is going off and returning after some time
4. Neutral disturbance tamper, Vr=416, Vy=416, Vb=236, Ir=Iy=Ib=0, In= Load current
	 This is to be logged as neutral disturbance, and power = actual voltage * Neutral Current
5. Bypass icon appears in battery mode?
6. Usage of RYB icons to indicate phase status

Power fail duration being reported as zero . date 24/5/2019 : 16:29 hours
In r dlms user interface - R_USER_GetEMData function, (rtc.date-1)1440 + rtc.hours*60 + rtc.minutes was returning
a negative value - The expression was force typed to int32_t and the problem has disappeared
 
//-------------------------------------------------------------------------------------
14/05/2019
In Load survey and Daily Log send the oldest record first

When dates are being jumped to end of month and allowed to rollover during a power fail period
then there are goofups in daily log, load survey and billing

Pending operations if any while power has failed must be completed on battery modebefore shutting down

Survey Daily Log and billing bug was traced to not reading rtc in POWERMGMT_ProcessMode1 before calling do_initial_things()
//-------------------------------------------------------------------------------------
13/05/2019
The end value of SURVEY_END_ADDRESS had been incorrectly computed by compiler. After forcing to int32_t
problem has been solved
Load Survey Overflow - fixed
Daily Log also fixed by same method

Now to tackle the Class 20 and 22

A copy(41) will be saved first

//-------------------------------------------------------------------------------------
09/05/2019
11:19 hours
Saving Copy(40) before starting work at GNoida

1. Billing order and rollover - ok
2. TOD Order - ok
3. Communication Problem - fixed
4. Load Survey overflow

A copy of the survey file has been saved as survey_earlier
We are changing the manner of incrementation of the ctldata.survey_wrt_ptr


//-------------------------------------------------------------------------------------
06/05/2019

1)Billing Data Order:
	The first bill  ever made had a 0-0 date
	Thirteenth bill data is missing, fourteenth, fifteenth are ok
	Order - Current Bill, Latest Bill .... Oldest Bill
	
2)TOD Order :	Starting time / Ending Time 
	Current code is behaving as if zone definitions are start time - supposed to be start time
	
3)Load Survey & Daily Log Overflow issue

4)Communication restart problem - SOLVED BY REORDERING THE FUNCTIONS BEING CALLED 
	It was noticed that when meter is in mode4, and one enters Mode3 by pressing a button, and then power
	is restored then communication works fine
	As a workaround, a pseudo Mode3 function POWERMGMT_ProcessMode3_Pseudo was written, and
	this function was first function called in POWERMGMT_ProcessMode1 before the rest of the original code
	LO AND BEHOLD - the communication now works - THIS IS NOT GOOD

5)Include additional delay in recording of Power return event	
	
6) In battery mode when button is pressed, then it remains in displayOnDemand mode for a very long time
Include scroll interval - Fixed


Record of meeting with Ravinder
Class 15 and 23 - no implementation required
Class 20 -> Activity calendar for TOD/TOU
Class 22 -> Single action schedule (used to force billing once) - also being used by some people to set bill date for subsequent months

r_dlms_obis_ic.c	- DistributeSingleActionScheduleClass
r_dlms_data_meter.c	- R_OBIS_MeterDataProcessing
r_dlms_data_ic.c	- all classes defined with values

There is a direct correspondence between Renesas GUI and code provided
Code sections are identified by class
The number of options are identified by similar case values


//-------------------------------------------------------------------------------------
05/05/2019
Various changes were made to fix power fail information, sending current bill data etc
Two problems relating to survey data rollover and meter communication failure when resuming from
power off in battery mode need to be fixed
Also we need to wait for some more time before recording power return event to ensure that 
voltage and current readings are proper - we need a global counter for this purpose 
Then we need to attend to TDS setting etc
A Copy(39) is being saved to reflect current status and before making any further changes

For comm not restarting, we need to see if PVK_Comm_Init needs to be called. 
//-------------------------------------------------------------------------------------
02/05/2019
Changes have been made in wre2rom
	if while function record_power_fail_event is called which in turn calls wre2rom
		while recording the power return condition, if emeter is not sending voltage values for all phases
		then the tamper will not be recorded
		in the function record_power_fail_event, wre2rom will be repeatedly called till job is done

This should fix the problem of voltage and current values not being recorded when power returns - Done.
(Improvement required - wait for at least one or two more seconds before registering)

Now to send current bill data
1. when there is no bill then number of entries should be 1, max entries is 13

Survey data - rollover problem at 1440 readings (30 days)

Communication not restoring when power turned off in battery mode . REQUIRES URGENT FIXING


 
//-------------------------------------------------------------------------------------
30/04/2019
At Greater Noida
A copy(38) has been saved.
A duplicate implementation of CUM_POWER_FAILURE_DURN has been commented and a common function
R_USER_GetEMData is being called to get the value. 

The computation of the available number of minutes in the billed month is being effected
by a new function ComputeTotalMinutesInBillingMonth in utilities

When meter is first programmed, then the power fail event which is a dummy event must have a date.
This has several cases - one when meter is programmed, or zapped, or reset
In all these cases the capturedRTC value is incorrect and will need to be populated properly. 
A code must be implemented so that when there is no backup battery even then power fail event must be properly recorded

Proper values of voltage and current to be recorded when power is restored. 

Current month's data to be sent with billing data - when there are no bills the number of entries must still be 1
to reflect the current month's entry - hence max entries to be 13

Current Month data in billing buffer-
Function affected get_bill_data in r_dlms_data.c
When no history is there the variables updated in computeBillingEntries must be initialised to account
for current month's data
When there is no bill , no of entries to be 1, index for data sent will be 0 - this is used to send current data
When there is one bill, no of entires to be 2, index (0) for current and 1 for L1
Where there are 12 bills, no of tnries to be 13, index(0) for current and 1 to 12 for L1 to L12

In Load survey, store average values for the interval. 


//-------------------------------------------------------------------------------------
13/03/2019
A copy(37) has been saved.
For purposes of neutral disturbance tamper, display autoscroll is being redone
Pending points as of 13/03/2019

1. neutral disturbance does not appear to be happening under balanced load conditions
2. PROD code battery mode operation
3. Meter accuracy loss at greater than 45 Amps - DUDDO - False Alarm?

3. Communication restart problem in battery mode
4. Implement by range in all profiles
5. Activity calendar (Time ZOne Setting)

6. Function of Optical port - DONE. 






//-------------------------------------------------------------------------------------
08/03/2019
PROD code must have battery function implemented. 
In battery mode, User code, when meter is switched off and then on,
then lag accuracy changes from within limits to -7%
This does not hapen when battery is disconnected, in which case, meter always
starts from reset condition.

Other faults reported:

	Read billing date shows junk - OK in GuruX
 	No of power failures always shows 10		-		FIXED. 
	rtc setting not being recorded as transaction event	- DONE. 
	
In Battery mode when power was turned on/off, then lag error was getting upset.
	Changes have been made in powermgmt.c so that when meter is restarted all those things that were
	done in startup are repeated - i.e configuration, property and calib data are reloaded and then EM started
	THIS HAS FIXED THE PROBLEM
	
When meter was running in Lag or Lead then one of the values kVAR_lag and KVAR_lead was correct while the
other was incorrect. This has been corrected by forcing the other value to 0 (old value was being displayed earlier)
	THIS HAS FIXED THE PROBLEM.  
	
	
16:35
At the close of day following are the things remaining to be done as of today:
	
1 Upon implementing meter restart function from power fail, meter accuracy is ok, but communication has stopped functioning
2 DLMS should work from Optical Port as well as Optically isolated COMM port
3 Implement by range in load survey, daily log and other profiles
4 Indexing method should assign value of 1 to correspond to oldest/newest
5 activity calendar time zone
6 verify implementation of class 1,3,4,7,8,15,20,22,23
7 When meter is crossing 45Amps or so and definitely at 60 amps, meter accuracy is going low (Requires investigation)

The following have been done
1 Transaction related events to be recorded - DONE. 
2 g_Class03_BillingDate to be updated while billing and upon reset - DONE. 
3 Power and restore tamper - current and voltage values - DONE. 
4 cum tamper count, no of power failure count, cum power fail duration - DONE. 


//-------------------------------------------------------------------------------------
06/03/2019
commondata_t has been modified to include the following new variables:
	uint32_t cumPowerFailDuration;
  uint16_t noOfPowerFailures;

	cumTamperCount is available in mytmprdata.tamperCount


A new Calibration File has been created to account for changes in the commondata structure

A new user code is being sent today. 


//-------------------------------------------------------------------------------------
02/03/2019
Copy(36) was saved yesterday at close of work.
at gnoida at 12:53 hours
following to be implemented:
1 Implement by range in load survey, daily log and other profiles
2 Indexing method should assign value of 1 to correspond to oldest/newest
3 Transaction related events to be recorded - DONE. 
4 g_Class03_BillingDate to be updated while billing and upon reset - DONE. 
5 Power and restore tamper - current and voltage values - DONE. 
6 activity calendar time zone
7 cum tamper count, no of power failure count, cum power fail duration - DONE. 
8 verify implementation of class 1,3,4,7,8,15,20,22,23
 
//-------------------------------------------------------------------------------------
01/03/2019
1. In r_dlms_data_h CLASS07_BLOCKLOAD_MAX_ENTRY has been redefined to include no of days of survey data
2. In survey.c function do_survey_update a check on lastTime.minute has been added in that if it is <30
		it should be made 0
3. Load survey kavrh lag and lead are now incrementing properly 
Most of the stuff is now functional
A Copy(36) is being saved at close of day 19:01 hours
//-------------------------------------------------------------------------------------
27/02/2019
at Greater Noida
A copy(35) has been saved before starting work.
After 12 months - history is being made and oldest value is discarded. OK.


//-------------------------------------------------------------------------------------
13/02/2019
A PROD and USER code has been sent today at around 10:00 hours
To verify working of DATE/TIME command and its upsetting of error by -66%
//-------------------------------------------------------------------------------------
11/02/2019
Day of week computation is now being performed. Verified ok in both DLMS and PRAVAK comm

Check Billing of next month
REMOVE the *100 multiplier in per_second_activity in emeter3_app.c - DONE.

Billing bug has been fixed - in the get_bill_data function
Load Survey 9 days problem has been kind of fixed - hardcoded to 30 in computeLoadSurveyEntries() in survey_c
Load survey stores 10 values - 3 Current, 3 voltages and 4 consumptions
For consumption computation, we do not have the fields for reactive_lag and reactive lead in ctldata

//-------------------------------------------------------------------------------------
07/02/2019
A copy(33) has been saved before making any changes
Meter was getting stuck in high resolution display mode - has been fixed.
High resolution energy was incorrectly computed - corrected.

Rtc setting causes -66% error -  error shift is now of the order of 0.1% which gets restored on power on
Day of week setting
Billing for subsequent months is not proper - Now it is proper
Load Survey beyond nine days
TOD is not correct
//-------------------------------------------------------------------------------------
10/01/2019
Long press option for Third Display in power on mode (mode1) - DONE
In displayOnDemand scroll interval = 100
If key is not pressed for 5 minutes display returns to autoscroll
If long key press display goes to high resolution mode.
In high res mode, if key is pressed display returns to autoscroll
In power on mode - mode1 - display reverts to autoscroll
Above points have been implemented
Now to change the addresses for 64K e2rom - 
100 days daily log
30 days load survey - for 45 days load survey we need another 24c512
//-------------------------------------------------------------------------------------
09/01/2019
Will zap the meter first and then begin recording of power tamper
Record power fail interrupt when power fail happens - actually one could simply capture the time
As of last evening:
RAMDATA SECTION:  00002854 Byte(s)
ROMDATA SECTION:  0000339f Byte(s)
PROGRAM SECTION:  00027f76 Byte(s)
RAMDATA has gone down by 8 bytes - 
We had already done away with g_rtc_timestamp0,g_rtc_timestamp2
We had created some new variables - sleepCommMode,sleepCommModeTimer
g_rtc_timestamp1 was being used, but it did not seem to capture the time correctly
Hence to record cover tamper, we were reading the rtc actually
It may now be feasible to do away with g_rtc_timestamp1 - DONE
RAMDATA SECTION:  0000284e Byte(s)
ROMDATA SECTION:  0000339f Byte(s)
PROGRAM SECTION:  00027f6f Byte(s)
RAM has gone down by 6 bytes - The struct rtc_timecapture_value_t was only 5 bytes
Seems like the compiler had used 6 bytes for even alignment

Begin with recording power fail when it actually happens - abandoned
since the meter does not go into mode4 at all for some reason
however, power failure time is now captured in capturedRTC and earlier procedure
of recording tamper when power return is adopted
one notable change is that after the power fail tamper has been recorded - the rtc
is read again to get the correct time of recovery of power (i.e power return)

RAMDATA SECTION:  00002856 Byte(s)
ROMDATA SECTION:  0000339f Byte(s)
PROGRAM SECTION:  00027f86 Byte(s)
Ram area has increased by 8 bytes owing to capturedRTC.


In battery mode (mode3), one can turn on AUX_OUT to enable operation of the switches
We should also modify all calls getting the instantaneous parameters of emeter
to ensure that 0 values are given in MODE3 - DONE.

A new function getInstantaneousParams(uint8_t param, EM_LINE line) has been made
This function gives all the instantaneous values - with the advantage that in
MODE3 (battery operation) the instantaneous values are returned as 0.0 - DONE
 
Pending points :
Fix DLMS history and other bugs
Change memory addresses as per memory ic 512 (64K)
Fix the option byte for resetting
Cover open tamper should also work when power is there
Long press of key should work for third display option when power is there

Saving a Copy(32)



//-------------------------------------------------------------------------------------
08/01/2019
Detect Long press of the input - DONE
Incorporate forward and backward scrolling - DONE

RAMDATA SECTION:  0000285c Byte(s)
ROMDATA SECTION:  0000339f Byte(s)
PROGRAM SECTION:  00027ed3 Byte(s)

A lot of bytes are being wasted in flags - turns out that one misunderstood the definition of 
powermgmt_int_flag_t - It is actually an uint16_t with all other labels defined as bits
Hence no change was observed after fixing powermgmtflags
RAMDATA SECTION:  0000285c Byte(s)
ROMDATA SECTION:  0000339d Byte(s)
PROGRAM SECTION:  00027f53 Byte(s)

Changes made by using _BV etc have been undone and rebuilt
RAMDATA SECTION:  0000285c Byte(s)
ROMDATA SECTION:  0000339f Byte(s)
PROGRAM SECTION:  00027ecb Byte(s)

We should trigger the communication mode when a byte is received. It should get turned off
after some time - This could not be implemented as somehow it wasn't working - replaced
the logic with a long key press which is working fine
Whenever communication is initiated, the timer is reset to 0 to allow communication to proceed
When the timer times out then MODE3 is exited

Get the rtc input capture stuff working
For cover open detection P151 is input and pullup is enabled (pullup was earlier not enabled)
RTCCR1 input capture is enabled, RTCCR2 input capture is NOT enabled
COVER OPEN TAMPER is working.

A copy(31) is being saved before closing for the day


//-------------------------------------------------------------------------------------
07/01/2019
While we now have a working version, we need to bring the current down
While going into shutdown mode, we are powering the e2rom

FEA_SW3 has been connected to DVDD. Thus it will get power even when supply is not there
since VBAT is diode ored with DVDD
Other switches including cover open are connected to AUX_OUT
Now AUX_OUT will be made zero and switch operation will be triggered by INTO interrupt

Done and it is working nicely
Will now start the UARTs - before that save a copy(29)

Communication is also working
For Communication to work the STOP() in the main function for MODE3 must be commented
Hence we need a variable called commMode which can be made 1 when push button is pressed
for say 5 seconds - when this variable is one then the STOP() function will be skipped
in MODE3
if the STOP() is used then communication does not work but current drawn is around 50 microamps
when communication is turned on, then current drawn is roughly 2 milliamps
saving yet another copy(30) and then stopping for the day
//-------------------------------------------------------------------------------------
06/01/2019
The #defines of KEY1 etc have been shifted to emeter3_structs.h
Display function is running on subclock
When AUX_OUT is off and MODe3 is inactive, then the current drawn is 2 to 3 microamps.
With pullups of 10K, cuurent drawn when AUX_OUT is switched on is around 6 to 10 microamps
When display comes on current draws fluctuates between 30 to 50 microamps

Memory is also working in battery mode
One has been able to run the meter in battery mode, accessing both autoscroll and
displayOneDemand routines, and meter turns off after last disp_state of auto_scroll.

A copy(28) is being saved 
//-------------------------------------------------------------------------------------
05/01/2019
verified at pravak that current is coming down to 2 microamps,
however vdd pin is running on vbat - in case battery ges down this can produce vdd interrupts
we need to shut down lvdvdd operation
also have a timer interrupt every second which will cause the watchdog to be cleared
so that in case of a runaway condition, the meter would get reset
1) to shutdown lvdvdd interrupt  
R_LVDVDD_Create,R_LVDVBAT_Create,R_LVDVRTC_Create have been commented
R_LVDVDD_Start,R_LVDVRTC_Start,R_LVDVBAT_Start have been commented
Current is of the order of 1 to 2 microamps
2) To enable RTC interrupt and let watchdog run in poweroff
Turning the one second interrupt on, did not change the current drawn too much still 1-2 microamps
Current option byte is 7E 39 E0
New option byte is 7F 39 E0 - now watchdog is enabled in sleep mode
Working fine - though after turning watchdog on current has gone up to 2-3 microamps


Now to turn the switch function on
Done - Meter is going into mode3 without switch being pressed
Current drawn is around 40 microamps
A copy(27) has been saved
//-------------------------------------------------------------------------------------
04/01/2019
Vikas had reported that after replacing the diodes used for oring the vbat supply with vdd
the current came down to 2 microamps
collected the meter from vikas today
//-------------------------------------------------------------------------------------
02/01/2019
Vbat has been diode ored with VDD - a current of 30 microamps was flowing with option byte settings of 7E 31 E0
Following changes have been made in r_cg_lvd file:
R_LVDVDD_Create
    LVDVDD = _00_VLVDVDD_LEVEL0;  /* Rising Edge 2.54 V, Falling Edge 2.47 V */
R_LVDVBAT_Create	
    LVDVBAT |= _01_VLVDVBAT_LEVEL1; /* Rising Edge 2.22 V, Falling Edge 2.16 V */ 
This has caused current to reach 4 microamps
However when supply is falling, current remains at high levels for two/three seconds or so before going down
Meter is not resetting

In the powermgmt file, the mode1_counter <1000 check will be changed to 10 - this should speed up the shutdown
It does speed up the shutdown process

A copy(26) is being saved at this point

Further changes to be made

(a) To power up the switches - Current has gone upto 11 microamps and settled at 5 after some time
(b) To power up the E2rom
		VCC3 - High, SCL - High, SDA - High, WP - High
		Current drawn is 9 microamps settling at 8,7
(c) To power up the Communication
		VCC2 (P5.7) - High, 
		IR_TXD(P5.6) - High, IR_RXD(P5.5) - Input
		UART1_TXD(P8.5) - High, UART1_RXD(P8.4) - Input

Turning VCC2 high causes current to shoot upto 70-80 microamps
Hence this will need to be turned on only when PB is pressed

(d) One final thing to be tried is to remove debug monitor
		This brings the current to 6 microamps
		
(e) We also need the rtc interrupt to come every second, the wdt to continue working in power off mode
		and the rtc interrupt be used to clear the watchdog in power off mode
		
Now we need to enter the battery mode of operation		

//-------------------------------------------------------------------------------------
24/12/2018
A separate branch from copy 26 had been started on new hardware - this has been currently abandoned
Changes have been made to the PCB and now battery is connected to DVDD always
Since DVDD will never go low assuming VBATT to be in fit and fine condition,
now power availability will need to be checked with EXLVD - 

since vdd is always there, hence when we shut down the meter we cannot indiscrimately make port pins
as output and make the port value 0 as well as switch off VCC-1,2,3,4, AUX-OUT since these supplies
are likely to be needed for battery operation
VCC_1	:	FEA_LED0, FEA_LED1
VCC_2	:	UARTs
VCC_3	:	E2ROM
VCC_4	:	Hall Sensor
AUX_OUT:	Pushbuttons

the Opamp U3 is being powered from DVDD, now removed and temporarily powered from VCC_4
We must also shutdown the LVD_VDD interrupt 

When in
(1) r_systeminit.c the function R_LVDVDD_Create() is commented
(2) startup.c the function R_LVDVDD_Start is commented
Then when power is cycled On/Off then METER IS ALWAYS RESETTING
Wonder why this is happening

On the contrary - although LVDVDD is now effectively not in use since VDD is always supplied
we will change the comparison value from _03_VLVDVDD_LEVEL3 to _01_VLVDVDD_LEVEL1
Current is at 9.5 microamps. Current has crept up to 16.7 microamps


If VDD is always supplied, then what happens to watchdog - can we turn it off in SLEEP mode

//-------------------------------------------------------------------------------------
17/12/2018
If reverse condition exists in meter then current tampers to be skipped - done. 
//-------------------------------------------------------------------------------------
13/12/2018
Sometimes when the programmer hangs, one has to erase the flash
By doing so since our calibration which is stred in e2rom but whose code is written alongwith
the flash routines causes default config to be loaded forcing recalibration
Hence loading of calibration values is being taken out


When date and time are being set, then load_survey and do_initial_things are being called
//-------------------------------------------------------------------------------------
06/12/2018

18:45 hours
Several changes have been made in the CALIB folder - now calibration data is being stored
in e2rom - To allow the same data to be used the functions for loading and if needed
saving must also be implemented in this code

A Copy(24) is being saved before making changes

Post lunch:

We have checked operation of tampers - working ok
Current tampers are messed up. To fix the current tampers, first a copy(25) is being saved

//-------------------------------------------------------------------------------------
01/12/2018
Calibration tends to get corrupted - intiating processo to store in e2rom
meter was stopping to pulse at 40 Amps - the MAX_POWER defined and compared with int32_t
was not being accepted till a forced typecast was done - now OK

//-------------------------------------------------------------------------------------
27/11/2018
A copy(23) has been saved before starting worg at GNOIDA.
Programmer not working has been fixed by setting 
	Erase Flash Rom when starting to Yes
in the property of RL78 E1(Serial)(Debug Tool)
This property automatically gets cleared after one shot.

It has been noticed that when voltage input goes below 120V , then all EM_GetVoltage functions start 
returning 0. This is serious

More serious observations:

a. When current is reversed, meter accuracy goes down by 66%


//-------------------------------------------------------------------------------------
19/11/2018
We were faced with the programmer not programming
Appeared to be fixed by first programming the prod code, then tried programming code of copy(16)
finally the programmer started programming again

whenever meter is being powered on/off i.e when power fail and recovery tamper is being recorded
then two occurence tampers (code 7) and one restoration tampers were also getting recorded - these
corresponds to over voltage tamper - when the code body of the over voltage tamper was commented, 
the restoration disappeared but two occureneces were still being recorded

we will stop recording the power fail tamper and check
even when the power fail event was not recorded, two double occurences(7) and one restoration(8) persists.

This implies that the three events are being generated by spurious activity which happens
whenever power is turned off and then turned on again

The backup battery was disconnected, and power turned off and on - in this case meter started from reset
Interestingly the double occurence(7) and restoration(8) were not recorded
Hence this is being casued by different initial condition relating to power on between rest case and wakeup from sleep case

Stopping for the day 18:56 hours
//-------------------------------------------------------------------------------------
17/11/2018
A copy(22) has been saved which reflects hex file of 12/Nov/2018

Reverse Icon is being generated from total power - this produces incorrect results when
only one line has been reversed. Further individual current reversals are to be logged
Needs to be corrected
//-------------------------------------------------------------------------------------
11/11/2018
disp autoscroll and display on demand have been implemented
one push button has been activated - all push button functions are in em_display.c
the key module has been excluded from the build
A copy(21) is being saved, as the display routines are going to be rewritten
Existing state is as follows:
RAMDATA SECTION:  00002854 Byte(s)
ROMDATA SECTION:  000033a3 Byte(s)
PROGRAM SECTION:  000279c7 Byte(s)

//-------------------------------------------------------------------------------------
08/11/2018
power fail and recover events are now being recorded correctly.
tampers remaining - magnet, cover open
events remaining - settings etc
implementation of tod setting
acceptance of key inputs and showing disply on demand and third display sequence
//-------------------------------------------------------------------------------------
01/11/2018
Will now record power fail tamper and power recovered tamper

//-------------------------------------------------------------------------------------
31/10/2018
We will be making changes after intense study to this code. A Copy(18) is being saved before doing so - DONE
R_LVD_Create has not been called at all - One wonders how reset mode, interrupt mode or interrupt & reset mode
would be working under this case at all - need to fix this

Have been able to achieve 0 microamp current in battery mode
Changes have been made in the power management functions in an attempt to simplify
A Copy(19) is being saved as reference starting point
Mode used for LVI is interrupt mode
Value of option byte 7E31E0
//-------------------------------------------------------------------------------------
25/10/2018
Changes have been made in POWERMGMT_DoBeforeStop and POWERMGMT_DoAfterStop by changing to battery power
through software. Two things have been noticed:
-when the meter is set to 2mA scale and power is switched off current decays and settles at 7-8 micro amps
- when the meter is set to 200 microamp scale, one sees oscillation of the current
- when meter kept at 20mA scale, current shoots up and then falls below 10 micro amps - meter reads 0.00

When power is reapplied - current briefly flows through battery and falls back to 0

Thus we seem to be achieving a standby current of 8 microamps.
If we go for reset option, save the meter data and then let the meter be reset - it may be more desirable
However, in such a case ram data may in all likelihood be lost
//-------------------------------------------------------------------------------------
23/10/2018
At Greater Noida
This code was put on built meter at EEPL, but it shown 0.19 amp current, while on our bare
PCB the current is coming as 30 microamps every two seconds.

Settings of the LINK OPTIONs are documented in 22/10/18 section

The Copy(17) has been compared with this code and found to be identical

1. COMM PORT added to pcb - meter zapped
Date and Time set - 23/10/18 11:05

*	Resistances put at 3 pushbuttons and cover switch - Current has gone up to 63 microamps continuous. 
*	R111,R19, R18,R112, R15,R17, R123 - Cover switch was open - 63 microamps
*	Cover switch has been closed by shorting 1 and 2 - current is still 61 micramps continuous
*	R19,R17,R112 removed, Cover switch closed - Current pulses at 30 micro amps and settles at 9-11 continuous
	Second observation of same case - current pulses at 30 microamps and settles at 12-15 microamps continuous - longer time to settle
* R19,R17,R112 added, - in the software some of these pins were not made input - DONE. 
	Current pulses at 30 microamps some six times and settles at 12-15

P1.3 was never supposed to be input - It is actually P13.7
Changes related to P1.3 being made input have been indone. Current is now pulsing at 11 microamp max

Optical port added:
Current is now pulsing at 24 microamp.



Will now address the observations


//-------------------------------------------------------------------------------------
22/10/2018
We have restored most of the power management code. A Copy(16) is being saved before making further changes
This is some kind of a working copy - but current in power off condition is still of the order of 0.3 mA
There are instances though when then current goes down to 0.02 mA - it alternates between 20 microamps and
0 microamps at roughly 1 to 2 seconds

11:47 am
Now when switching power off current drops to 0, but shoots up to 32 microamps every second
Seems like the RTC interrupt of 1 second is causing this - will attempt to fix

17:10
Meter is now consuming upto 30 microamps every other second - it is also not exactly 2 seconds
By commenting #define USE_DLMS there was no change. Also we seemed to have disabled the clock one second interrupt
Commenting the //		P3 ^=0x40; produce no change.
R_INTC0_Stop and R_INTC1_Stop - No change
When power is restored //    IICA0EN = 1U; has been commented - No change
The DI and EI statements enclosing the block of statements in POWERMGMT_DoBeforeStop produce no change 
VRTCEN = 0U;	// no luck with this too.

Very strange :
Commenting the call to this function also produced no change - it was as if this function was not working properly
and that rtc 1 second interrupt continued 
//    R_RTC_Set_ConstPeriodInterruptOff();            /* Change RTC to 1 sec interrupt and system */

A copy(17) is being saved as this has brought us to within 30 microamperes of the backup battery current
in power off mode. We need to preserve this and compare with earlier versions to kno why we were getting more current

IN THE LINK OPTIONS
Set enable/disable on-chip debug by link option - NO
Set option byte	- YES
User option byte value	- 7E7DE0
Wonder if the above settings have had any effect


//-------------------------------------------------------------------------------------
21/10/2018
It appears that we should stop DTC and ELC - this may be causing current flow in STOP mode
//-------------------------------------------------------------------------------------
19/10/2018
intp module - R_INTC0_Start and R_INTC1_Start have been commented - no external edge triggered interrupts
//-------------------------------------------------------------------------------------
17/10/2018
Have been working on all kinds of things including Battery backup function - power management
turns out that when we achieve state 4 (sleep mode) current drawn is 180 microamps
we were not switching off the Vcc3(P3.7) supply to the e2rom and Vcc2(P5.7) to the Optical port
Vcc4(P3.6) for hall sensor and Vcc1 (P0.3) to cal leds.

This does not seem to be working - The current does not go below 0.11 mA and in fact quite oftens
settles at 0.19 mA.

We will save a copy(15) and make changes to the power mnagement function
//-------------------------------------------------------------------------------------
12/10/2018
It turns out that whenever the date time is being set, the meter accuracy goes bust down by -67%
and returns to normal upon reset -
When rtcis set the one second interrupt stops coming for some time. This upsets the EM Core
Hence we should generate the 1 second interrupt from the 40 ms source
//-------------------------------------------------------------------------------------
11/10/2018
A copy(13) has been saved- when rtc is set using dlms - then meter accuracy goes haywire -67%
when meter is reset it becomes ok - needs to be fixed

//-------------------------------------------------------------------------------------
10/10/2018
1) on-chip debug function option byte is being set to 0x84. This causes data flash to be erased
when authentication of on-chip debug security ID fails - By making this 0x85, it will not erase data flash

If one second interrupt of rtc does not come, enrgy incrementation should not suffer
Hence use 40 ms interrupt to generate signal for per_second_activity

md date and time were not being shown correctly - now they do. - fixed
//-------------------------------------------------------------------------------------
09/10/2018
A Copy(12) is being saved before making any changes. We will make the code such that if USE_DLMS
has been defined it should be still possible to use the PRAVAK communication commands.
Multi protocol communication is implemented - METER and BY command added to set meter number and batch year
//-------------------------------------------------------------------------------------
07/10/2018
One had forgotten to take the charger to EEPL today and after some time, work was done on
Rohit's machine. At the day's end Rohit emailed me the folder. The earlier Source3P folder
has been saved as Copy(11) and Rohit's machines folder is the current Source3P
Resuming - 0936 hours

To add PRAVAK commands to allow meter number, bill date, meter type etc to be entered
in User code. This implies that while USE_DLMS option is selected it should still be able to
pass other non-DLMS commands and execute them

//-------------------------------------------------------------------------------------
06/10/2018
When the hex file was being downloaded using the Debugger mode through CS+ then meter was
running, but when it was downloaded using the hex programmer software it required a reset
to cause the program to run.
This problem was being caused by the presence of the on-chip debug function.
In the CC-RL Build Tool property, the OCD option byte is being set but its value
has been changed from default 0x84 to 0x04 - thus OnChipDebug has been disabled
The debug code is also not being loaded to free up the memory locations
Now hex file runs on the meter when downloaded using a hex programmer WITHOUT requiring a reset

To do the following:
A list of observations has been provided by Ashish which is being attended to.
 
//-------------------------------------------------------------------------------------
26/09/2018
The g_ChildTableClass07 has 16 entries
	// 0 - Instantaneous parameters snapshot  
	{   1,   0,   94,   91,   0, 255 },				// Field 1. Logical name (OBIS code) of the object.  
	// 1 - Instantaneous Scaler Profile  
	{   1,   0,   94,  91,   3, 255 },				// Field 1. Logical name (OBIS code) of the object.  
	// 2 - Block Load Profile  
	{   1,   0,   99,   1,   0, 255 },				// Field 1. Logical name (OBIS code) of the object.  
	// 3 - Block Load Scaler Profile  
	{   1,   0,   94,  91,   4, 255 },				// Field 1. Logical name (OBIS code) of the object.  
	// 4 - Daily Load Profile  
	{   1,   0,   99,   2,   0, 255 },				// Field 1. Logical name (OBIS code) of the object.  
	// 5 - Daily Load Scaler Profile  
	{   1,   0,   94,  91,   5, 255 },				// Field 1. Logical name (OBIS code) of the object.  
	// 6 - Billing profile  
	{   1,   0,   98,   1,   0, 255 },				// Field 1. Logical name (OBIS code) of the object.  
	// 7 - Billing Scaler Profile  
	{   1,   0,   94,  91,   6, 255 },				// Field 1. Logical name (OBIS code) of the object.  
	// 8 - Event 0 Scaler Profile  
	{   1,   0,   94,  91,   7, 255 },				// Field 1. Logical name (OBIS code) of the object.  
	// 9 - Event 0 profile-Amendment3 
	{   0,   0,   99,  98,   0, 255 },				// Field 1. Logical name (OBIS code) of the object.  
	// 10 - Event 1 profile-Amendment3 
	{   0,   0,   99,  98,   1, 255 },				// Field 1. Logical name (OBIS code) of the object.  
	// 11 - Event 2 profile-Amendment3 
	{   0,   0,   99,  98,   2, 255 },				// Field 1. Logical name (OBIS code) of the object.  
	// 12 - Event 3 profile-Amendment3 
	{   0,   0,   99,  98,   3, 255 },				// Field 1. Logical name (OBIS code) of the object.  
	// 13 - Event 4 profile-Amendment3 
	{   0,   0,   99,  98,   4, 255 },				// Field 1. Logical name (OBIS code) of the object.  
	// 14 - Event 5 profile-Amendment3 
	{   0,   0,   99,  98,   5, 255 },				// Field 1. Logical name (OBIS code) of the object.  
	// 15 - Name Plate profile  
	{   0,   0,   94,  91,   10, 255 },				// Field 1. Logical name (OBIS code) of the object.  
	
All event profiles have a common scaler.
The g_Class07_Event_EntriesInUse[6] and g_Class07_Event_MaxEntries[6] are an array.
This may permit treatment of the events in a common function.
Event indices go from 9 to 14 (9,10,11,12,13,14)	

12:02 pm
To save memory - some files / functions not required are being excluded from build
Wherever calls to these functions are being made - if found not necessary 
have been marked "commented by pravak as this feature not required"

//-------------------------------------------------------------------------------------
25/09/2018
Between copy(8) and this, attempt was made to fix calibration issue. In this version of the
code under standard pravak communication, the CAL0, CAL1 etc commands do not work. Hence a different
folder E:\PRAVAK_this\RNSS3P\Source3P_CALIB contains the files which allow calibration
We are conveniently calling hex file of the calib folder as the production code, and that of
this folder as the user code

Between copy(9) and this the pulse rate was changed from 1000 pulses/kwh to 1600
It turns out that this information is stored in type EM_CALIBRATION.commondata_t.meter_constant_total
there is also a EM_CALIBRATION.commondata_t.meter_constant_phase whose meaning is not clearly understood
at the moment
However as it turns out this mter constant value is read from the default value once and stored
in the EM. Subsequently in the code this value is not changed at all - hence in the calib folder
while the calibration is being saved this value has been forced to 1600 at present - this happens only 
in the calib folder code

We now need to look at the following things to move towards the end point
1) improve the display functionality and get all the icons to work
2) meter hangs at times when powering up - it needs to be made robust
3) rtc gets corrupted upon start up - need to investigate
4) in calib folder we need to verify that the zap program has succesfully erased
and the energy values have been written with proper checksum
5) implement tamper
6) implement VBATT operation
7) implement pushbutton and two modes of display - 
	a)displayOnDemand with FWD / BACK scrolling
	b)high resolution display
8) communication in pwoer off mode

Bugs reported:
1) when md interval is set, it does not seem to have effect and the value read is also not changed
2) when name plate data query is done for 0.0.96.1.1.255 the meter gets reset


//-------------------------------------------------------------------------------------
17/09/2018
A copy(9) is being saved before starting work. Hex files matches with DLMS and HT versions
//-------------------------------------------------------------------------------------
30/08/2018
will first work on billing
//-------------------------------------------------------------------------------------
29/08/2018
Load survey and daily log are kind of working now - seem to be behaving ok
Billing is yet to be properly done, and then tampers
A Copy(7) is being saved while stopping work for the day. 
Project has been cleaned and last hex file renamed to 1 prior to saving
//-------------------------------------------------------------------------------------
27/08/2018
Today have begun testing load_survey and daily log
Doesn't appear to be working - stopping for now

//-------------------------------------------------------------------------------------
23/08/2018
A copy(6) has been saved.
Memory addresses have been modified to uint32_t to accomodate memory more than 64K
Some ctldata write pointers are still 16 bits.
We must ensure that the 0th page of 64KB is used for basic meter data - and stuff
like load survey and log etc go to the next page

//-------------------------------------------------------------------------------------
get_lp_data, get_dlp_data and get_bill_data implemented
the corresponding update functions need to be done/redone
RAMDATA SECTION:  0000204e Byte(s)	00002014
ROMDATA SECTION:  00003301 Byte(s)	00003301
PROGRAM SECTION:  00020402 Byte(s)	0002032d

//-------------------------------------------------------------------------------------
14/08/2018
Adding functionality for daily log, and billing, to be followed by tamper profiles
functions like get_lp_data, get_dlp_data,find_num_between_lp_entries,find_num_between_dlp_entries,
get_bill_data,get_tamper_data,get_time_data etc to be implemented
//-------------------------------------------------------------------------------------
13/08/2018
Added the functionality of load survey and its connection with dlms. Not completed yet
There is also a requirement of finding the entries in use, and profile entries
We are using a different structure for storing survey data, where records for the day
are indexed from the time of the day. Each record is currently 20 bytes. This will cause
data to cross page boundaries and hence e2rom writing functions need to written appropriately.

An intermediate picture is 
RAMData		2050	
ROMData		3301	
Program		200f1	

An intermediate Copy(5) is being saved just like that - it has been a long time and progress is slow
//-------------------------------------------------------------------------------------
02/08/2018
Worked on DLMS - subsequently reverted to PRAVAK COMM and discovered that Calibration does not appear to be working
Stopping right now and going back to some old code to check calibration
//-------------------------------------------------------------------------------------
01/08/2018
A Copy(4) has been saved before starting work - rtc.day is now being read from ext_rtc
there is a problem, while setting date and time we do not set the weekday
without explicitly setting the day, it is possible that this value will not be correct
when reported through
one remembers that for some code written for rohit, during the raspberry pi days there
was a need for a routine to find the day of week knowing the date, month and year.  
//-------------------------------------------------------------------------------------
31/07/2018
was at greater noida. initiated process fof filling dlms data

//-------------------------------------------------------------------------------------
30/07/2018
to add load_survey, and dlms interface data
to add tamper code
to fix display function
//-------------------------------------------------------------------------------------
29/07/2018
A folder Source3P - Copy (2) has been saved. One was facing problems related to section overflow errors -
there was no apparent reason why it was happening, there is sufficient memory, and yet the error
was reported - some cc-rl settings were changed and now the error has disappeared

emeter3_app, memoryOps, e2rom and utilities files have been edited to incorporate metering application
md, billing, tod etc have been implemented - but do_inital_things does not seem to be working
correctly - one can now set date and time through pravakComm

we also need to add load_survey and tamper code

Having significantly trimmed the code in em_anti_tamper_plugin, em_event_plugin, and the header files
					before			after
RAMData		20d2				20ae
ROMData		32c7				32a3
Program		218ec			 1fe3b

we can now add our own functions for tamper and event processing.

After making changes in the plugin functionality, the EVENT_RegisterAll() in startup started
returning error. i.e events were not registered successfully - this caused sartup to fail and the 
code was not processing to main

the function EVENT_RegisterAll has been commented - hence we now do not expect any event to be registered
at least the meter is now coming to main and other code is functioning. 
//-------------------------------------------------------------------------------------
27/07/2018
readRTC added in main after saving copy(2)
//-------------------------------------------------------------------------------------
25/07/2018
Energy is now being saved and restored.
To add minute functions
//-------------------------------------------------------------------------------------
24/07/2018
One is plagued by write_energies not working.
A separate folder E:\PRAVAK_This\RNSS3P\Source3P has been created.
We will abandon the IIC routines and implement our own bit banging i2c functions
Our e2rom implementation appears to be working correctly
A bug was noted that per_second activity was being called even though init was not completed
A flag init_done has been introduced which is set to 1 once init is complete
We still neeed to figure out how to have uninitialized memory
//-------------------------------------------------------------------------------------
23/07/2018
In startup_c and powermgmt_c the rtc interrupt was probably being set to 1/2 second
It has been made 1 second. This could have been the likely cause for kwh being incremented two times
Will also restore the change made in R_RTC_Create in r_cg_rtc.c file - Done

//-------------------------------------------------------------------------------------
22/07/2018
We are currently working on th 2018-06-27 folder, since the Source Folder is causing the meter
to not boot at all. 
emeter3_app and memoryOps files have been included - energy accumulation etc are now being performed
in emeter3_app - what we are finding is that kwh is increasing at twice the rate, rtc interrupt appears
to be set at once a second, but for some reason, kwh is double the amount

INTRTCPRD and INTRTCRPD are both defined in iodefine.h - wonder where the problem is
continuing to work


SERVICE_ReadEMData and SERVICE_WriteEMData function body has been completely commented in service_em_data.c


//-------------------------------------------------------------------------------------
16/07/2018
This folder is being renamed Source_2018_Jul_16.
The folder SourcesShared_2018-06-27 is being copied and renamed Source.
//-------------------------------------------------------------------------------------
06/06/2018
Two changes have been made in r_dlms_data_ic.h (lines 40,41) and r_dlms_user_interface.c(line 887)
These changes must be undone.

//-------------------------------------------------------------------------------------
04/06/2018 09:17 hours
appear to have a handle on dlms, and timers.
in this code TMR00 (1 ms), TMR01 (135 microsecond) and TMR02(40 ms) interrupts have been used.
The 1 ms interrupt was being used for mlsSystemTimerCallback which is probably used by the interpreter (GUI)
for determining timeout and endo communication.. The same fellow may not be used for DLMS which follows
a similar communication protocol

UART needs to be at 9600 for DLMS - first need to test whether things work properly at 9600 or not
DLMS needs UART, 1 mstimer, 0.5 second timer and optional WDT.

OPTO ISOLATED port is working at 9600 but OPTICAL PORT is not.
We will use the ISOLATED PORT to test the DLMS 
//-------------------------------------------------------------------------------------
02/06/2018 09:26 hours

A Copy(6) has been saved.
Yesterday one was able to get the CAL n command to call the SERVICE_DoAutoCalibration function
This calibrated the meter in a time period of around 10 to 12 seconds. Calibration appeared to be
OK although error is not exactly 0 - what it's effect will be on the final total power remains to be
seen. it may be required to fine tune individual phase errors to tbe close to 0 so that total power
error can remain within limits always. The phase calibration works even when upf is applied; this is 
probably be done by making the reactive power 0. how it works is not totally understood at present;
CAL 0,1,2 will calibrate phases R,Y and B. CAL 3 will calibrate the Neutral Current amd CAL 4 will save
the data. atpresent data is being saved in flash; this can be amended. 

looking at dlms -it appears that all the get commands call functions which get the required parameters
to see how getting history data, logdata, survey data etc will work. there are also actions that can
be initiated which definitely include setting the date time (should be only an adjustment) as well as to
manually reset MD i.e. force generate a bill, also change tod settings - need to see how all of this is done
in dlms 
 
//-------------------------------------------------------------------------------------
30/05/2018
At Greater Noida - The DLMS files have been excluded from this build.
Today one will attempt to run the system and attempt Auto calibration from PRAVAK comm
Firstone needs to mess up the already calibrated meter by using the GUI.
Since in this folder the GUI part - mls files have been removed , one will use an earlier version
to first disturb the meter and then use this folder to attempt autocal
//-------------------------------------------------------------------------------------
29/05/2018
Ravindra had sent a new DLMS folder through a link which downloaded a folder called share.
It contained a project for rl78i1c. However, building it produce around 338 warnings.
One has fixed all those warnings and the DLMS files have been included in this folder.
//-------------------------------------------------------------------------------------
28/05/2018
One had messed with the DLMS code without success. Ravindra has promised to deliver the rl78i1c version
today.
Both the Optical and the Isolated ports are working with Standard PRAVAK Communication.
At a time only one of them can be used, which depends on #define OPTICAL_PORT being commented or uncommented.
At a later date, we may assign PRAVAK Comm to only the Optical port. 

We must now write the code to perform AUTO Calibration through the HyperTerminal. 
//-------------------------------------------------------------------------------------
25/05/2018
Yesterday Avijit and Ravindra alongwith Himanshu had turned up to handover the DLMS package which they did.
Unfortunately the package was for RL78I1B which is for single phase meters.
We may have to port it to RL78i1C.

To begin with one should rationalise the three UART ports which are there in the EEPL design.
These are UART0, UART3 and UART2. 
UART3 is optoisolated port which we are are operating at 4800 baud
UART2 is an Optical port with LED and PhotoTransistor
UART0 has been brought out to a 5 pin header and is likely meant for the RF modem.

We should setup the driver and wrapper layers to account for the three ports.
This is being done manually
Files affected are 
r_cg_sau_ren.c, r_cg_sau.h r_cg_sau_user.c
Now to fix the wrapper. We must use the wrapper number as 0,2 and 3
Kind of done; now to see if the standard communication works

First one will check the UART3.
This is working.

Now let us check the Optical Port - which happens to be UART2
//-------------------------------------------------------------------------------------
22/05/2018
Included wrp_user_uart in the build.

20:23 Hours - pravakComm module is working.Kera

//-------------------------------------------------------------------------------------
21/05/2018

One has shutdown renesas protocol by excluding all c files in interpreter
as well as excluding wrp_user_uart.c from build
It was also required to comment the following calls in phminit and phmstart functions
	R_CI_Init() and R_CI_Start()
Function calls in r_cg_tau_user and r_cg_sau_user were also commented.

Will now attempt to write a PRAVAK Standard CRLF terminated communication system.
//-------------------------------------------------------------------------------------
